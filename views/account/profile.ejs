<% title = 'Mon profil'; %>
<%
  const previewBannerStyle = profile.bannerUrl
    ? `background-image: url('${encodeURI(profile.bannerUrl).replace(/'/g, '%27').replace(/\(/g, '%28').replace(/\)/g, '%29')}')`
    : '';
  const previewInitialSource = (profile.displayName || profile.username || '?').trim();
  const previewInitial = previewInitialSource
    ? previewInitialSource.charAt(0).toUpperCase()
    : '?';
%>
<section class="card profile-settings">
  <header class="profile-settings__header">
    <div class="profile-preview">
      <div
        class="profile-preview__banner"
        style="<%= previewBannerStyle %>"
      ></div>
      <div class="profile-preview__avatar-wrapper">
        <div class="profile-preview__avatar">
          <% if (profile.avatarUrl) { %>
            <img src="<%= profile.avatarUrl %>" alt="Avatar actuel" loading="lazy" />
          <% } else { %>
            <span aria-hidden="true"><%= previewInitial %></span>
          <% } %>
          <span class="sr-only">Avatar de <%= profile.displayName || profile.username %></span>
        </div>
      </div>
    </div>
    <div class="profile-settings__intro">
      <h1 class="mt-0">G√©rer mon profil</h1>
      <p class="text-muted">
        Personnalisez votre identit√© publique avec un avatar, une banni√®re et une biographie.
      </p>
      <p>
        <a class="btn secondary" href="/members/<%= encodeURIComponent(profile.username) %>">Voir le profil public</a>
      </p>
    </div>
  </header>

  <% if (errors && errors.length) { %>
    <div class="alert error">
      <ul>
        <% errors.forEach(function (error) { %>
          <li><%= error %></li>
        <% }) %>
      </ul>
    </div>
  <% } %>

  <form
    class="profile-form"
    method="post"
    action="/account/profile"
    enctype="multipart/form-data"
  >
    <%- include('../partials/csrf_field') %>
    <div class="form-grid">
      <div class="field">
        <label for="profile-username">Identifiant <span class="text-required">*</span></label>
        <input
          id="profile-username"
          type="text"
          name="username"
          value="<%= profile.username %>"
          maxlength="32"
          required
        />
        <p class="field-hint">Modifiez votre nom d'utilisateur. Les identifiants sont uniques.</p>
      </div>

      <div class="field">
        <label for="profile-display-name">Nom affich√©</label>
        <input
          id="profile-display-name"
          type="text"
          name="displayName"
          value="<%= profile.displayName %>"
          maxlength="80"
          placeholder="Facultatif"
        />
        <p class="field-hint">Ce nom est montr√© sur vos commentaires et contributions.</p>
      </div>

      <div class="field">
        <label for="profile-avatar">Avatar</label>
        <input
          id="profile-avatar"
          type="url"
          name="avatarUrl"
          value="<%= profile.avatarUrl %>"
          placeholder="https://exemple.com/avatar.png"
        />
        <p class="field-hint">
          Utilisez une URL HTTPS ou un chemin commen√ßant par ¬´&nbsp;/&nbsp;¬ª. Laissez vide pour supprimer.
        </p>
        <label class="sr-only" for="profile-avatar-upload">T√©l√©verser un avatar</label>
        <input
          id="profile-avatar-upload"
          type="file"
          name="avatarFile"
          accept="image/png,image/jpeg,image/webp,image/gif"
        />
        <p class="field-hint">Images jusqu'√† 5&nbsp;Mo. Les formats JPG, PNG, GIF et WebP sont accept√©s.</p>
        <p class="field-hint">
          <label>
            <input type="checkbox" name="removeAvatar" value="1" />
            Supprimer l'avatar actuel
          </label>
        </p>
      </div>

      <div class="field">
        <label for="profile-banner">Banni√®re</label>
        <input
          id="profile-banner"
          type="url"
          name="bannerUrl"
          value="<%= profile.bannerUrl %>"
          placeholder="https://exemple.com/banner.jpg"
        />
        <p class="field-hint">
          Image affich√©e en en-t√™te du profil public. Laissez vide pour utiliser l'arri√®re-plan par d√©faut.
        </p>
        <label class="sr-only" for="profile-banner-upload">T√©l√©verser une banni√®re</label>
        <input
          id="profile-banner-upload"
          type="file"
          name="bannerFile"
          accept="image/png,image/jpeg,image/webp,image/gif"
        />
        <p class="field-hint">Images jusqu'√† 5&nbsp;Mo. Les formats JPG, PNG, GIF et WebP sont accept√©s.</p>
        <p class="field-hint">
          <label>
            <input type="checkbox" name="removeBanner" value="1" />
            Supprimer la banni√®re actuelle
          </label>
        </p>
      </div>
    </div>

    <fieldset class="profile-options">
      <legend>Options d'affichage</legend>
      <div class="field">
        <label>
          <input
            type="checkbox"
            name="showBio"
            value="1"
            <%= profile.showBio ? 'checked' : '' %>
          />
          Afficher ma biographie
        </label>
        <p class="field-hint">D√©cochez cette option pour masquer votre texte de pr√©sentation sur la page publique.</p>
      </div>
      <div class="field">
        <label>
          <input
            type="checkbox"
            name="showStats"
            value="1"
            <%= profile.showStats ? 'checked' : '' %>
          />
          Afficher mes statistiques
        </label>
        <p class="field-hint">Inclut le nombre total de pages publi√©es sur votre profil public.</p>
      </div>
      <div class="field">
        <label>
          <input
            type="checkbox"
            name="showBadges"
            value="1"
            <%= profile.showBadges ? 'checked' : '' %>
          />
          Afficher mes badges publics
        </label>
        <p class="field-hint">Masquez cette section si vous souhaitez conserver vos distinctions priv√©es.</p>
      </div>
      <div class="field">
        <label>
          <input
            type="checkbox"
            name="showRecentPages"
            value="1"
            <%= profile.showRecentPages ? 'checked' : '' %>
          />
          Afficher mes publications r√©centes
        </label>
        <p class="field-hint">D√©sactivez cette option pour masquer la liste des derni√®res pages que vous avez publi√©es.</p>
      </div>
      <div class="field">
        <label>
          <input
            type="checkbox"
            name="showIpProfiles"
            value="1"
            <%= profile.showIpProfiles ? 'checked' : '' %>
          />
          Afficher les profils IP associ√©s
        </label>
        <p class="field-hint">Les profils IP permettent aux administrateurs d'enqu√™ter sur les abus. Activez cette option seulement si vous souhaitez rendre ce lien visible publiquement.</p>
      </div>
    </fieldset>

    <div class="field">
      <label for="profile-bio">Biographie</label>
      <textarea
        id="profile-bio"
        name="bio"
        rows="4"
        maxlength="500"
        placeholder="Pr√©sentez-vous en quelques phrases."
      ><%= profile.bio %></textarea>
      <p class="field-hint">500 caract√®res maximum.</p>
    </div>

    <div class="form-actions">
      <button class="btn primary" type="submit" data-icon="üíæ">Enregistrer les modifications</button>
    </div>
  </form>
</section>

<section class="card mt-md">
  <h2>Profils IP associ√©s</h2>
  <p class="text-muted">
    Les profils IP regroupent vos activit√©s effectu√©es sans compte. Vous pouvez les dissocier ici.
  </p>
  <% if (Array.isArray(linkedIpProfiles) && linkedIpProfiles.length) { %>
    <ul>
      <% linkedIpProfiles.forEach(function (ipProfile) { %>
        <li class="flex flex-wrap gap-sm items-center">
          <code>#<%= ipProfile.shortHash || '?' %></code>
          <a class="btn secondary" href="/profiles/ip/<%= encodeURIComponent(ipProfile.hash) %>">
            Consulter le profil IP
          </a>
          <% if (ipProfile.claimedAt) { %>
            <span class="text-muted">
              Associ√© le <%= new Date(ipProfile.claimedAt).toLocaleString('fr-FR') %>
            </span>
          <% } %>
          <form
            method="post"
            action="/account/profile/ip-profiles/<%= encodeURIComponent(ipProfile.hash) %>/unlink"
            onsubmit="return confirm('Retirer le lien avec ce profil IP&nbsp;?');"
          >
            <%- include('../partials/csrf_field') %>
            <button class="btn danger" data-icon="üóëÔ∏è" type="submit">Dissocier</button>
          </form>
        </li>
      <% }) %>
    </ul>
  <% } else { %>
    <p class="text-muted">Aucun profil IP n'est actuellement associ√© √† votre compte.</p>
  <% } %>
  <% if (currentIpHash) { %>
    <p class="mt-sm">
      Pour lier votre adresse IP actuelle, visitez la page
      <a href="/profiles/ip/<%= currentIpHash %>">/profiles/ip/<%= currentIpHash %></a>
      depuis cette connexion.
    </p>
  <% } else { %>
    <p class="mt-sm text-muted">Nous n'avons pas pu d√©tecter votre adresse IP actuelle.</p>
  <% } %>
</section>

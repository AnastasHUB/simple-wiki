<% title = `Historique · ${page.title}`; %>
<% const permissionFlags = permissions && typeof permissions === 'object' ? permissions : {}; %>
<% const canRevertHistory = !!permissionFlags.can_revert_page_history; %>
<div class="card">
  <h1>Historique de « <%= page.title %> »</h1>
  <p>Slug : <code><%= page.slug_id %></code></p>
  <p><strong><%= total %></strong> révision<%= total > 1 ? 's' : '' %> enregistrée<%= total > 1 ? 's' : '' %>.</p>
</div>

<div class="card">
  <% if (!revisions.length) { %>
    <p>Aucune révision enregistrée pour cette page.</p>
  <% } else { %>
    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>Titre</th>
          <th>Auteur</th>
          <th>Créée le</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% revisions.forEach((rev) => { %>
          <% const revAuthorColor = rev.authorRole && rev.authorRole.color ? rev.authorRole.color : null; %>
          <% const revAuthorClasses = ['user-handle', 'history-author']; %>
          <% const revAuthorStyle = revAuthorColor && revAuthorColor.hasColor ? revAuthorColor.style : ''; %>
          <% if (revAuthorColor && revAuthorColor.hasColor) { revAuthorClasses.push('role-colored-text'); revAuthorClasses.push(revAuthorColor.className); } %>
          <tr>
            <td><%= rev.revision %></td>
            <td><%= rev.title %></td>
            <td>
              <strong class="<%= revAuthorClasses.join(' ') %>" style="<%= revAuthorStyle %>">
                <%= rev.author || 'Inconnu' %>
              </strong>
            </td>
            <td><%= rev.created_at %></td>
            <td>
              <div class="table-actions">
                <a class="btn" data-icon="📝" href="/wiki/<%= page.slug_id %>/revisions/<%= rev.revision %>">Consulter</a>
                <% if (canRevertHistory) { %>
                  <form
                    method="post"
                    action="/admin/pages/<%= page.slug_id %>/revisions/<%= rev.revision %>/revert"
                    onsubmit="return confirm('Restaurer la page à cette révision ?');"
                  >
                    <%- include('partials/csrf_field') %>
                    <button class="btn danger" data-icon="⏪" type="submit">Restaurer</button>
                  </form>
                <% } %>
              </div>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
    <%- include('admin/paginationControls', { pagination }) %>
  <% } %>
</div>

<div class="card">
  <a class="btn" data-icon="↩️" href="/wiki/<%= page.slug_id %>">Retour à la page</a>
</div>

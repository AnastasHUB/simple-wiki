<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>
    <%= typeof title !== 'undefined' ? title + ' · ' : '' %><%= typeof wikiName !== 'undefined' ? wikiName : 'Wiki' %>
  </title>
  <link rel="stylesheet" href="/public/style.css" />
  <link rel="stylesheet" href="https://cdn.quilljs.com/1.3.7/quill.snow.css" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"
  />
</head>
<body>
<% const currentUser = typeof user !== 'undefined' && user ? user : null; %>
<% const hasBrandLogo = typeof logoUrl !== 'undefined' && logoUrl; %>
<header class="topbar">
  <div class="topbar-left">
    <button class="btn icon only" id="sidebarToggle" aria-label="Ouvrir le menu">☰</button>
    <a class="brand-link" href="/">
      <% if (hasBrandLogo) { %>
        <img src="<%= logoUrl %>" alt="Logo de <%= typeof wikiName !== 'undefined' ? wikiName : 'Wiki' %>">
      <% } %>
      <span class="brand-name"><%= typeof wikiName !== 'undefined' ? wikiName : 'Wiki' %></span>
    </a>
  </div>
  <form method="get" action="/search" class="searchbar" role="search">
    <input type="text" name="q" placeholder="Rechercher…" aria-label="Rechercher sur le wiki">
    <button class="btn search" data-icon="🔍" type="submit">Rechercher</button>
  </form>
  <div class="auth">
    <% if (currentUser) { %>
      <div class="who">Connecté : <strong><%= currentUser.display_name || currentUser.username %></strong></div>
      <form action="/logout" method="post"><button class="btn" data-icon="🔓">Déconnexion</button></form>
    <% } else { %>
      <a class="btn" data-icon="🔐" href="/login">Connexion</a>
    <% } %>
  </div>
</header>

<div class="shell">
  <!-- Sidebar AVANT overlay -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <% if (hasBrandLogo) { %><img src="<%= logoUrl %>" alt="Logo de <%= typeof wikiName !== 'undefined' ? wikiName : 'Wiki' %>"><% } %>
      <div class="brand-name"><%= typeof wikiName !== 'undefined' ? wikiName : 'Wiki' %></div>
    </div>
    <nav class="vnav" id="vnav">
      <a href="/">🏠 Accueil</a>
      <a href="/rss.xml">📰 Flux RSS</a>
      <a href="/changelog">🛠️ Changelog</a>
      <% if (typeof canViewIpProfile !== 'undefined' && canViewIpProfile) { %>
        <a href="/profiles/ip/me">🪪 Mon profil IP</a>
      <% } %>
      <% if (!currentUser || !currentUser.is_admin) { %>
        <a href="/new">✍️ Contribuer</a>
      <% } %>
      <% if (currentUser && currentUser.is_admin) { %>
        <% const adminCounts = typeof adminActionCounts !== 'undefined' ? adminActionCounts : {}; %>
        <a href="/new">➕ Nouvelle page</a>
        <a href="/admin/submissions" class="nav-link nav-link--with-badge">
          <span>📝 Contributions</span>
          <% if (adminCounts.pendingSubmissions) { %>
            <span class="nav-badge" aria-label="Propositions à examiner"><%= adminCounts.pendingSubmissions %></span>
          <% } %>
        </a>
        <a href="/admin/pages">📄 Articles</a>
        <a href="/admin/stats">📈 Statistiques</a>
        <a href="/admin/users">👤 Utilisateurs</a>
        <a href="/admin/comments" class="nav-link nav-link--with-badge">
          <span>💬 Commentaires</span>
          <% if (adminCounts.pendingComments) { %>
            <span class="nav-badge" aria-label="Commentaires en attente"><%= adminCounts.pendingComments %></span>
          <% } %>
        </a>
        <a href="/admin/likes">❤️ Likes</a>
        <a href="/admin/ip-bans">🚫 Blocages IP</a>
        <a href="/admin/ip-reputation" class="nav-link nav-link--with-badge">
          <span>🛡️ Surveillance IP</span>
          <% if (adminCounts.suspiciousIps) { %>
            <span class="nav-badge" aria-label="IP suspectes"><%= adminCounts.suspiciousIps %></span>
          <% } %>
        </a>
        <a href="/admin/ip-profiles">🧾 Profils IP</a>
        <a href="/admin/ban-appeals" class="nav-link nav-link--with-badge">
          <span>📬 Demandes de déban</span>
          <% if (adminCounts.pendingBanAppeals) { %>
            <span class="nav-badge" aria-label="Demandes de déban en attente"><%= adminCounts.pendingBanAppeals %></span>
          <% } %>
        </a>
        <a href="/admin/events">📜 Événements</a>
        <a href="/admin/uploads">🖼️ Images</a>
        <a href="/admin/settings">⚙️ Paramètres</a>
      <% } %>
    </nav>
  </aside>

  <!-- Overlay APRES sidebar, avec zone cliquable à droite uniquement -->
  <div class="drawer-overlay" id="drawerOverlay">
    <div class="overlay-hit" id="overlayHit"></div>
  </div>

  <% const initialNotifications = typeof notifications !== 'undefined' ? notifications : []; %>
  <div class="notification-layer" id="notificationLayer"></div>
  <main class="content"><%- body %></main>
</div>

<footer class="site-footer"><small><%- typeof footerText !== 'undefined' ? footerText : '' %></small></footer>

<script type="application/json" id="initial-notifications"><%- JSON.stringify(initialNotifications).replace(/</g, '\\u003c') %></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script defer src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script defer src="/public/app.js"></script>
</body>
</html>

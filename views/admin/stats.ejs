<% title = t('admin.stats.title'); %>
<%
  const locale = (lang === 'en') ? 'en-US' : 'fr-FR';
  const numberFormatter = new Intl.NumberFormat(locale);
  const decimalFormatter = new Intl.NumberFormat(locale, {
    minimumFractionDigits: 0,
    maximumFractionDigits: 1,
  });
  const formatNumber = (value) => {
    const numeric = Number(value);
    if (!Number.isFinite(numeric)) {
      return '0';
    }
    return numberFormatter.format(Math.round(numeric));
  };
  const formatBytes = (value) => {
    const numeric = Number(value);
    if (!Number.isFinite(numeric) || numeric <= 0) {
      return lang === 'en' ? '0 B' : '0 o';
    }
    const units = lang === 'en' ? ['B','KB','MB','GB','TB','PB'] : ['o','Ko','Mo','Go','To','Po'];
    let unitIndex = 0;
    let size = numeric;
    while (size >= 1024 && unitIndex < units.length - 1) {
      size /= 1024;
      unitIndex += 1;
    }
    const formatted =
      size >= 10
        ? numberFormatter.format(Math.round(size))
        : decimalFormatter.format(size);
    return `${formatted} ${units[unitIndex]}`;
  };
  const formatPercentage = (value) => {
    const numeric = Number(value);
    if (!Number.isFinite(numeric) || numeric <= 0) {
      return '0';
    }
    return decimalFormatter.format(numeric);
  };
  const storage = storageStats || {
    databaseFileSize: 0,
    databaseAllocatedBytes: 0,
    databaseUsedBytes: 0,
    databaseFreeBytes: 0,
    breakdown: [],
    totalTrackedBytes: 0,
    percentageBaseBytes: 0,
    tableDetails: [],
    tableDetailsError: null,
  };
%>
<section class="card stats-hero">
  <div>
    <h1 class="mt-0"><%= t('admin.stats.hero.title') %></h1>
    <p class="text-muted"><%= t('admin.stats.hero.subtitle') %></p>
  </div>
  <div class="stats-hero-metrics">
    <div>
      <span class="stats-hero-label"><%= t('admin.stats.hero.labels.totalViews') %></span>
      <strong><%= totalViews %></strong>
    </div>
    <div>
      <span class="stats-hero-label"><%= t('admin.stats.hero.labels.avgPerPage') %></span>
      <strong><%= avgViewsPerPage %></strong>
    </div>
    <div>
      <span class="stats-hero-label"><%= t('admin.stats.hero.labels.uniqueVisitors') %></span>
      <strong><%= totalsBreakdown.uniqueIps %></strong>
    </div>
  </div>
</section>

<section class="stats-overview-grid">
  <div class="card">
    <h2><%= t('admin.stats.overview.title') %></h2>
    <ul class="stat-grid">
      <li>
        <span class="label"><%= t('admin.stats.overview.labels.totalViews') %></span>
        <strong><%= totalViews %></strong>
      </li>
      <li>
        <span class="label"><%= t('admin.stats.overview.labels.likes') %></span>
        <strong><%= totalsBreakdown.likes %></strong>
      </li>
      <li>
        <span class="label"><%= t('admin.stats.overview.labels.comments') %></span>
        <strong><%= totalsBreakdown.comments %></strong>
      </li>
      <li>
        <span class="label"><%= t('admin.stats.overview.labels.activeBans') %></span>
        <strong><%= totalsBreakdown.activeBans %></strong>
      </li>
      <li>
        <span class="label"><%= t('admin.stats.overview.labels.events') %></span>
        <strong><%= totalsBreakdown.events %></strong>
      </li>
      <li>
        <span class="label"><%= t('admin.stats.overview.labels.uniqueIps') %></span>
        <strong><%= totalsBreakdown.uniqueIps %></strong>
      </li>
    </ul>
    <% if (totalsBreakdown.commentByStatus && totalsBreakdown.commentByStatus.length) { %>
      <h3><%= t('admin.stats.overview.comments.title') %></h3>
      <div class="table-wrap">
        <table class="data-table compact">
          <thead>
            <tr>
              <th><%= t('admin.stats.overview.comments.headers.status') %></th>
              <th><%= t('admin.stats.overview.comments.headers.total') %></th>
            </tr>
          </thead>
          <tbody>
            <% totalsBreakdown.commentByStatus.forEach(row => { %>
              <tr>
                <td><%= row.status %></td>
                <td><%= row.count %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
    <p class="note-text"><%= t('admin.stats.overview.note') %></p>
  </div>
  <div class="card stats-highlight-card">
    <h2><%= t('admin.stats.highlights.title') %></h2>
    <% if (!engagementHighlights.length) { %>
      <p><%= t('admin.stats.highlights.empty') %></p>
    <% } else { %>
      <ul class="stats-highlight-grid">
        <% engagementHighlights.forEach(item => { %>
          <li>
            <span class="highlight-icon" aria-hidden="true"><%= item.icon %></span>
            <div>
              <span class="highlight-label"><%= item.label %></span>
              <strong><%= item.value %></strong>
              <% if (item.secondary) { %>
                <span class="highlight-secondary"><%= item.secondary %></span>
              <% } %>
            </div>
          </li>
        <% }) %>
      </ul>
    <% } %>
  </div>
</section>

<section class="card stats-storage-card">
  <div class="stats-storage-header">
    <div>
      <h2 class="mt-0"><%= t('admin.stats.storage.title') %></h2>
      <p class="text-muted text-sm"><%= t('admin.stats.storage.description') %></p>
    </div>
  </div>
  <div class="stats-storage-metrics">
    <div class="storage-metric">
      <span class="label"><%= t('admin.stats.storage.metrics.fileSize') %></span>
      <strong><%= formatBytes(storage.databaseFileSize) %></strong>
      <small><%= t('admin.stats.storage.metrics.fileSizeHelp') %></small>
    </div>
    <div class="storage-metric">
      <span class="label"><%= t('admin.stats.storage.metrics.usedPages') %></span>
      <strong><%= formatBytes(storage.databaseUsedBytes) %></strong>
      <small><%= t('admin.stats.storage.metrics.usedHelp') %></small>
    </div>
    <div class="storage-metric">
      <span class="label"><%= t('admin.stats.storage.metrics.freeSpace') %></span>
      <strong><%= formatBytes(storage.databaseFreeBytes) %></strong>
      <small><%= t('admin.stats.storage.metrics.freeHelp') %></small>
    </div>
    <div class="storage-metric">
      <span class="label"><%= t('admin.stats.storage.metrics.tracked') %></span>
      <strong><%= formatBytes(storage.totalTrackedBytes) %></strong>
      <small><%= t('admin.stats.storage.metrics.trackedHelp') %></small>
    </div>
  </div>
  <% if (storage.breakdown && storage.breakdown.length) { %>
    <h3><%= t('admin.stats.storage.breakdown.title') %></h3>
    <ul class="storage-breakdown-list">
      <% storage.breakdown.forEach((entry) => { %>
        <li>
          <div>
            <span class="label"><%= entry.label %></span>
            <% if (Number.isFinite(entry.rows)) { %>
              <span class="sub"><%= t('admin.stats.storage.breakdown.entries', { n: formatNumber(entry.rows) }) %></span>
            <% } else { %>
              <span class="sub text-muted"><%= t('admin.stats.storage.breakdown.entriesUnknown') %></span>
            <% } %>
          </div>
          <div class="storage-breakdown-size">
            <strong><%= formatBytes(entry.bytes) %></strong>
            <% if (entry.bytesSource === 'estimate') { %>
              <span class="storage-chip" title="<%= t('admin.stats.storage.breakdown.estimateTitle') %>">est.</span>
            <% } else if (entry.bytesSource === 'derived') { %>
              <span class="storage-chip" title="<%= t('admin.stats.storage.breakdown.otherTitle') %>">reste</span>
            <% } %>
            <% if (entry.percentage > 0) { %>
              <span class="text-muted storage-percentage"><%= formatPercentage(entry.percentage) %>%</span>
            <% } %>
          </div>
        </li>
      <% }) %>
    </ul>
    <p class="note-text">
      <%- t('admin.stats.storage.breakdown.percentageNote', { base: formatBytes(storage.percentageBaseBytes || storage.totalTrackedBytes) }) %>
    </p>
  <% } else { %>
    <p class="text-muted"><%= t('admin.stats.storage.noData') %></p>
  <% } %>
  <% if (storage.tableDetailsError) { %>
    <p class="note-text text-danger"><%= t('admin.stats.storage.tableError') %> <%= storage.tableDetailsError %></p>
  <% } %>
  <% const storageTables = Array.isArray(storage.tableDetails) ? storage.tableDetails.slice(0, 12) : []; %>
  <% if (storageTables.length) { %>
    <h3><%= t('admin.stats.storage.tables.title') %></h3>
    <div class="table-wrap">
      <table class="data-table compact">
        <thead>
          <tr>
            <th><%= t('admin.stats.storage.tables.headers.table') %></th>
            <th><%= t('admin.stats.storage.tables.headers.total') %></th>
            <th><%= t('admin.stats.storage.tables.headers.payload') %></th>
            <th><%= t('admin.stats.storage.tables.headers.free') %></th>
            <th><%= t('admin.stats.storage.tables.headers.pages') %></th>
            <th><%= t('admin.stats.storage.tables.headers.rowsEst') %></th>
          </tr>
        </thead>
        <tbody>
          <% storageTables.forEach((row) => { %>
            <tr>
              <td><code><%= row.name %></code></td>
              <td><%= formatBytes(row.sizeBytes) %></td>
              <td><%= formatBytes(row.payloadBytes) %></td>
              <td><%= formatBytes(row.unusedBytes) %></td>
              <td><%= formatNumber(row.pageCount) %></td>
              <td><%= row.rowEstimate ? formatNumber(row.rowEstimate) : '—' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <p class="text-muted text-sm"><%= t('admin.stats.storage.tables.note') %></p>
  <% } %>
</section>

<%
  const liveWindowMinutes = Math.max(
    1,
    Math.round((liveVisitorsWindowSeconds || 0) / 60),
  );
  const liveWindowValue = (liveVisitorsWindowSeconds || 0) >= 60
    ? t('admin.stats.live.minutes', { n: liveWindowMinutes })
    : t('admin.stats.live.seconds', { n: (liveVisitorsWindowSeconds || 0) });
%>
<section
  class="card stats-live-card"
  data-live-stats-card
  data-endpoint="/admin/stats/live"
  data-live-page="<%= liveVisitorsPagination?.page || 1 %>"
  data-live-per-page="<%= liveVisitorsPagination?.perPage || 5 %>"
  data-live-total-pages="<%= liveVisitorsPagination?.totalPages || 1 %>"
  data-live-total-items="<%= liveVisitorsPagination?.totalItems || 0 %>"
  data-page-param="livePage"
  data-per-page-param="livePerPage"
  data-live-window-seconds="<%= liveVisitorsWindowSeconds %>"
>
  <div class="card-header live-stats-header">
    <div>
      <h2 class="mt-0"><%= t('admin.stats.live.title') %></h2>
      <p class="text-muted text-sm" data-live-window-label>
        <%= t('admin.stats.live.window', { window: liveWindowValue }) %>
      </p>
      <p class="text-muted text-sm" data-live-status><%= t('admin.stats.live.lastUpdate') %> --</p>
    </div>
    <div class="live-stats-refresh">
      <label for="liveStatsInterval"><%= t('admin.stats.live.refreshEvery') %></label>
      <select id="liveStatsInterval" data-live-refresh>
        <option value="1000"><%= t('admin.stats.live.seconds', { n: 1 }) %></option>
        <option value="5000" selected><%= t('admin.stats.live.seconds', { n: 5 }) %></option>
        <option value="10000"><%= t('admin.stats.live.seconds', { n: 10 }) %></option>
        <option value="30000"><%= t('admin.stats.live.seconds', { n: 30 }) %></option>
        <option value="60000"><%= t('admin.stats.live.minutes', { n: 1 }) %></option>
        <option value="120000"><%= t('admin.stats.live.minutes', { n: 2 }) %></option>
        <option value="300000"><%= t('admin.stats.live.minutes', { n: 5 }) %></option>
      </select>
    </div>
  </div>
  <p
    class="live-stats-empty"
    data-live-empty
    <%= liveVisitors.length ? 'hidden' : '' %>
  >
    <%= t('admin.stats.live.empty') %>
  </p>
  <div
    class="table-wrap"
    data-live-table
    <%= liveVisitors.length ? '' : 'hidden' %>
  >
    <table class="data-table compact">
      <thead>
        <tr>
          <th><%= t('admin.stats.live.headers.ip') %></th>
          <th><%= t('admin.stats.live.headers.type') %></th>
          <th><%= t('admin.stats.live.headers.path') %></th>
          <th><%= t('admin.stats.live.headers.lastActivity') %></th>
        </tr>
      </thead>
      <tbody data-live-table-body>
        <% liveVisitors.forEach((visitor) => { %>
          <tr>
            <td><code><%= visitor.ip %></code></td>
            <td>
              <% if (visitor.isBot) { %>
                <span class="status-pill suspicious"><%= t('admin.stats.live.type.bot') %></span>
                <% if (visitor.botReason) { %>
                  <br /><small class="text-muted"><%= visitor.botReason %></small>
                <% } %>
              <% } else { %>
                <span class="status-pill clean"><%= t('admin.stats.live.type.visitor') %></span>
              <% } %>
              <% if (visitor.userAgent) { %>
                <br /><small class="text-muted"><%= visitor.userAgent %></small>
              <% } %>
            </td>
            <td><a href="<%= visitor.path %>"><%= visitor.path %></a></td>
            <td>
              <time datetime="<%= visitor.lastSeenIso %>"><%= t('admin.stats.live.ago', { ago: visitor.lastSeenRelative }) %></time>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
  <div
    class="table-footer"
    data-live-footer
    <%= liveVisitors.length ? '' : 'hidden' %>
  >
    <div class="live-stats-per-page">
      <label for="liveStatsPerPage" class="nowrap"><%= t('common.perPage') %></label>
      <select id="liveStatsPerPage" data-live-per-page>
        <% (liveVisitorsPagination?.perPageOptions || []).forEach(option => { %>
          <option value="<%= option %>" <%= option === liveVisitorsPagination.perPage ? 'selected' : '' %>><%= option %></option>
        <% }) %>
      </select>
    </div>
    <span data-live-page-info>
      Page <%= liveVisitorsPagination?.page || 1 %> sur <%= liveVisitorsPagination?.totalPages || 1 %>
    </span>
    <div class="pager">
      <button
        type="button"
        class="btn"
        data-icon="⬅️"
        data-live-prev
        <%= liveVisitorsPagination?.hasPrevious ? '' : 'disabled' %>
      >
        Précédent
      </button>
      <button
        type="button"
        class="btn"
        data-icon="➡️"
        data-live-next
        <%= liveVisitorsPagination?.hasNext ? '' : 'disabled' %>
      >
        Suivant
      </button>
    </div>
  </div>
</section>

<%
  const trendsRangeLabel =
    viewTrendsRange?.from && viewTrendsRange?.to
      ? `${new Date(viewTrendsRange.from).toLocaleDateString(locale)} – ${new Date(viewTrendsRange.to).toLocaleDateString(locale)}`
      : "Période indisponible";
  const trendsTotalLabel = typeof viewTrendsTotal === 'number'
    ? viewTrendsTotal.toLocaleString(locale)
    : '0';
  const trendsUpdatedLabel = viewTrendsGeneratedAt
    ? new Date(viewTrendsGeneratedAt).toLocaleString(locale)
    : '—';
%>
<section
  class="card stats-trends-card"
  data-view-trends
  data-endpoint="/admin/stats/trends.json"
  data-initial-range="<%= viewTrendsRangeDays %>"
>
  <div class="stats-trends-header">
    <div>
      <h2 class="mt-0">Tendance des vues quotidiennes</h2>
      <p class="text-muted text-sm">
        Visualisez l'évolution des vues agrégées et comparez rapidement les périodes clés.
      </p>
    </div>
    <div class="stats-trends-actions" role="group" aria-label="Changer la période analysée">
      <button
        type="button"
        class="stats-trends-range-btn <%= viewTrendsRangeDays === 7 ? 'is-active' : '' %>"
        data-trend-range="7"
        aria-pressed="<%= viewTrendsRangeDays === 7 ? 'true' : 'false' %>"
      >
        7 jours
      </button>
      <button
        type="button"
        class="stats-trends-range-btn <%= viewTrendsRangeDays === 14 ? 'is-active' : '' %>"
        data-trend-range="14"
        aria-pressed="<%= viewTrendsRangeDays === 14 ? 'true' : 'false' %>"
      >
        14 jours
      </button>
      <button
        type="button"
        class="stats-trends-range-btn <%= viewTrendsRangeDays === 30 ? 'is-active' : '' %>"
        data-trend-range="30"
        aria-pressed="<%= viewTrendsRangeDays === 30 ? 'true' : 'false' %>"
      >
        30 jours
      </button>
    </div>
  </div>
  <div class="stats-trends-body">
    <p class="stats-trends-status text-sm" data-chart-status aria-live="polite">
      Chargement des tendances…
    </p>
    <div class="stats-trends-chart" data-chart-region aria-hidden="true"></div>
    <div class="stats-trends-meta">
      <dl>
        <div>
          <dt>Période affichée</dt>
          <dd data-chart-range-label><%= trendsRangeLabel %></dd>
        </div>
        <div>
          <dt>Total des vues</dt>
          <dd data-chart-total><%= trendsTotalLabel %></dd>
        </div>
        <div>
          <dt>Dernière mise à jour</dt>
          <dd data-chart-generated-at><%= trendsUpdatedLabel %></dd>
        </div>
      </dl>
    </div>
    <div class="stats-trends-fallback" data-chart-fallback>
      <% if (!viewTrends.length) { %>
        <p>Aucune donnée de vues quotidiennes n'est encore disponible.</p>
      <% } else { %>
        <ul class="stats-trend-list">
          <% viewTrends.forEach((row) => { %>
            <li>
              <span><%= row.date || row.day %></span>
              <strong><%= row.views %></strong>
            </li>
          <% }) %>
        </ul>
      <% } %>
    </div>
    <table class="sr-only" data-chart-table>
      <caption>Tendance des vues quotidiennes</caption>
      <thead>
        <tr>
          <th scope="col">Jour</th>
          <th scope="col">Nombre de vues</th>
        </tr>
      </thead>
      <tbody data-chart-table-body>
        <% if (viewTrends.length) { %>
          <% viewTrends.forEach((row) => { %>
            <tr>
              <th scope="row"><%= row.date || row.day %></th>
              <td><%= row.views %></td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>
</section>

<section class="stats-activity-grid">
  <div class="card">
    <h2>Pages récemment créées</h2>
    <% if (!recentPages.length) { %>
      <p>Aucune création récente.</p>
    <% } else { %>
      <ul class="stats-activity-list">
        <% recentPages.forEach(page => { %>
          <li>
            <div>
              <a href="/wiki/<%= page.slug_id %>"><%= page.title %></a>
              <span class="text-muted text-sm">Créée le <%= page.created_at ? new Date(page.created_at).toLocaleString(locale) : 'n/a' %></span>
            </div>
          </li>
        <% }) %>
      </ul>
    <% } %>
  </div>
  <div class="card">
    <h2>Événements récents</h2>
    <% if (!recentEvents.length) { %>
      <p>Aucun événement administrateur enregistré.</p>
    <% } else { %>
      <ul class="stats-activity-list">
        <% recentEvents.forEach(event => { %>
          <li>
            <div>
              <span class="highlight-label"><%= event.type %></span>
              <span class="text-muted text-sm">Canal : <%= event.channel %></span>
              <% if (event.snowflake_id) { %>
                <br /><small class="text-muted">ID : <code><%= event.snowflake_id %></code></small>
              <% } %>
            </div>
            <div class="text-muted text-sm">
              <time datetime="<%= event.created_at %>"><%= new Date(event.created_at).toLocaleString(locale) %></time>
              <% if (event.username) { %>
                <% const eventUserColor = event.userRole && event.userRole.color ? event.userRole.color : null; %>
                <% const eventUserClasses = ['user-handle', 'event-user']; %>
                <% const eventUserStyle = eventUserColor && eventUserColor.hasColor ? eventUserColor.style : ''; %>
                <% if (eventUserColor && eventUserColor.hasColor) { eventUserClasses.push('role-colored-text'); eventUserClasses.push(eventUserColor.className); } %>
                <% const eventUserBadges = Array.isArray(event?.userRole?.badges) ? event.userRole.badges : []; %>
                · <span>
                  par
                  <span class="user-handle-decorated">
                    <strong class="<%= eventUserClasses.join(' ') %>" style="<%= eventUserStyle %>"><%= event.username %></strong>
                    <%- include('../partials/userBadges', {
                      badges: eventUserBadges,
                      listClass: ['user-handle-badges', 'user-handle-badges--inline'],
                      itemClass: 'user-handle-badge-item',
                      iconClass: 'user-handle-badge-icon',
                      srOnlyClass: 'sr-only',
                      ariaLabel: "Badges de l'utilisateur",
                    }) %>
                  </span>
                </span>
              <% } %>
            </div>
          </li>
        <% }) %>
      </ul>
    <% } %>
  </div>
</section>

<section class="card stats-panels">
  <div>
    <h2><%= t('admin.stats.panels.topLiked.title') %></h2>
    <% if (!topLikedPages.length) { %>
      <p><%= t('admin.stats.panels.topLiked.empty') %></p>
    <% } else { %>
      <div class="table-wrap">
        <table class="data-table compact">
          <thead>
            <tr>
              <th>#</th>
              <th><%= t('admin.stats.panels.headers.page') %></th>
              <th><%= t('admin.stats.panels.headers.likes') %></th>
            </tr>
          </thead>
          <tbody>
            <% topLikedPages.forEach((row, idx) => { %>
              <tr>
                <td><%= idx + 1 %></td>
                <td><a href="/wiki/<%= row.slug_id %>"><%= row.title %></a></td>
                <td><%= row.likes %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <%- include('./paginationControls', { pagination: topLikedPagination }) %>
    <% } %>
  </div>
  <div>
    <h2><%= t('admin.stats.panels.topCommenters.title') %></h2>
    <% if (!topCommenters.length) { %>
      <p><%= t('admin.stats.panels.topCommenters.empty') %></p>
    <% } else { %>
      <div class="table-wrap">
        <table class="data-table compact">
          <thead>
            <tr>
              <th><%= t('admin.stats.panels.headers.author') %></th>
              <th><%= t('admin.stats.panels.headers.comments') %></th>
            </tr>
          </thead>
          <tbody>
            <% topCommenters.forEach(row => { %>
              <% const commenterColor = row.authorRole && row.authorRole.color ? row.authorRole.color : null; %>
              <% const commenterClasses = ['user-handle', 'commenter-name']; %>
              <% const commenterStyle = commenterColor && commenterColor.hasColor ? commenterColor.style : ''; %>
              <% if (commenterColor && commenterColor.hasColor) { commenterClasses.push('role-colored-text'); commenterClasses.push(commenterColor.className); } %>
              <% const commenterBadges = Array.isArray(row?.authorRole?.badges) ? row.authorRole.badges : []; %>
              <tr>
                <td>
                  <% const anonLabel = t('admin.common.anonymous'); %>
                  <% if (row.author && row.author !== anonLabel) { %>
                    <span class="user-handle-decorated">
                      <strong class="<%= commenterClasses.join(' ') %>" style="<%= commenterStyle %>"><%= row.author %></strong>
                      <%- include('../partials/userBadges', {
                        badges: commenterBadges,
                        listClass: ['user-handle-badges', 'user-handle-badges--inline'],
                        itemClass: 'user-handle-badge-item',
                        iconClass: 'user-handle-badge-icon',
                        srOnlyClass: 'sr-only',
                        ariaLabel: t('common.authorBadgesAria'),
                      }) %>
                    </span>
                  <% } else { %>
                    <%= row.author %>
                  <% } %>
                </td>
                <td><%= row.comments %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <%- include('./paginationControls', { pagination: topCommentersPagination }) %>
    <% } %>
  </div>
  <div>
    <h2><%= t('admin.stats.panels.topCommented.title') %></h2>
    <% if (!topCommentedPages.length) { %>
      <p><%= t('admin.stats.panels.topCommented.empty') %></p>
    <% } else { %>
      <div class="table-wrap">
        <table class="data-table compact">
          <thead>
            <tr>
              <th>#</th>
              <th><%= t('admin.stats.panels.headers.page') %></th>
              <th><%= t('admin.stats.panels.headers.comments') %></th>
            </tr>
          </thead>
          <tbody>
            <% topCommentedPages.forEach((row, idx) => { %>
              <tr>
                <td><%= idx + 1 %></td>
                <td><a href="/wiki/<%= row.slug_id %>"><%= row.title %></a></td>
                <td><%= row.comments %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <%- include('./paginationControls', { pagination: topCommentedPagination }) %>
    <% } %>
  </div>
</section>

<section class="card mb-xl">
  <h2><%= t('admin.stats.activeIps.title') %></h2>
  <% if (!activeIps.length) { %>
    <p><%= t('admin.stats.activeIps.empty') %></p>
  <% } else { %>
    <div class="table-wrap">
      <table class="data-table compact">
        <thead>
          <tr>
            <th>#</th>
            <th><%= t('admin.stats.activeIps.headers.ip') %></th>
            <th><%= t('admin.stats.activeIps.headers.views') %></th>
          </tr>
        </thead>
        <tbody>
          <% activeIps.forEach((row, idx) => { %>
            <tr>
              <td><%= idx + 1 %></td>
              <td><code><%= row.ip %></code></td>
              <td><%= row.views %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <%- include('./paginationControls', { pagination: activeIpsPagination }) %>
  <% } %>
</section>

<section class="card mb-xl stats-panels">
  <div>
    <h2><%= t('admin.stats.tags.title') %></h2>
    <% if (!tagUsage.length) { %>
      <p><%= t('admin.stats.tags.empty') %></p>
    <% } else { %>
      <div class="table-wrap">
        <table class="data-table compact">
          <thead>
            <tr>
            <th>#</th>
            <th><%= t('admin.stats.tags.headers.tag') %></th>
            <th><%= t('admin.stats.tags.headers.pages') %></th>
            </tr>
          </thead>
          <tbody>
            <% tagUsage.forEach((row, idx) => { %>
              <tr>
                <td><%= idx + 1 %></td>
                <td><code><%= row.name %></code></td>
                <td><%= row.pages %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <%- include('./paginationControls', { pagination: tagUsagePagination }) %>
    <% } %>
  </div>
  <div>
    <h2><%= t('admin.stats.timeline.title') %></h2>
    <% if (!commentTimeline.length) { %>
      <p><%= t('admin.stats.timeline.empty') %></p>
    <% } else { %>
      <div class="table-wrap">
        <table class="data-table compact">
          <thead>
            <tr>
            <th><%= t('admin.stats.timeline.headers.day') %></th>
            <th><%= t('admin.stats.timeline.headers.comments') %></th>
            </tr>
          </thead>
          <tbody>
            <% commentTimeline.forEach(row => { %>
              <tr>
                <td><%= row.day %></td>
                <td><%= row.comments %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <%- include('./paginationControls', { pagination: commentTimelinePagination }) %>
    <% } %>
  </div>
</section>

<section class="card mb-xl">
  <h2><%= t('admin.stats.ipViews.title') %></h2>
  <% if (!ipViewsByPage.length) { %>
    <p><%= t('admin.stats.ipViews.empty') %></p>
  <% } else { %>
    <div class="table-wrap">
      <table class="data-table compact">
        <thead>
          <tr>
            <th><%= t('admin.stats.ipViews.headers.ip') %></th>
            <th><%= t('admin.stats.ipViews.headers.page') %></th>
            <th><%= t('admin.stats.ipViews.headers.slug') %></th>
            <th><%= t('admin.stats.ipViews.headers.views') %></th>
          </tr>
        </thead>
        <tbody>
          <% ipViewsByPage.forEach(row => { %>
            <tr>
              <td><code><%= row.ip %></code></td>
              <td><a href="/wiki/<%= row.slug_id %>"><%= row.title %></a></td>
              <td><code><%= row.slug_id %></code></td>
              <td><%= row.views %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <%- include('./paginationControls', { pagination: ipViewsPagination }) %>
  <% } %>
</section>

<% periods.forEach(period => { const rows = stats[period.key] || []; %>
  <section class="card mb-xl">
    <h2><%= period.label %></h2>
    <% if (!rows.length) { %>
      <p><%= t('admin.stats.period.noData') %></p>
    <% } else { %>
      <div class="table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th>
              <th><%= t('admin.stats.period.headers.page') %></th>
              <th><%= t('admin.stats.period.headers.slug') %></th>
              <th><%= t('admin.stats.period.headers.views') %></th>
            </tr>
          </thead>
          <tbody>
            <% rows.forEach((row, idx) => { %>
              <tr>
                <td><%= idx + 1 %></td>
                <td><a href="/wiki/<%= row.slug_id %>"><%= row.title %></a></td>
                <td><code><%= row.slug_id %></code></td>
                <td><strong><%= row.views %></strong></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
  </section>
<% }) %>

<script defer src="/public/admin-stats.js"></script>

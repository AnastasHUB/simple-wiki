<% title='Statistiques'; %>
<section class="card stats-hero">
  <div>
    <h1 class="mt-0">Tableau de bord des statistiques</h1>
    <p class="text-muted">Suivez en un clin d'œil la popularité du wiki et la charge de modération.</p>
  </div>
  <div class="stats-hero-metrics">
    <div>
      <span class="stats-hero-label">Vues cumulées</span>
      <strong><%= totalViews %></strong>
    </div>
    <div>
      <span class="stats-hero-label">Moyenne par page</span>
      <strong><%= avgViewsPerPage %></strong>
    </div>
    <div>
      <span class="stats-hero-label">Visiteurs uniques</span>
      <strong><%= totalsBreakdown.uniqueIps %></strong>
    </div>
  </div>
</section>

<section class="stats-overview-grid">
  <div class="card">
    <h2>Résumé global</h2>
    <ul class="stat-grid">
      <li>
        <span class="label">Vues cumulées</span>
        <strong><%= totalViews %></strong>
      </li>
      <li>
        <span class="label">Likes</span>
        <strong><%= totalsBreakdown.likes %></strong>
      </li>
      <li>
        <span class="label">Commentaires</span>
        <strong><%= totalsBreakdown.comments %></strong>
      </li>
      <li>
        <span class="label">Blocages actifs</span>
        <strong><%= totalsBreakdown.activeBans %></strong>
      </li>
      <li>
        <span class="label">Événements loggés</span>
        <strong><%= totalsBreakdown.events %></strong>
      </li>
      <li>
        <span class="label">Visiteurs uniques (IP)</span>
        <strong><%= totalsBreakdown.uniqueIps %></strong>
      </li>
    </ul>
    <% if (totalsBreakdown.commentByStatus && totalsBreakdown.commentByStatus.length) { %>
      <h3>Commentaires par statut</h3>
      <div class="table-wrap">
        <table class="data-table compact">
          <thead>
            <tr>
              <th>Statut</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <% totalsBreakdown.commentByStatus.forEach(row => { %>
              <tr>
                <td><%= row.status %></td>
                <td><%= row.count %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
    <p class="note-text">
      Les totaux combinent les événements récents et les agrégats quotidiens. Utilisez les sections ci-dessous pour analyser les périodes spécifiques.
    </p>
  </div>
  <div class="card stats-highlight-card">
    <h2>Indicateurs clés</h2>
    <% if (!engagementHighlights.length) { %>
      <p>Aucun indicateur disponible pour le moment.</p>
    <% } else { %>
      <ul class="stats-highlight-grid">
        <% engagementHighlights.forEach(item => { %>
          <li>
            <span class="highlight-icon" aria-hidden="true"><%= item.icon %></span>
            <div>
              <span class="highlight-label"><%= item.label %></span>
              <strong><%= item.value %></strong>
              <% if (item.secondary) { %>
                <span class="highlight-secondary"><%= item.secondary %></span>
              <% } %>
            </div>
          </li>
        <% }) %>
      </ul>
    <% } %>
  </div>
</section>

<%
  const liveWindowMinutes = Math.max(
    1,
    Math.round((liveVisitorsWindowSeconds || 0) / 60),
  );
  const liveWindowLabel =
    (liveVisitorsWindowSeconds || 0) >= 60
      ? `${liveWindowMinutes} minute${liveWindowMinutes > 1 ? 's' : ''}`
      : `${liveVisitorsWindowSeconds || 0} seconde${
          (liveVisitorsWindowSeconds || 0) > 1 ? 's' : ''
        }`;
%>
<section class="card stats-live-card">
  <div class="card-header">
    <h2 class="mt-0">Live stats</h2>
    <p class="text-muted text-sm">
      Basé sur l'activité des <%= liveWindowLabel %> précédentes.
    </p>
  </div>
  <% if (!liveVisitors.length) { %>
    <p>Aucun visiteur actif détecté pour le moment.</p>
  <% } else { %>
    <div class="table-wrap">
      <table class="data-table compact">
        <thead>
          <tr>
            <th>Adresse IP</th>
            <th>Page actuelle</th>
            <th>Dernière activité</th>
          </tr>
        </thead>
        <tbody>
          <% liveVisitors.forEach((visitor) => { %>
            <tr>
              <td><code><%= visitor.ip %></code></td>
              <td><a href="<%= visitor.path %>"><%= visitor.path %></a></td>
              <td>
                <time datetime="<%= visitor.lastSeenIso %>">
                  il y a <%= visitor.lastSeenRelative %>
                </time>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } %>
</section>

<section class="card stats-trend-card">
  <h2>Vues quotidiennes récentes</h2>
  <% if (!viewTrends.length) { %>
    <p>Aucune donnée de vues quotidiennes n'est encore disponible.</p>
  <% } else { %>
    <ul class="stats-trend-list">
      <% viewTrends.forEach((row) => { %>
        <li>
          <span><%= row.day %></span>
          <strong><%= row.views %></strong>
        </li>
      <% }) %>
    </ul>
  <% } %>
</section>

<section class="stats-activity-grid">
  <div class="card">
    <h2>Pages récemment créées</h2>
    <% if (!recentPages.length) { %>
      <p>Aucune création récente.</p>
    <% } else { %>
      <ul class="stats-activity-list">
        <% recentPages.forEach(page => { %>
          <li>
            <div>
              <a href="/wiki/<%= page.slug_id %>"><%= page.title %></a>
              <span class="text-muted text-sm">Créée le <%= page.created_at ? new Date(page.created_at).toLocaleString('fr-FR') : 'n/a' %></span>
            </div>
          </li>
        <% }) %>
      </ul>
    <% } %>
  </div>
  <div class="card">
    <h2>Événements récents</h2>
    <% if (!recentEvents.length) { %>
      <p>Aucun événement administrateur enregistré.</p>
    <% } else { %>
      <ul class="stats-activity-list">
        <% recentEvents.forEach(event => { %>
          <li>
            <div>
              <span class="highlight-label"><%= event.type %></span>
              <span class="text-muted text-sm">Canal : <%= event.channel %></span>
            </div>
            <div class="text-muted text-sm">
              <time datetime="<%= event.created_at %>"><%= new Date(event.created_at).toLocaleString('fr-FR') %></time>
              <% if (event.username) { %> · <span>par <strong><%= event.username %></strong></span><% } %>
            </div>
          </li>
        <% }) %>
      </ul>
    <% } %>
  </div>
</section>

<section class="card stats-panels">
  <div>
    <h2>Pages les plus aimées</h2>
    <% if (!topLikedPages.length) { %>
      <p>Aucun like enregistré.</p>
    <% } else { %>
      <div class="table-wrap">
        <table class="data-table compact">
          <thead>
            <tr>
              <th>#</th>
              <th>Article</th>
              <th>Likes</th>
            </tr>
          </thead>
          <tbody>
            <% topLikedPages.forEach((row, idx) => { %>
              <tr>
                <td><%= idx + 1 %></td>
                <td><a href="/wiki/<%= row.slug_id %>"><%= row.title %></a></td>
                <td><%= row.likes %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <%- include('./paginationControls', { pagination: topLikedPagination }) %>
    <% } %>
  </div>
  <div>
    <h2>Auteurs de commentaires</h2>
    <% if (!topCommenters.length) { %>
      <p>Aucun commentaire enregistré.</p>
    <% } else { %>
      <div class="table-wrap">
        <table class="data-table compact">
          <thead>
            <tr>
              <th>Auteur</th>
              <th>Commentaires</th>
            </tr>
          </thead>
          <tbody>
            <% topCommenters.forEach(row => { %>
              <tr>
                <td><%= row.author %></td>
                <td><%= row.comments %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <%- include('./paginationControls', { pagination: topCommentersPagination }) %>
    <% } %>
  </div>
  <div>
    <h2>Articles les plus commentés</h2>
    <% if (!topCommentedPages.length) { %>
      <p>Aucun commentaire approuvé.</p>
    <% } else { %>
      <div class="table-wrap">
        <table class="data-table compact">
          <thead>
            <tr>
              <th>#</th>
              <th>Article</th>
              <th>Commentaires</th>
            </tr>
          </thead>
          <tbody>
            <% topCommentedPages.forEach((row, idx) => { %>
              <tr>
                <td><%= idx + 1 %></td>
                <td><a href="/wiki/<%= row.slug_id %>"><%= row.title %></a></td>
                <td><%= row.comments %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <%- include('./paginationControls', { pagination: topCommentedPagination }) %>
    <% } %>
  </div>
</section>

<section class="card mb-xl">
  <h2>IPs les plus actives</h2>
  <% if (!activeIps.length) { %>
    <p>Aucune IP enregistrée.</p>
  <% } else { %>
    <div class="table-wrap">
      <table class="data-table compact">
        <thead>
          <tr>
            <th>#</th>
            <th>IP</th>
            <th>Vues</th>
          </tr>
        </thead>
        <tbody>
          <% activeIps.forEach((row, idx) => { %>
            <tr>
              <td><%= idx + 1 %></td>
              <td><code><%= row.ip %></code></td>
              <td><%= row.views %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <%- include('./paginationControls', { pagination: activeIpsPagination }) %>
  <% } %>
</section>

<section class="card mb-xl stats-panels">
  <div>
    <h2>Tags les plus utilisés</h2>
    <% if (!tagUsage.length) { %>
      <p>Aucun tag enregistré.</p>
    <% } else { %>
      <div class="table-wrap">
        <table class="data-table compact">
          <thead>
            <tr>
              <th>#</th>
              <th>Tag</th>
              <th>Pages</th>
            </tr>
          </thead>
          <tbody>
            <% tagUsage.forEach((row, idx) => { %>
              <tr>
                <td><%= idx + 1 %></td>
                <td><code><%= row.name %></code></td>
                <td><%= row.pages %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <%- include('./paginationControls', { pagination: tagUsagePagination }) %>
    <% } %>
  </div>
  <div>
    <h2>Chronologie des commentaires (30 derniers jours)</h2>
    <% if (!commentTimeline.length) { %>
      <p>Aucune activité récente.</p>
    <% } else { %>
      <div class="table-wrap">
        <table class="data-table compact">
          <thead>
            <tr>
              <th>Jour</th>
              <th>Commentaires</th>
            </tr>
          </thead>
          <tbody>
            <% commentTimeline.forEach(row => { %>
              <tr>
                <td><%= row.day %></td>
                <td><%= row.comments %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <%- include('./paginationControls', { pagination: commentTimelinePagination }) %>
    <% } %>
  </div>
</section>

<section class="card mb-xl">
  <h2>Vues par IP et article</h2>
  <% if (!ipViewsByPage.length) { %>
    <p>Aucune donnée disponible.</p>
  <% } else { %>
    <div class="table-wrap">
      <table class="data-table compact">
        <thead>
          <tr>
            <th>IP</th>
            <th>Article</th>
            <th>Slug</th>
            <th>Vues</th>
          </tr>
        </thead>
        <tbody>
          <% ipViewsByPage.forEach(row => { %>
            <tr>
              <td><code><%= row.ip %></code></td>
              <td><a href="/wiki/<%= row.slug_id %>"><%= row.title %></a></td>
              <td><code><%= row.slug_id %></code></td>
              <td><%= row.views %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <%- include('./paginationControls', { pagination: ipViewsPagination }) %>
  <% } %>
</section>

<% periods.forEach(period => { const rows = stats[period.key] || []; %>
  <section class="card mb-xl">
    <h2><%= period.label %></h2>
    <% if (!rows.length) { %>
      <p>Aucune donnée disponible pour cette période.</p>
    <% } else { %>
      <div class="table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Article</th>
              <th>Slug</th>
              <th>Vues</th>
            </tr>
          </thead>
          <tbody>
            <% rows.forEach((row, idx) => { %>
              <tr>
                <td><%= idx + 1 %></td>
                <td><a href="/wiki/<%= row.slug_id %>"><%= row.title %></a></td>
                <td><code><%= row.slug_id %></code></td>
                <td><strong><%= row.views %></strong></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
  </section>
<% }) %>

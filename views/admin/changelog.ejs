<% title = 'Changelog'; %>
<h1>Gestion du changelog</h1>

<section class="card">
  <header class="card-header">
    <h2 class="mt-0">Ajouter une nouvelle version</h2>
    <p class="text-muted mt-xs">Renseignez la version, la date et les changements associés. Les détails sont enregistrés ligne par ligne.</p>
  </header>

  <% if (errors && errors.length) { %>
    <div class="alert alert-error mt-sm" role="alert">
      <ul class="changelog-error-list">
        <% errors.forEach(function(error) { %>
          <li><%= error %></li>
        <% }); %>
      </ul>
    </div>
  <% } %>

  <form method="post" action="/admin/changelog" class="stack-form mt-md">
    <label>
      Version
      <input type="text" name="version" value="<%= formValues && formValues.version ? formValues.version : '' %>" required />
    </label>
    <label>
      Date de publication
      <input type="date" name="date" value="<%= formValues && formValues.date ? formValues.date : '' %>" />
      <p class="help-text">Laissez vide pour utiliser la date du jour.</p>
    </label>
    <label>
      Titre
      <input type="text" name="title" value="<%= formValues && formValues.title ? formValues.title : '' %>" />
      <p class="help-text">Optionnel, sera remplacé par "Version X" si vide.</p>
    </label>
    <label>
      Détails de la version
      <textarea name="details" rows="6" placeholder="Une amélioration par ligne" required><%= formValues && formValues.details ? formValues.details : '' %></textarea>
    </label>
    <button type="submit" class="btn">Ajouter la version</button>
  </form>
</section>

<section class="card mt-xl">
  <header class="card-header">
    <h2 class="mt-0">Versions publiées</h2>
    <p class="text-muted mt-xs">Modifiez ou supprimez une version existante. Les éléments sont triés du plus récent au plus ancien.</p>
  </header>

  <% if (!entries || !entries.length) { %>
    <p class="text-muted mt-md">Aucune version n'a encore été enregistrée.</p>
  <% } else { %>
    <ul class="admin-changelog-list mt-md">
      <% entries.forEach(function(entry) { %>
        <li class="admin-changelog-item">
          <header class="admin-changelog-item-header">
            <div>
              <p class="admin-changelog-item-version">Version <strong><%= entry.version || 'Non définie' %></strong></p>
              <p class="admin-changelog-item-title"><%= entry.title %></p>
            </div>
            <% if (entry.date) { %>
              <time datetime="<%= entry.date %>"><%= entry.date %></time>
            <% } %>
          </header>

          <div class="admin-changelog-item-body">
            <form method="post" action="/admin/changelog/<%= entry.index %>/update" class="stack-form admin-changelog-form">
              <label>
                Version
                <input type="text" name="version" value="<%= entry.version %>" required />
              </label>
              <label>
                Date de publication
                <input type="date" name="date" value="<%= entry.date || '' %>" />
              </label>
              <label>
                Titre
                <input type="text" name="title" value="<%= entry.title %>" />
              </label>
              <label>
                Détails de la version
                <textarea name="details" rows="5" required><%= entry.detailsText %></textarea>
              </label>
              <div class="admin-changelog-form-actions">
                <button type="submit" class="btn">Mettre à jour</button>
                <button
                  type="submit"
                  class="btn danger"
                  form="delete-form-<%= entry.index %>"
                  onclick="return confirm(<%= JSON.stringify(`Supprimer définitivement la version ${entry.version || ''} ?`) %>);"
                >
                  Supprimer
                </button>
              </div>
            </form>
            <form
              method="post"
              action="/admin/changelog/<%= entry.index %>/delete"
              id="delete-form-<%= entry.index %>"
              class="admin-changelog-delete"
            ></form>
          </div>
        </li>
      <% }); %>
    </ul>
  <% } %>
</section>

<% title = 'Blocages IP'; %>
<h1>Blocages IP</h1>

<section class="card" style="margin-bottom:24px;">
  <h2>Ajouter un blocage</h2>
  <form method="post" action="/admin/ip-bans" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:12px;">
    <div>
      <label for="ip">Adresse IP</label>
      <input id="ip" type="text" name="ip" required>
    </div>
    <div>
      <label for="scope">Port√©e</label>
      <select id="scope" name="scope" required>
        <option value="global">Wiki entier</option>
        <option value="view">Blocage des vues</option>
        <option value="comment">Commentaires</option>
        <option value="like">Likes</option>
        <option value="tag">Tag sp√©cifique</option>
      </select>
    </div>
    <div>
      <label for="tag">Tag (si applicable)</label>
      <input id="tag" type="text" name="tag" placeholder="ex: spoiler">
    </div>
    <div style="grid-column: 1 / -1;">
      <label for="reason">Motif</label>
      <input id="reason" type="text" name="reason" placeholder="Optionnel">
    </div>
    <div style="grid-column: 1 / -1;">
      <button class="btn success" data-icon="üõ°Ô∏è" type="submit">Enregistrer</button>
    </div>
  </form>
  <p style="font-size:0.85em; color:#94a3b8; margin-top:12px;">Pour un blocage limit√© √† une action, choisissez la port√©e correspondante. Pour interdire l'acc√®s √† un tag, indiquez "tag" puis le nom du tag.</p>
</section>

<section class="card">
  <h2>Blocages actifs (<%= activePagination.totalItems %>)</h2>
  <% if (!activeBans.length) { %>
    <p>Aucun blocage actif.</p>
  <% } else { %>
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th>
            <th>IP</th>
            <th>Type</th>
            <th>Valeur</th>
            <th>Motif</th>
            <th>Cr√©√©</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% activeBans.forEach(ban => { %>
            <tr>
              <td><%= ban.snowflake_id %></td>
              <td><code><%= ban.ip %></code></td>
              <td><%= ban.scope %></td>
              <td><%= ban.value || '-' %></td>
              <td><%= ban.reason || '-' %></td>
              <td><%= new Date(ban.created_at).toLocaleString('fr-FR') %></td>
              <td>
                <form method="post" action="/admin/ip-bans/<%= ban.snowflake_id %>/lift" onsubmit="return confirm('Lever ce blocage ?');">
                  <button class="btn secondary" data-icon="üóùÔ∏è" type="submit">Lever</button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <div class="table-footer" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.75rem; margin-top:1rem;">
      <form method="get" style="display:flex; align-items:center; gap:0.5rem;">
        <label for="active-per-page" style="white-space:nowrap;">√âl√©ments par page</label>
        <select id="active-per-page" name="activePerPage" onchange="this.form.submit()">
          <% activePagination.perPageOptions.forEach(option => { %>
            <option value="<%= option %>" <%= option === activePagination.perPage ? 'selected' : '' %>><%= option %></option>
          <% }) %>
        </select>
        <input type="hidden" name="activePage" value="1">
        <input type="hidden" name="liftedPage" value="<%= liftedPagination.page %>">
        <input type="hidden" name="liftedPerPage" value="<%= liftedPagination.perPage %>">
      </form>
      <span>Page <%= activePagination.page %> sur <%= activePagination.totalPages %></span>
      <div style="display:flex; gap:0.5rem;">
        <% if (activePagination.hasPrevious) { %>
          <a class="btn" data-icon="‚¨ÖÔ∏è" href="?activePage=<%= activePagination.previousPage %>&activePerPage=<%= activePagination.perPage %>&liftedPage=<%= liftedPagination.page %>&liftedPerPage=<%= liftedPagination.perPage %>">Pr√©c√©dent</a>
        <% } else { %>
          <span class="btn" data-icon="‚¨ÖÔ∏è" aria-disabled="true" style="pointer-events:none; opacity:0.5;">Pr√©c√©dent</span>
        <% } %>
        <% if (activePagination.hasNext) { %>
          <a class="btn" data-icon="‚û°Ô∏è" href="?activePage=<%= activePagination.nextPage %>&activePerPage=<%= activePagination.perPage %>&liftedPage=<%= liftedPagination.page %>&liftedPerPage=<%= liftedPagination.perPage %>">Suivant</a>
        <% } else { %>
          <span class="btn" data-icon="‚û°Ô∏è" aria-disabled="true" style="pointer-events:none; opacity:0.5;">Suivant</span>
        <% } %>
      </div>
    </div>
  <% } %>
</section>

<section class="card">
  <h2>Blocages lev√©s (<%= liftedPagination.totalItems %>)</h2>
  <% if (!liftedBans.length) { %>
    <p>Aucun blocage lev√© enregistr√©.</p>
  <% } else { %>
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th>
            <th>IP</th>
            <th>Type</th>
            <th>Valeur</th>
            <th>Motif</th>
            <th>Cr√©√©</th>
            <th>Lev√©e</th>
          </tr>
        </thead>
        <tbody>
          <% liftedBans.forEach(ban => { %>
            <tr>
              <td><%= ban.snowflake_id %></td>
              <td><code><%= ban.ip %></code></td>
              <td><%= ban.scope %></td>
              <td><%= ban.value || '-' %></td>
              <td><%= ban.reason || '-' %></td>
              <td><%= new Date(ban.created_at).toLocaleString('fr-FR') %></td>
              <td><%= new Date(ban.lifted_at).toLocaleString('fr-FR') %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <div class="table-footer" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.75rem; margin-top:1rem;">
      <form method="get" style="display:flex; align-items:center; gap:0.5rem;">
        <label for="lifted-per-page" style="white-space:nowrap;">√âl√©ments par page</label>
        <select id="lifted-per-page" name="liftedPerPage" onchange="this.form.submit()">
          <% liftedPagination.perPageOptions.forEach(option => { %>
            <option value="<%= option %>" <%= option === liftedPagination.perPage ? 'selected' : '' %>><%= option %></option>
          <% }) %>
        </select>
        <input type="hidden" name="liftedPage" value="1">
        <input type="hidden" name="activePage" value="<%= activePagination.page %>">
        <input type="hidden" name="activePerPage" value="<%= activePagination.perPage %>">
      </form>
      <span>Page <%= liftedPagination.page %> sur <%= liftedPagination.totalPages %></span>
      <div style="display:flex; gap:0.5rem;">
        <% if (liftedPagination.hasPrevious) { %>
          <a class="btn" data-icon="‚¨ÖÔ∏è" href="?liftedPage=<%= liftedPagination.previousPage %>&liftedPerPage=<%= liftedPagination.perPage %>&activePage=<%= activePagination.page %>&activePerPage=<%= activePagination.perPage %>">Pr√©c√©dent</a>
        <% } else { %>
          <span class="btn" data-icon="‚¨ÖÔ∏è" aria-disabled="true" style="pointer-events:none; opacity:0.5;">Pr√©c√©dent</span>
        <% } %>
        <% if (liftedPagination.hasNext) { %>
          <a class="btn" data-icon="‚û°Ô∏è" href="?liftedPage=<%= liftedPagination.nextPage %>&liftedPerPage=<%= liftedPagination.perPage %>&activePage=<%= activePagination.page %>&activePerPage=<%= activePagination.perPage %>">Suivant</a>
        <% } else { %>
          <span class="btn" data-icon="‚û°Ô∏è" aria-disabled="true" style="pointer-events:none; opacity:0.5;">Suivant</span>
        <% } %>
      </div>
    </div>
  <% } %>
</section>

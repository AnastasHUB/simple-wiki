<% title = 'Blocages IP'; %>
<h1>Blocages IP</h1>
<% const permissionFlags =
  typeof permissions !== 'undefined' && permissions && typeof permissions === 'object'
    ? permissions
    : {}; %>
<% const canManageUserBansLocal = typeof canManageUserBans === 'boolean'
  ? canManageUserBans
  : Boolean(permissionFlags.can_manage_users && permissionFlags.can_suspend_users);
%>

<form method="get" class="card mb-md">
  <div class="flex flex-wrap gap-sm items-end">
    <label class="stack-form">
      <span class="text-sm text-muted">Rechercher</span>
      <input
        type="text"
        name="search"
        value="<%= typeof searchTerm === 'string' ? searchTerm : '' %>"
        placeholder="ID, IP, nom, motif‚Ä¶"
        class="flex-basis-260"
      />
    </label>
    <input type="hidden" name="activePage" value="1" />
    <input type="hidden" name="liftedPage" value="1" />
    <input type="hidden" name="activePerPage" value="<%= activePagination.perPage %>" />
    <input type="hidden" name="liftedPerPage" value="<%= liftedPagination.perPage %>" />
    <input type="hidden" name="userPage" value="1" />
    <input type="hidden" name="userPerPage" value="<%= bannedUsersPagination.perPage %>" />
    <input type="hidden" name="userActionPage" value="1" />
    <input type="hidden" name="userActionPerPage" value="<%= userActionPagination.perPage %>" />
    <button class="btn" data-icon="üîç" type="submit">Rechercher</button>
    <% if (searchTerm) { %>
      <a class="btn secondary" href="/admin/ip-bans">R√©initialiser</a>
    <% } %>
  </div>
</form>

<section class="card mb-xl">
  <h2>Restreindre des actions utilisateur</h2>
  <% if (canManageUserBansLocal) { %>
    <form method="post" action="/admin/ip-bans/users/actions" class="grid grid-auto">
      <%- include('../partials/csrf_field') %>
      <div>
        <label for="user-action-target">Utilisateur</label>
        <input
          id="user-action-target"
          type="text"
          name="user"
          placeholder="ID ou nom d'utilisateur"
          required
        >
      </div>
      <fieldset class="grid-span-full stack-form">
        <legend>Actions √† restreindre</legend>
        <div class="flex flex-wrap gap-sm">
          <label class="checkbox">
            <input type="checkbox" name="actions" value="global">
            <span>Wiki entier</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="actions" value="view">
            <span>Consulter les pages</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="actions" value="comment">
            <span>Publier des commentaires</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="actions" value="like">
            <span>Ajouter aux favoris</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="actions" value="react">
            <span>R√©agir aux contenus</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="actions" value="contribute">
            <span>Soumettre du contenu</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="actions" value="tag">
            <span>Acc√©der √† un tag</span>
          </label>
        </div>
      </fieldset>
      <div>
        <label for="user-action-tag">Tag (si applicable)</label>
        <input
          id="user-action-tag"
          type="text"
          name="tag"
          placeholder="ex&nbsp;: spoiler"
        >
        <p class="help-text">Indiquez un tag uniquement si l'option correspondante est coch√©e.</p>
      </div>
      <div class="grid-span-full">
        <label for="user-action-reason">Motif</label>
        <input
          id="user-action-reason"
          type="text"
          name="reason"
          placeholder="Optionnel"
        >
      </div>
      <div class="grid-span-full">
        <button class="btn warning" data-icon="üõë" type="submit">Appliquer les restrictions</button>
      </div>
    </form>
    <p class="help-text">
      Les restrictions cibl√©es permettent d'emp√™cher un compte d'effectuer certaines actions ou d'acc√©der au wiki en
      entier.
    </p>
  <% } else { %>
    <p>Vous n'avez pas la permission de restreindre des actions utilisateur.</p>
  <% } %>
</section>

<section class="card mb-xl">
  <h2>Ajouter un blocage</h2>
  <form method="post" action="/admin/ip-bans" class="grid grid-auto">
    <%- include('../partials/csrf_field') %>
    <div>
      <label for="ip">Adresse IP</label>
      <input id="ip" type="text" name="ip" required>
    </div>
    <div>
      <label for="scope">Port√©e</label>
      <select id="scope" name="scope" required>
        <option value="global">Wiki entier</option>
        <option value="view">Blocage des vues</option>
        <option value="comment">Commentaires</option>
        <option value="like">Likes</option>
        <option value="react">R√©actions</option>
        <option value="contribute">Contributions</option>
        <option value="tag">Tag sp√©cifique</option>
      </select>
    </div>
    <div>
      <label for="tag">Tag (si applicable)</label>
      <input id="tag" type="text" name="tag" placeholder="ex: spoiler">
    </div>
    <div class="grid-span-full">
      <label for="reason">Motif</label>
      <input id="reason" type="text" name="reason" placeholder="Optionnel">
    </div>
    <div class="grid-span-full">
      <button class="btn success" data-icon="üõ°Ô∏è" type="submit">Enregistrer</button>
    </div>
  </form>
  <p class="help-text">
    Pour un blocage limit√© √† une action, choisissez la port√©e correspondante (vues, commentaires, likes, r√©actions ou
    contributions). Pour interdire l'acc√®s √† un tag, indiquez "tag" puis le nom du tag.
  </p>
</section>

<section class="card mb-xl">
  <h2>Utilisateurs bannis (<%= bannedUsersPagination.totalItems %>)</h2>
  <% if (!canManageUserBansLocal) { %>
    <p>Vous n'avez pas la permission de consulter les bannissements utilisateurs.</p>
  <% } else if (!bannedUsers.length) { %>
    <p>Aucun utilisateur actuellement banni.</p>
  <% } else { %>
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nom</th>
            <th>Pseudo</th>
            <th>Motif</th>
            <th>Banni le</th>
            <th>Par</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% bannedUsers.forEach(user => { %>
            <% const bannedUserRole = user.userRole || null; %>
            <% const bannedUserColor = bannedUserRole && bannedUserRole.color ? bannedUserRole.color : null; %>
            <% const bannedUserClasses = ['user-handle']; %>
            <% const bannedUserStyle = bannedUserColor && bannedUserColor.hasColor ? bannedUserColor.style : ''; %>
            <% if (bannedUserColor && bannedUserColor.hasColor) { bannedUserClasses.push('role-colored-text'); bannedUserClasses.push(bannedUserColor.className); } %>
            <% const bannedUserBadges = Array.isArray(bannedUserRole?.badges) ? bannedUserRole.badges : []; %>
            <tr>
              <td><%= user.id %></td>
              <td>
                <span class="user-handle-decorated">
                  <strong class="<%= bannedUserClasses.join(' ') %>" style="<%= bannedUserStyle %>"><%= user.username %></strong>
                  <%- include('../partials/userBadges', {
                    badges: bannedUserBadges,
                    listClass: ['user-handle-badges', 'user-handle-badges--inline'],
                    itemClass: 'user-handle-badge-item',
                    iconClass: 'user-handle-badge-icon',
                    srOnlyClass: 'sr-only',
                    ariaLabel: "Badges de l'utilisateur",
                  }) %>
                </span>
              </td>
              <td><%= user.display_name || '-' %></td>
              <td><%= user.ban_reason || '-' %></td>
              <td><%= user.banned_at ? new Date(user.banned_at).toLocaleString('fr-FR') : '-' %></td>
              <td><%= user.banned_by || '-' %></td>
              <td>
                <form
                  method="post"
                  action="/admin/users/<%= user.id %>/unban"
                  onsubmit="return confirm('D√©bannir <%= user.username %> ?');"
                >
                  <%- include('../partials/csrf_field') %>
                  <button class="btn success" data-icon="üóùÔ∏è" type="submit">D√©bannir</button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <%- include('./paginationControls', { pagination: bannedUsersPagination }) %>
  <% } %>
</section>

<section class="card mb-xl">
  <h2>Restrictions cibl√©es (<%= userActionPagination.totalItems %>)</h2>
  <% if (!canManageUserBansLocal) { %>
    <p>Vous n'avez pas la permission de consulter ces restrictions.</p>
  <% } else if (!userActionBans.length) { %>
    <p>Aucune restriction utilisateur active.</p>
  <% } else { %>
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Utilisateur</th>
            <th>Type</th>
            <th>Valeur</th>
            <th>Motif</th>
            <th>Cr√©√©e</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% userActionBans.forEach(ban => { %>
            <% const userLabel = ban.username ? ban.username : (ban.user_id ? `Utilisateur #${ban.user_id}` : 'Compte supprim√©'); %>
            <% const typeLabel = ban.scope === 'global' ? 'Wiki entier' : (ban.scope === 'tag' ? 'Tag' : 'Action'); %>
            <% const valueLabel = ban.scope === 'global' ? '‚Äî' : (ban.value || (ban.scope === 'tag' ? '-' : '‚Äî')); %>
            <tr>
              <td><%= ban.snowflake_id %></td>
              <td><%= userLabel %></td>
              <td><%= typeLabel %></td>
              <td><%= valueLabel %></td>
              <td><%= ban.reason || '-' %></td>
              <td><%= new Date(ban.created_at).toLocaleString('fr-FR') %></td>
              <td>
                <div class="flex flex-col gap-xs">
                  <% if (!ban.lifted_at) { %>
                    <form
                      method="post"
                      action="/admin/ip-bans/users/actions/<%= ban.snowflake_id %>/lift"
                      onsubmit="return confirm('Lever cette restriction ?');"
                    >
                      <%- include('../partials/csrf_field') %>
                      <button class="btn secondary" data-icon="üóùÔ∏è" type="submit">Lever</button>
                    </form>
                  <% } %>
                  <form
                    method="post"
                    action="/admin/ip-bans/users/actions/<%= ban.snowflake_id %>/delete"
                    onsubmit="return confirm('Supprimer d√©finitivement cette restriction ?');"
                  >
                    <%- include('../partials/csrf_field') %>
                    <button class="btn danger" data-icon="üóëÔ∏è" type="submit">Supprimer</button>
                  </form>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <%- include('./paginationControls', { pagination: userActionPagination }) %>
  <% } %>
</section>

<section class="card">
  <h2>Blocages actifs (<%= activePagination.totalItems %>)</h2>
  <% if (!activeBans.length) { %>
    <p>Aucun blocage actif.</p>
  <% } else { %>
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th>
            <th>IP</th>
            <th>Type</th>
            <th>Valeur</th>
            <th>Motif</th>
            <th>Cr√©√©</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% activeBans.forEach(ban => { %>
            <tr>
              <td><%= ban.snowflake_id %></td>
              <td><code><%= ban.ip %></code></td>
              <td><%= ban.scope %></td>
              <td><%= ban.value || '-' %></td>
              <td><%= ban.reason || '-' %></td>
              <td><%= new Date(ban.created_at).toLocaleString('fr-FR') %></td>
              <td>
                <div class="flex flex-col gap-xs">
                  <form
                    method="post"
                    action="/admin/ip-bans/<%= ban.snowflake_id %>/lift"
                    onsubmit="return confirm('Lever ce blocage ?');"
                  >
                    <%- include('../partials/csrf_field') %>
                    <button class="btn secondary" data-icon="üóùÔ∏è" type="submit">Lever</button>
                  </form>
                  <form
                    method="post"
                    action="/admin/ip-bans/<%= ban.snowflake_id %>/delete"
                    onsubmit="return confirm('Supprimer d√©finitivement ce blocage ?');"
                  >
                    <%- include('../partials/csrf_field') %>
                    <button class="btn danger" data-icon="üóëÔ∏è" type="submit">Supprimer</button>
                  </form>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <%- include('./paginationControls', { pagination: activePagination }) %>
  <% } %>
</section>

<section class="card">
  <h2>Blocages lev√©s (<%= liftedPagination.totalItems %>)</h2>
  <% if (!liftedBans.length) { %>
    <p>Aucun blocage lev√© enregistr√©.</p>
  <% } else { %>
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th>
            <th>IP</th>
            <th>Type</th>
            <th>Valeur</th>
            <th>Motif</th>
            <th>Cr√©√©</th>
            <th>Lev√©e</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% liftedBans.forEach(ban => { %>
            <tr>
              <td><%= ban.snowflake_id %></td>
              <td><code><%= ban.ip %></code></td>
              <td><%= ban.scope %></td>
              <td><%= ban.value || '-' %></td>
              <td><%= ban.reason || '-' %></td>
              <td><%= new Date(ban.created_at).toLocaleString('fr-FR') %></td>
              <td><%= new Date(ban.lifted_at).toLocaleString('fr-FR') %></td>
              <td>
                <form
                  method="post"
                  action="/admin/ip-bans/<%= ban.snowflake_id %>/delete"
                  onsubmit="return confirm('Supprimer d√©finitivement ce blocage ?');"
                >
                  <%- include('../partials/csrf_field') %>
                  <button class="btn danger" data-icon="üóëÔ∏è" type="submit">Supprimer</button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <%- include('./paginationControls', { pagination: liftedPagination }) %>
  <% } %>
</section>

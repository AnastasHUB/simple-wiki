<% title='R√¥les'; %>
<h1>Gestion des r√¥les</h1>
<p class="text-muted">Cr√©ez de nouveaux r√¥les et ajustez leurs permissions. Les utilisateurs associ√©s h√©ritent automatiquement des permissions de leur r√¥le.</p>

<section class="card mb-lg">
  <h2 class="h3">Nouveau r√¥le</h2>
  <form method="post" class="grid gap-md" aria-label="Cr√©er un nouveau r√¥le">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-md">
      <label class="stack-form">
        <span class="text-sm text-muted">Nom du r√¥le <span aria-hidden="true">*</span></span>
        <input type="text" name="name" placeholder="Nom" required maxlength="80" />
      </label>
      <label class="stack-form">
        <span class="text-sm text-muted">Description</span>
        <input type="text" name="description" placeholder="Description courte" maxlength="160" />
      </label>
    </div>
    <fieldset class="stack-form">
      <legend class="text-sm text-muted">Permissions</legend>
      <div class="flex flex-wrap gap-md">
        <label class="checkbox">
          <input type="checkbox" name="is_admin" value="1" />
          <span>Administrateur (acc√®s complet)</span>
        </label>
        <label class="checkbox">
          <input type="checkbox" name="is_moderator" value="1" />
          <span>Mod√©rateur (mod√©ration des contenus)</span>
        </label>
        <label class="checkbox">
          <input type="checkbox" name="can_comment" value="1" />
          <span>Commenter des articles</span>
        </label>
        <label class="checkbox">
          <input type="checkbox" name="can_submit_pages" value="1" />
          <span>Soumettre des contributions</span>
        </label>
        <label class="checkbox">
          <input type="checkbox" name="is_contributor" value="1" />
          <span>Publier directement des articles</span>
        </label>
        <label class="checkbox">
          <input type="checkbox" name="is_helper" value="1" />
          <span>Commentaires sans mod√©ration</span>
        </label>
      </div>
    </fieldset>
    <button class="btn success" type="submit" data-icon="‚ûï">Cr√©er le r√¥le</button>
  </form>
</section>

<section class="grid gap-md">
  <% if (!roles || !roles.length) { %>
    <p class="card">Aucun r√¥le d√©fini pour le moment.</p>
  <% } else { %>
    <% roles.forEach(role => { %>
      <article class="card">
        <div class="flex flex-wrap items-center justify-between gap-sm">
          <div>
            <h2 class="h3"><%= role.name %></h2>
            <% if (role.description) { %>
              <p class="text-muted"><%= role.description %></p>
            <% } %>
            <% if (role.is_system) { %>
              <p class="text-xs text-muted">R√¥le syst√®me prot√©g√©</p>
            <% } %>
          </div>
          <span class="badge"><%= role.userCount || 0 %> utilisateur<%= (role.userCount || 0) > 1 ? 's' : '' %></span>
        </div>
        <form method="post" action="/admin/roles/<%= role.id %>" class="mt-md" aria-label="Mettre √† jour les permissions pour <%= role.name %>">
          <fieldset class="stack-form">
            <legend class="text-sm text-muted">Permissions</legend>
            <div class="flex flex-wrap gap-md">
              <label class="checkbox">
                <input type="checkbox" name="is_admin" value="1" <%= role.is_admin ? 'checked' : '' %> />
                <span>Administrateur</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" name="is_moderator" value="1" <%= role.is_moderator ? 'checked' : '' %> />
                <span>Mod√©rateur</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" name="can_comment" value="1" <%= role.can_comment ? 'checked' : '' %> />
                <span>Commenter</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" name="can_submit_pages" value="1" <%= role.can_submit_pages ? 'checked' : '' %> />
                <span>Soumettre des contenus</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" name="is_contributor" value="1" <%= role.is_contributor ? 'checked' : '' %> />
                <span>Publier des articles</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" name="is_helper" value="1" <%= role.is_helper ? 'checked' : '' %> />
                <span>Commentaires sans mod√©ration</span>
              </label>
            </div>
          </fieldset>
          <button class="btn secondary" type="submit" data-icon="üíæ">Enregistrer</button>
        </form>
        <% if (!role.is_system && (role.name || '').toLowerCase() !== 'everyone') { %>
          <div class="mt-xs"></div>
          <% if ((role.userCount || 0) === 0) { %>
            <form method="post" action="/admin/roles/<%= role.id %>" class="flex justify-end mt-xs" aria-label="Supprimer le r√¥le <%= role.name %>">
              <input type="hidden" name="_action" value="delete" />
              <button class="btn danger" type="submit" data-icon="üóëÔ∏è" onclick="return confirm('Supprimer d√©finitivement ce r√¥le ?');">Supprimer le r√¥le</button>
            </form>
          <% } else { %>
            <div class="mt-xs">
              <p class="text-sm text-muted">
                Ce r√¥le est actuellement attribu√© √† <strong><%= role.userCount %></strong>
                utilisateur<%= role.userCount > 1 ? 's' : '' %>. R√©assignez-les vers Everyone pour pouvoir supprimer ce r√¥le.
              </p>
              <form method="post" action="/admin/roles/<%= role.id %>" class="flex flex-wrap gap-sm mt-xs" aria-label="R√©assigner les utilisateurs de <%= role.name %> vers Everyone">
                <input type="hidden" name="_action" value="reassign_to_everyone" />
                <button class="btn secondary" type="submit" data-icon="üîÅ">R√©assigner tous les utilisateurs vers Everyone</button>
              </form>
            </div>
          <% } %>
        <% } %>
      </article>
    <% }) %>
  <% } %>
</section>

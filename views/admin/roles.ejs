<% title='R√¥les'; %>
<h1>Gestion des r√¥les</h1>
<p class="text-muted">Cr√©ez de nouveaux r√¥les et ajustez leurs permissions. Les utilisateurs associ√©s h√©ritent automatiquement des permissions de leur r√¥le.</p>

<section class="card mb-lg">
  <h2 class="h3">Nouveau r√¥le</h2>
  <form method="post" class="role-editor" aria-label="Cr√©er un nouveau r√¥le">
    <div class="role-summary">
      <label class="form-field">
        <span class="field-label">Nom du r√¥le <span aria-hidden="true">*</span></span>
        <input type="text" name="name" placeholder="Nom" required maxlength="80" />
      </label>
      <label class="form-field">
        <span class="field-label">Description</span>
        <input type="text" name="description" placeholder="Description courte" maxlength="160" />
      </label>
    </div>
    <div class="role-permissions-column">
      <fieldset class="role-permissions">
        <legend>Permissions</legend>
        <div class="role-permissions-grid">
          <label class="checkbox">
            <input type="checkbox" name="is_admin" value="1" />
            <span>Administrateur (acc√®s complet)</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="is_moderator" value="1" />
            <span>Mod√©rateur (mod√©ration des contenus)</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="can_comment" value="1" />
            <span>Commenter des articles</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="can_submit_pages" value="1" />
            <span>Soumettre des contributions</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="is_contributor" value="1" />
            <span>Publier directement des articles</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="is_helper" value="1" />
            <span>Commentaires sans mod√©ration</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="can_moderate_comments" value="1" />
            <span>Mod√©rer les commentaires</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="can_review_submissions" value="1" />
            <span>Revoir les contributions</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="can_manage_pages" value="1" />
            <span>G√©rer les articles</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="can_view_stats" value="1" />
            <span>Voir les statistiques</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="can_manage_users" value="1" />
            <span>G√©rer les utilisateurs</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="can_manage_roles" value="1" />
            <span>G√©rer les r√¥les</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="can_manage_likes" value="1" />
            <span>G√©rer les likes</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="can_manage_trash" value="1" />
            <span>G√©rer la corbeille</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="can_manage_uploads" value="1" />
            <span>G√©rer les images</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="can_manage_settings" value="1" />
            <span>Modifier les param√®tres</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="can_manage_ip_bans" value="1" />
            <span>G√©rer les blocages IP</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="can_manage_ip_reputation" value="1" />
            <span>G√©rer la r√©putation IP</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="can_manage_ip_profiles" value="1" />
            <span>G√©rer les profils IP</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="can_review_ban_appeals" value="1" />
            <span>Examiner les demandes de d√©ban</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="can_view_events" value="1" />
            <span>Voir les √©v√©nements</span>
          </label>
          <label class="checkbox">
            <input type="checkbox" name="can_view_snowflakes" value="1" />
            <span>Voir les identifiants Snowflake</span>
          </label>
        </div>
      </fieldset>
      <div class="role-actions">
        <button class="btn success" type="submit" data-icon="‚ûï">Cr√©er le r√¥le</button>
      </div>
    </div>
  </form>
</section>

<section class="role-manager">
  <% if (!roles || !roles.length) { %>
    <p class="card">Aucun r√¥le d√©fini pour le moment.</p>
  <% } else { %>
    <aside class="role-sidebar card" aria-label="R√¥les disponibles">
      <div class="role-sidebar-header">
        <h2 class="h3">R√¥les existants</h2>
        <p class="text-sm text-muted">S√©lectionnez un r√¥le pour afficher et modifier ses permissions.</p>
      </div>
      <ul class="role-selector" role="list">
        <% roles.forEach((role, index) => { %>
          <li>
            <button
              type="button"
              class="role-choice <%= index === 0 ? 'is-active' : '' %>"
              data-role-id="<%= role.id %>"
              aria-pressed="<%= index === 0 ? 'true' : 'false' %>"
            >
              <span class="role-choice-name"><%= role.name %></span>
              <span class="badge"><%= role.userCount || 0 %> utilisateur<%= (role.userCount || 0) > 1 ? 's' : '' %></span>
            </button>
          </li>
        <% }) %>
      </ul>
    </aside>
    <div class="role-detail">
      <% roles.forEach((role, index) => { %>
        <article class="card role-detail-panel" data-role-id="<%= role.id %>" <%= index === 0 ? '' : 'hidden' %>>
          <div class="role-editor">
            <div class="role-summary">
              <div class="role-summary-header">
                <h2 class="h3"><%= role.name %></h2>
                <span class="badge"><%= role.userCount || 0 %> utilisateur<%= (role.userCount || 0) > 1 ? 's' : '' %></span>
              </div>
              <% if (role.description) { %>
                <p class="text-muted"><%= role.description %></p>
              <% } %>
              <% if (role.is_system) { %>
                <p class="text-xs text-muted">R√¥le syst√®me prot√©g√©</p>
              <% } %>
              <% if (!role.is_system && (role.name || '').toLowerCase() !== 'everyone') { %>
                <div class="role-summary-footer">
                  <% if ((role.userCount || 0) === 0) { %>
                    <form method="post" action="/admin/roles/<%= role.id %>" aria-label="Supprimer le r√¥le <%= role.name %>">
                      <input type="hidden" name="_action" value="delete" />
                      <button class="btn danger" type="submit" data-icon="üóëÔ∏è" onclick="return confirm('Supprimer d√©finitivement ce r√¥le ?');">Supprimer le r√¥le</button>
                    </form>
                  <% } else { %>
                    <p class="text-sm text-muted">
                      Ce r√¥le est actuellement attribu√© √† <strong><%= role.userCount %></strong>
                      utilisateur<%= role.userCount > 1 ? 's' : '' %>. R√©assignez-les vers Everyone pour pouvoir supprimer ce r√¥le.
                    </p>
                    <form method="post" action="/admin/roles/<%= role.id %>" class="role-reassign-form" aria-label="R√©assigner les utilisateurs de <%= role.name %> vers Everyone">
                      <input type="hidden" name="_action" value="reassign_to_everyone" />
                      <button class="btn secondary" type="submit" data-icon="üîÅ">R√©assigner tous les utilisateurs vers Everyone</button>
                    </form>
                  <% } %>
                </div>
              <% } %>
            </div>
            <form method="post" action="/admin/roles/<%= role.id %>" class="role-permissions-column" aria-label="Mettre √† jour les permissions pour <%= role.name %>">
              <fieldset class="role-permissions">
                <legend>Permissions</legend>
                <div class="role-permissions-grid">
                  <label class="checkbox">
                    <input type="checkbox" name="is_admin" value="1" <%= role.is_admin ? 'checked' : '' %> />
                    <span>Administrateur</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="is_moderator" value="1" <%= role.is_moderator ? 'checked' : '' %> />
                    <span>Mod√©rateur</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="can_comment" value="1" <%= role.can_comment ? 'checked' : '' %> />
                    <span>Commenter</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="can_submit_pages" value="1" <%= role.can_submit_pages ? 'checked' : '' %> />
                    <span>Soumettre des contenus</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="is_contributor" value="1" <%= role.is_contributor ? 'checked' : '' %> />
                    <span>Publier des articles</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="is_helper" value="1" <%= role.is_helper ? 'checked' : '' %> />
                    <span>Commentaires sans mod√©ration</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="can_moderate_comments" value="1" <%= role.can_moderate_comments ? 'checked' : '' %> />
                    <span>Mod√©rer les commentaires</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="can_review_submissions" value="1" <%= role.can_review_submissions ? 'checked' : '' %> />
                    <span>Revoir les contributions</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="can_manage_pages" value="1" <%= role.can_manage_pages ? 'checked' : '' %> />
                    <span>G√©rer les articles</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="can_view_stats" value="1" <%= role.can_view_stats ? 'checked' : '' %> />
                    <span>Voir les statistiques</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="can_manage_users" value="1" <%= role.can_manage_users ? 'checked' : '' %> />
                    <span>G√©rer les utilisateurs</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="can_manage_roles" value="1" <%= role.can_manage_roles ? 'checked' : '' %> />
                    <span>G√©rer les r√¥les</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="can_manage_likes" value="1" <%= role.can_manage_likes ? 'checked' : '' %> />
                    <span>G√©rer les likes</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="can_manage_trash" value="1" <%= role.can_manage_trash ? 'checked' : '' %> />
                    <span>G√©rer la corbeille</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="can_manage_uploads" value="1" <%= role.can_manage_uploads ? 'checked' : '' %> />
                    <span>G√©rer les images</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="can_manage_settings" value="1" <%= role.can_manage_settings ? 'checked' : '' %> />
                    <span>Modifier les param√®tres</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="can_manage_ip_bans" value="1" <%= role.can_manage_ip_bans ? 'checked' : '' %> />
                    <span>G√©rer les blocages IP</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="can_manage_ip_reputation" value="1" <%= role.can_manage_ip_reputation ? 'checked' : '' %> />
                    <span>G√©rer la r√©putation IP</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="can_manage_ip_profiles" value="1" <%= role.can_manage_ip_profiles ? 'checked' : '' %> />
                    <span>G√©rer les profils IP</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="can_review_ban_appeals" value="1" <%= role.can_review_ban_appeals ? 'checked' : '' %> />
                    <span>Examiner les demandes de d√©ban</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="can_view_events" value="1" <%= role.can_view_events ? 'checked' : '' %> />
                    <span>Voir les √©v√©nements</span>
                  </label>
                  <label class="checkbox">
                    <input type="checkbox" name="can_view_snowflakes" value="1" <%= role.can_view_snowflakes ? 'checked' : '' %> />
                    <span>Voir les identifiants Snowflake</span>
                  </label>
                </div>
              </fieldset>
              <div class="role-actions">
                <button class="btn secondary" type="submit" data-icon="üíæ">Enregistrer</button>
              </div>
            </form>
          </div>
        </article>
      <% }) %>
    </div>
  <% } %>
</section>

<script>
  (function () {
    const manager = document.querySelector('.role-manager');
    if (!manager) {
      return;
    }

    const buttons = Array.from(manager.querySelectorAll('.role-choice'));
    const panels = Array.from(manager.querySelectorAll('.role-detail-panel'));

    if (!buttons.length || !panels.length) {
      return;
    }

    const setActive = (roleId) => {
      buttons.forEach((button) => {
        const isActive = button.dataset.roleId === roleId;
        button.classList.toggle('is-active', isActive);
        button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });

      panels.forEach((panel) => {
        panel.hidden = panel.dataset.roleId !== roleId;
      });
    };

    buttons.forEach((button) => {
      button.addEventListener('click', () => {
        setActive(button.dataset.roleId);
      });
    });
  })();
</script>

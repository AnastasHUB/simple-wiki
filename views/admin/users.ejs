<% title='Utilisateurs'; %>
<h1>Utilisateurs (admins uniquement)</h1>
<form method="get" class="card mb-md">
  <div class="flex flex-wrap gap-sm items-end">
    <label class="stack-form">
      <span class="text-sm text-muted">Rechercher</span>
      <input
        type="text"
        name="search"
        value="<%= typeof searchTerm === 'string' ? searchTerm : '' %>"
        placeholder="ID, nom, pseudo‚Ä¶"
        class="flex-basis-260"
      />
    </label>
    <input type="hidden" name="page" value="1" />
    <input type="hidden" name="perPage" value="<%= pagination.perPage %>" />
    <button class="btn" data-icon="üîç" type="submit">Rechercher</button>
    <% if (searchTerm) { %>
      <a class="btn secondary" href="/admin/users">R√©initialiser</a>
    <% } %>
  </div>
</form>
<form method="post" class="card">
  <div class="flex flex-wrap gap-sm items-end">
    <label class="stack-form">
      <span class="text-sm text-muted">Nom d'utilisateur</span>
      <input type="text" name="username" placeholder="nouvel utilisateur" required />
    </label>
    <label class="stack-form">
      <span class="text-sm text-muted">Mot de passe</span>
      <input type="password" name="password" placeholder="mot de passe" required />
    </label>
    <label class="stack-form">
      <span class="text-sm text-muted">R√¥le</span>
      <select name="role">
        <option value="admin">Administrateur</option>
        <option value="moderator">Mod√©rateur</option>
        <option value="contributor">Contributeur</option>
        <option value="helper">Helper</option>
      </select>
    </label>
    <button class="btn success" data-icon="‚ûï" type="submit">Ajouter</button>
  </div>
</form>
<% if (!users.length) { %>
  <p class="card mt-md">Aucun utilisateur trouv√©.</p>
<% } else { %>
  <div class="table-wrap mt-md">
    <table class="data-table">
      <thead>
        <tr><th>ID</th><th>Nom</th><th>Pseudo commentaire</th><th>R√¥le</th><th>Actions</th></tr>
      </thead>
      <tbody>
      <% users.forEach(u=>{ %>
        <tr>
          <td><%= u.id %></td>
          <td><%= u.username %></td>
          <td>
            <form method="post" action="/admin/users/<%= u.id %>/display-name" class="flex gap-sm items-center">
              <input
                type="text"
                name="displayName"
                maxlength="80"
                value="<%= u.display_name || '' %>"
                placeholder="Nom affich√©"
                aria-label="Pseudo pour <%= u.username %>"
                class="flex-basis-220"
              />
              <button class="btn secondary" data-icon="üíæ" type="submit">Enregistrer</button>
            </form>
          </td>
          <td>
            <%= u.is_admin
              ? 'Admin'
              : (u.is_moderator
                ? 'Mod√©rateur'
                : (u.is_contributor
                  ? 'Contributeur'
                  : (u.is_helper ? 'Helper' : 'Utilisateur')))
            %>
          </td>
          <td>
            <div class="flex flex-wrap gap-sm items-center">
              <form method="post" action="/admin/users/<%= u.id %>/role" class="flex gap-sm items-center">
                <label class="sr-only" for="role-<%= u.id %>">R√¥le</label>
                <select id="role-<%= u.id %>" name="role">
                  <option value="" disabled <%= !u.is_admin && !u.is_moderator && !u.is_contributor && !u.is_helper ? 'selected' : '' %>>S√©lectionner un r√¥le‚Ä¶</option>
                  <option value="admin" <%= u.is_admin ? 'selected' : '' %>>Administrateur</option>
                  <option value="moderator" <%= u.is_moderator && !u.is_admin ? 'selected' : '' %>>Mod√©rateur</option>
                  <option value="contributor" <%= u.is_contributor && !u.is_admin && !u.is_moderator ? 'selected' : '' %>>Contributeur</option>
                  <option value="helper" <%= u.is_helper && !u.is_admin && !u.is_moderator && !u.is_contributor ? 'selected' : '' %>>Helper</option>
                </select>
                <button class="btn secondary" data-icon="‚≠ê" type="submit">Choisir le r√¥le</button>
              </form>
              <form method="post" action="/admin/users/<%= u.id %>/delete" onsubmit="return confirm('Supprimer cet utilisateur ?')">
                <button class="btn danger" data-icon="üóëÔ∏è">Supprimer</button>
              </form>
            </div>
          </td>
        </tr>
      <% }) %>
      </tbody>
    </table>
  </div>
  <%- include('./paginationControls', { pagination }) %>
<% } %>

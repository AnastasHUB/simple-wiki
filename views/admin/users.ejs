<% title = t('admin.users.title'); %>
<h1><%= t('admin.users.heading') %></h1>
<form method="get" class="card mb-md">
  <div class="flex flex-wrap gap-sm items-end">
    <label class="stack-form">
      <span class="text-sm text-muted"><%= t('admin.users.search.label') %></span>
      <input
        type="text"
        name="search"
        value="<%= typeof searchTerm === 'string' ? searchTerm : '' %>"
        placeholder="<%= t('admin.users.search.placeholder') %>"
        class="flex-basis-260"
      />
    </label>
    <input type="hidden" name="page" value="1" />
    <input type="hidden" name="perPage" value="<%= pagination.perPage %>" />
    <button class="btn" type="submit"><%= t('admin.users.search.button') %></button>
    <% if (searchTerm) { %>
      <a class="btn secondary" href="/admin/users"><%= t('admin.users.search.reset') %></a>
    <% } %>
  </div>
</form>
<form method="post" class="card">
  <%- include('../partials/csrf_field') %>
  <div class="flex flex-wrap gap-sm items-end">
    <label class="stack-form">
      <span class="text-sm text-muted"><%= t('admin.users.fields.username') %></span>
      <input type="text" name="username" placeholder="<%= t('admin.users.placeholders.newUsername') %>" required />
    </label>
    <label class="stack-form">
      <span class="text-sm text-muted"><%= t('admin.users.fields.password') %></span>
      <input type="password" name="password" placeholder="<%= t('admin.users.placeholders.password') %>" required />
    </label>
    <label class="stack-form">
      <span class="text-sm text-muted"><%= t('admin.users.fields.roles') %></span>
      <% if (Array.isArray(roles) && roles.length) { %>
        <select name="roleIds" multiple size="<%= Math.min(roles.length, 5) %>">
          <% roles.forEach(role => { %>
            <option value="<%= role.id %>" <%= defaultRoleId && role.id === defaultRoleId ? 'selected' : '' %>><%= role.name %></option>
          <% }) %>
        </select>
        <small class="text-xs text-muted"><%= t('admin.users.hints.multiSelect') %></small>
      <% } else { %>
        <span class="text-danger"><%= t('admin.users.hints.noRoles') %></span>
      <% } %>
    </label>
    <button class="btn success" type="submit"><%= t('admin.users.actions.add') %></button>
  </div>
  
</form>
<% if (!users.length) { %>
  <p class="card mt-md"><%= t('admin.users.empty') %></p>
<% } else { %>
  <div class="table-wrap mt-md">
    <table class="data-table">
      <thead>
        <tr>
          <th><%= t('admin.users.table.id') %></th>
          <th><%= t('admin.users.table.name') %></th>
          <th><%= t('admin.users.table.commentAlias') %></th>
          <th><%= t('admin.users.table.role') %></th>
          <th><%= t('admin.users.table.status') %></th>
          <th><%= t('admin.users.table.ipProfiles') %></th>
          <th><%= t('admin.users.table.actions') %></th>
        </tr>
      </thead>
      <tbody>
      <% users.forEach(u=>{ %>
        <tr>
          <td><%= u.id %></td>
          <% const usernameColor = u.role_color || null; %>
          <% const usernameClasses = ['user-handle']; %>
          <% const usernameStyle = usernameColor && usernameColor.hasColor ? usernameColor.style : ''; %>
          <% if (usernameColor && usernameColor.hasColor) { usernameClasses.push('role-colored-text'); usernameClasses.push(usernameColor.className); } %>
          <% const usernameBadges = Array.isArray(u?.badges) ? u.badges : []; %>
          <td>
            <span class="user-handle-decorated">
              <strong class="<%= usernameClasses.join(' ') %>" style="<%= usernameStyle %>"><%= u.username %></strong>
              <%- include('../partials/userBadges', {
                badges: usernameBadges,
                listClass: ['user-handle-badges', 'user-handle-badges--inline'],
                itemClass: 'user-handle-badge-item',
                iconClass: 'user-handle-badge-icon',
                srOnlyClass: 'sr-only',
                ariaLabel: t('common.authorBadgesAria'),
              }) %>
            </span>
          </td>
          <td>
            <form method="post" action="/admin/users/<%= u.id %>/display-name" class="flex gap-sm items-center">
              <%- include('../partials/csrf_field') %>
              <input
                type="text"
                name="displayName"
                maxlength="80"
                value="<%= u.display_name || '' %>"
                placeholder="<%= t('admin.users.fields.displayName') %>"
                aria-label="<%= t('admin.users.aria.displayNameFor', { user: u.username }) %>"
                class="flex-basis-220"
              />
              <button class="btn secondary" type="submit"><%= t('admin.users.actions.save') %></button>
            </form>
          </td>
          <td>
            <% if (Array.isArray(u.roles) && u.roles.length) { %>
              <ul class="flex flex-wrap gap-xs list-unstyled">
                <% u.roles.forEach(function(role) { %>
                  <li><span class="badge"><%= role.name %></span></li>
                <% }) %>
              </ul>
            <% } else { %>
              <span><%= u.role_label %></span>
            <% } %>
          </td>
          <td>
            <% if (u.is_banned) { %>
              <span class="text-danger"><%= t('admin.users.status.banned') %></span>
              <% if (u.ban_reason) { %>
                <br /><small><%= t('admin.users.status.reasonPrefix') %> <%= u.ban_reason %></small>
              <% } %>
              <% if (u.banned_at) { %>
                <br /><small><%= t('admin.users.status.since') %> <%= fmt.dateTime(u.banned_at) %></small>
              <% } %>
            <% } else { %>
              <span><%= t('admin.users.status.active') %></span>
            <% } %>
          </td>
          <td>
            <% if (Array.isArray(u.ipProfiles) && u.ipProfiles.length) { %>
              <ul>
                <% u.ipProfiles.forEach(function (ipProfile) { %>
                  <li>
                    <a href="/profiles/ip/<%= encodeURIComponent(ipProfile.hash) %>"><%= t('admin.users.ipProfiles.profileN', { n: ipProfile.shortHash || '?' }) %></a>
                    <% if (ipProfile.claimedAt) { %>
                      <span class="text-muted">â€” <%= fmt.date(ipProfile.claimedAt) %></span>
                    <% } %>
                    <% if (permissions.can_manage_ip_profiles) { %>
                      <form
                        method="post"
                        action="/admin/users/<%= u.id %>/ip-profiles/<%= encodeURIComponent(ipProfile.hash) %>/unlink"
                        onsubmit="return confirm(t('admin.users.ipProfiles.unlinkConfirm', { user: u.username }))"
                      >
                        <%- include('../partials/csrf_field') %>
                        <button class="btn danger" type="submit"><%= t('admin.users.actions.remove') %></button>
                      </form>
                    <% } %>
                  </li>
                <% }) %>
              </ul>
            <% } else { %>
              <span class="text-muted"><%= t('admin.users.ipProfiles.none') %></span>
            <% } %>
            <% if (permissions.can_manage_ip_profiles) { %>
              <form
                method="post"
                action="/admin/users/<%= u.id %>/ip-profiles/link"
                class="flex flex-wrap gap-sm items-center mt-sm"
              >
                <%- include('../partials/csrf_field') %>
                <input
                  type="text"
                  name="hash"
                  placeholder="<%= t('admin.users.ipProfiles.hashPlaceholder') %>"
                  class="flex-basis-200"
                  required
                />
                <label class="text-sm">
                  <input type="checkbox" name="force" value="1" /> <%= t('admin.users.ipProfiles.force') %>
                </label>
                <button class="btn secondary" type="submit"><%= t('admin.users.ipProfiles.link') %></button>
              </form>
            <% } %>
          </td>
          <td>
            <div class="flex flex-wrap gap-sm items-center">
              <form method="post" action="/admin/users/<%= u.id %>/role" class="flex gap-sm items-center">
                <%- include('../partials/csrf_field') %>
                <label class="sr-only" for="role-<%= u.id %>"><%= t('admin.users.fields.role') %></label>
                <% if (Array.isArray(roles) && roles.length) { %>
                  <select id="role-<%= u.id %>" name="roleIds" multiple size="<%= Math.min(roles.length, 5) %>">
                    <% roles.forEach(role => { %>
                      <% const hasRole = Array.isArray(u.roles) && u.roles.some((assigned) => assigned.id === role.id); %>
                      <option value="<%= role.id %>" <%= hasRole ? 'selected' : '' %>><%= role.name %></option>
                    <% }) %>
                  </select>
                  <small class="text-xs text-muted"><%= t('admin.users.hints.multiToggle') %></small>
                <% } else { %>
                  <span class="text-danger"><%= t('admin.users.hints.noRoleSingle') %></span>
                <% } %>
                <button class="btn secondary" type="submit"><%= t('admin.users.actions.updateRoles') %></button>
              </form>
              <% if (permissions.can_suspend_users && u.is_banned) { %>
                <form method="post" action="/admin/users/<%= u.id %>/unban" class="flex gap-sm items-center">
                  <%- include('../partials/csrf_field') %>
                  <button class="btn success" type="submit"><%= t('admin.users.actions.unban') %></button>
                </form>
              <% } %>
              <form method="post" action="/admin/users/<%= u.id %>/delete" onsubmit="return confirm(t('admin.users.actions.deleteConfirm'))">
                <%- include('../partials/csrf_field') %>
                <button class="btn danger"><%= t('admin.users.actions.delete') %></button>
              </form>
            </div>
          </td>
        </tr>
      <% }) %>
      </tbody>
    </table>
  </div>
  <%- include('./paginationControls', { pagination }) %>
<% } %>


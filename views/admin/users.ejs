<% title='Utilisateurs'; %>
<h1>Utilisateurs (admins uniquement)</h1>
<form method="get" class="card mb-md">
  <div class="flex flex-wrap gap-sm items-end">
    <label class="stack-form">
      <span class="text-sm text-muted">Rechercher</span>
      <input
        type="text"
        name="search"
        value="<%= typeof searchTerm === 'string' ? searchTerm : '' %>"
        placeholder="ID, nom, pseudo‚Ä¶"
        class="flex-basis-260"
      />
    </label>
    <input type="hidden" name="page" value="1" />
    <input type="hidden" name="perPage" value="<%= pagination.perPage %>" />
    <button class="btn" data-icon="üîç" type="submit">Rechercher</button>
    <% if (searchTerm) { %>
      <a class="btn secondary" href="/admin/users">R√©initialiser</a>
    <% } %>
  </div>
</form>
<form method="post" class="card">
  <%- include('../partials/csrf_field') %>
  <div class="flex flex-wrap gap-sm items-end">
    <label class="stack-form">
      <span class="text-sm text-muted">Nom d'utilisateur</span>
      <input type="text" name="username" placeholder="nouvel utilisateur" required />
    </label>
    <label class="stack-form">
      <span class="text-sm text-muted">Mot de passe</span>
      <input type="password" name="password" placeholder="mot de passe" required />
    </label>
    <label class="stack-form">
      <span class="text-sm text-muted">R√¥les</span>
      <% if (Array.isArray(roles) && roles.length) { %>
        <select name="roleIds" multiple size="<%= Math.min(roles.length, 5) %>">
          <% roles.forEach(role => { %>
            <option value="<%= role.id %>" <%= defaultRoleId && role.id === defaultRoleId ? 'selected' : '' %>><%= role.name %></option>
          <% }) %>
        </select>
        <small class="text-xs text-muted">Maintenez Ctrl ou Cmd pour s√©lectionner plusieurs r√¥les.</small>
      <% } else { %>
        <span class="text-danger">Aucun r√¥le disponible</span>
      <% } %>
    </label>
    <button class="btn success" data-icon="‚ûï" type="submit">Ajouter</button>
  </div>
</form>
<% if (!users.length) { %>
  <p class="card mt-md">Aucun utilisateur trouv√©.</p>
<% } else { %>
  <div class="table-wrap mt-md">
    <table class="data-table">
      <thead>
        <tr><th>ID</th><th>Nom</th><th>Pseudo commentaire</th><th>R√¥le</th><th>Statut</th><th>Profils IP</th><th>Actions</th></tr>
      </thead>
      <tbody>
      <% users.forEach(u=>{ %>
        <tr>
          <td><%= u.id %></td>
          <% const usernameColor = u.role_color || null; %>
          <% const usernameClasses = ['user-handle']; %>
          <% const usernameStyle = usernameColor && usernameColor.hasColor ? usernameColor.style : ''; %>
          <% if (usernameColor && usernameColor.hasColor) { usernameClasses.push('role-colored-text'); usernameClasses.push(usernameColor.className); } %>
          <td>
            <strong class="<%= usernameClasses.join(' ') %>" style="<%= usernameStyle %>"><%= u.username %></strong>
          </td>
          <td>
            <form method="post" action="/admin/users/<%= u.id %>/display-name" class="flex gap-sm items-center">
              <%- include('../partials/csrf_field') %>
              <input
                type="text"
                name="displayName"
                maxlength="80"
                value="<%= u.display_name || '' %>"
                placeholder="Nom affich√©"
                aria-label="Pseudo pour <%= u.username %>"
                class="flex-basis-220"
              />
              <button class="btn secondary" data-icon="üíæ" type="submit">Enregistrer</button>
            </form>
          </td>
          <td>
            <% if (Array.isArray(u.roles) && u.roles.length) { %>
              <ul class="flex flex-wrap gap-xs list-unstyled">
                <% u.roles.forEach(function(role) { %>
                  <li><span class="badge"><%= role.name %></span></li>
                <% }) %>
              </ul>
            <% } else { %>
              <span><%= u.role_label %></span>
            <% } %>
          </td>
          <td>
            <% if (u.is_banned) { %>
              <span class="text-danger">Banni</span>
              <% if (u.ban_reason) { %>
                <br /><small>Motif&nbsp;: <%= u.ban_reason %></small>
              <% } %>
              <% if (u.banned_at) { %>
                <br /><small>Depuis le <%= new Date(u.banned_at).toLocaleString('fr-FR') %></small>
              <% } %>
            <% } else { %>
              <span>Actif</span>
            <% } %>
          </td>
          <td>
            <% if (Array.isArray(u.ipProfiles) && u.ipProfiles.length) { %>
              <ul>
                <% u.ipProfiles.forEach(function (ipProfile) { %>
                  <li>
                    <a href="/profiles/ip/<%= encodeURIComponent(ipProfile.hash) %>">Profil #<%= ipProfile.shortHash || '?' %></a>
                    <% if (ipProfile.claimedAt) { %>
                      <span class="text-muted">‚Äì <%= new Date(ipProfile.claimedAt).toLocaleDateString('fr-FR') %></span>
                    <% } %>
                    <% if (permissions.can_manage_ip_profiles) { %>
                      <form
                        method="post"
                        action="/admin/users/<%= u.id %>/ip-profiles/<%= encodeURIComponent(ipProfile.hash) %>/unlink"
                        onsubmit="return confirm('Retirer ce profil IP de <%= u.username %> ?');"
                      >
                        <%- include('../partials/csrf_field') %>
                        <button class="btn danger" data-icon="üóëÔ∏è" type="submit">Retirer</button>
                      </form>
                    <% } %>
                  </li>
                <% }) %>
              </ul>
            <% } else { %>
              <span class="text-muted">Aucun</span>
            <% } %>
            <% if (permissions.can_manage_ip_profiles) { %>
              <form
                method="post"
                action="/admin/users/<%= u.id %>/ip-profiles/link"
                class="flex flex-wrap gap-sm items-center mt-sm"
              >
                <%- include('../partials/csrf_field') %>
                <input
                  type="text"
                  name="hash"
                  placeholder="hash du profil"
                  class="flex-basis-200"
                  required
                />
                <label class="text-sm">
                  <input type="checkbox" name="force" value="1" /> Forcer
                </label>
                <button class="btn secondary" data-icon="üîó" type="submit">Associer</button>
              </form>
            <% } %>
          </td>
          <td>
            <div class="flex flex-wrap gap-sm items-center">
              <form method="post" action="/admin/users/<%= u.id %>/role" class="flex gap-sm items-center">
                <%- include('../partials/csrf_field') %>
                <label class="sr-only" for="role-<%= u.id %>">R√¥le</label>
                <% if (Array.isArray(roles) && roles.length) { %>
                  <select id="role-<%= u.id %>" name="roleIds" multiple size="<%= Math.min(roles.length, 5) %>">
                    <% roles.forEach(role => { %>
                      <% const hasRole = Array.isArray(u.roles) && u.roles.some((assigned) => assigned.id === role.id); %>
                      <option value="<%= role.id %>" <%= hasRole ? 'selected' : '' %>><%= role.name %></option>
                    <% }) %>
                  </select>
                  <small class="text-xs text-muted">Ctrl/Cmd + clic pour ajouter ou retirer des r√¥les.</small>
                <% } else { %>
                  <span class="text-danger">Aucun r√¥le</span>
                <% } %>
                <button class="btn secondary" data-icon="‚≠ê" type="submit">Mettre √† jour les r√¥les</button>
              </form>
              <% if (permissions.can_suspend_users && u.is_banned) { %>
                <form method="post" action="/admin/users/<%= u.id %>/unban" class="flex gap-sm items-center">
                  <%- include('../partials/csrf_field') %>
                  <button class="btn success" data-icon="‚úÖ" type="submit">D√©bannir</button>
                </form>
              <% } %>
              <form method="post" action="/admin/users/<%= u.id %>/delete" onsubmit="return confirm('Supprimer cet utilisateur ?')">
                <%- include('../partials/csrf_field') %>
                <button class="btn danger" data-icon="üóëÔ∏è">Supprimer</button>
              </form>
            </div>
          </td>
        </tr>
      <% }) %>
      </tbody>
    </table>
  </div>
  <%- include('./paginationControls', { pagination }) %>
<% } %>

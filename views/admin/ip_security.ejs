<% title = 'S√©curit√© IP'; %>
<h1>S√©curit√© IP</h1>

<section class="card card-highlight">
  <p class="mt-0">
    Ce module interroge l'API gratuite <strong>ip-api.com</strong> pour rep√©rer automatiquement les
    adresses IP associ√©es √† des proxies, VPN ou h√©bergeurs. Examinez les alertes ci-dessous pour
    confirmer qu'il s'agit bien d'activit√©s suspectes avant d'appliquer une sanction.
  </p>
</section>

<% if (!flagged.length) { %>
  <div class="alert alert-success mt-md">
    Aucune adresse IP suspecte en attente de r√©vision. Bravo !
  </div>
<% } else { %>
  <div class="alert alert-warning mt-md">
    <strong><%= flagged.length %></strong> adresse(s) IP n√©cessitent votre attention.
  </div>
  <section class="card mt-md">
    <h2 class="mt-0">Adresses signal√©es</h2>
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>Profil</th>
            <th>Adresse IP</th>
            <th>Raison</th>
            <th>Derni√®re v√©rification</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% flagged.forEach((ip) => { %>
            <tr>
              <td>
                <strong>
                  <a href="/profiles/ip/<%= ip.hash %>" target="_blank" rel="noopener">
                    Profil #<%= ip.shortHash %>
                  </a>
                </strong>
                <br />
                <span class="status-badge status-flagged">√Ä v√©rifier</span>
              </td>
              <td><code><%= ip.ip %></code></td>
              <td>
                <div><%= ip.reason %></div>
                <% if (ip.provider) { %>
                  <small class="text-muted">Source : <%= ip.provider %></small>
                <% } %>
              </td>
              <td>
                <% if (ip.flaggedAt) { %>
                  <time datetime="<%= ip.flaggedAt %>"><%= new Date(ip.flaggedAt).toLocaleString('fr-FR') %></time>
                <% } else if (ip.checkedAt) { %>
                  <time datetime="<%= ip.checkedAt %>"><%= new Date(ip.checkedAt).toLocaleString('fr-FR') %></time>
                <% } else { %>
                  <span class="text-muted">Jamais</span>
                <% } %>
              </td>
              <td>
                <div class="flex flex-col gap-sm">
                  <form method="post" action="/admin/ip-security/<%= ip.hash %>/ban" class="stack-form">
                    <label class="stack-form">
                      <span class="text-sm text-muted">Raison (optionnelle)</span>
                      <input type="text" name="reason" placeholder="Motif du bannissement" />
                    </label>
                    <button class="btn danger" data-icon="üö´" type="submit">Bannir globalement</button>
                  </form>
                  <form method="post" action="/admin/ip-security/<%= ip.hash %>/mark-safe">
                    <button class="btn secondary" data-icon="‚úÖ" type="submit">Marquer comme s√ªr</button>
                  </form>
                  <form method="post" action="/admin/ip-security/<%= ip.hash %>/recheck">
                    <button class="btn secondary" data-icon="üîÑ" type="submit">R√©analyser</button>
                  </form>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </section>
<% } %>

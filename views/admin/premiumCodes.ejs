<% title = 'Codes premium'; %>
<h1>Codes premium</h1>
<p class="text-muted">
  G√©n√©rez des codes √† usage unique pour attribuer temporairement le r√¥le premium √† un utilisateur. Les codes expirent
  automatiquement s'ils ne sont pas utilis√©s avant la date limite indiqu√©e.
</p>

<form method="post" class="card mb-md">
  <%- include('../partials/csrf_field') %>
  <div class="form-grid">
    <label class="stack-form">
      <span class="text-sm text-muted">Code personnalis√©</span>
      <input
        type="text"
        name="code"
        value="<%= formDefaults.code || '' %>"
        maxlength="64"
        placeholder="Laissez vide pour g√©n√©rer un code al√©atoire"
      />
    </label>
    <div class="field">
      <span class="text-sm text-muted">Expiration du code</span>
      <div class="flex gap-sm items-center">
        <input
          type="number"
          step="0.01"
          min="0"
          name="expiresValue"
          value="<%= formDefaults.expiresValue %>"
          class="flex-basis-140"
        />
        <select name="expiresUnit">
          <% durationUnits.forEach(function (unit) { %>
            <option value="<%= unit.value %>" <%= formDefaults.expiresUnit === unit.value ? 'selected' : '' %>>
              <%= unit.label %>
            </option>
          <% }) %>
        </select>
      </div>
      <p class="field-hint">Laissez vide ou indiquez 0 pour cr√©er un code sans date d'expiration.</p>
    </div>
    <div class="field">
      <span class="text-sm text-muted">Dur√©e du premium accord√©</span>
      <div class="flex gap-sm items-center">
        <input
          type="number"
          step="0.01"
          min="0.01"
          name="durationValue"
          value="<%= formDefaults.durationValue %>"
          class="flex-basis-140"
          required
        />
        <select name="durationUnit">
          <% durationUnits.forEach(function (unit) { %>
            <option value="<%= unit.value %>" <%= formDefaults.durationUnit === unit.value ? 'selected' : '' %>>
              <%= unit.label %>
            </option>
          <% }) %>
        </select>
      </div>
      <p class="field-hint">Dur√©e d'acc√®s premium accord√©e apr√®s utilisation du code.</p>
    </div>
  </div>
  <div class="form-actions mt-md">
    <button class="btn success" data-icon="‚ú®" type="submit">Cr√©er un code premium</button>
  </div>
</form>

<% if (loadError) { %>
  <div class="alert error"><%= loadError %></div>
<% } %>

<% if (!Array.isArray(codes) || !codes.length) { %>
  <p class="card">Aucun code premium n'a encore √©t√© cr√©√©.</p>
<% } else { %>
  <div class="table-wrap">
    <table class="data-table">
      <thead>
        <tr>
          <th>Code</th>
          <th>Dur√©e premium</th>
          <th>Expiration</th>
          <th>Statut</th>
          <th>Utilis√© par</th>
          <th>Cr√©√© par</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% codes.forEach(function (code) { %>
          <tr>
            <td><code><%= code.code %></code></td>
            <td><%= code.premiumDurationLabel %></td>
            <td>
              <% if (code.expiresAtFormatted) { %>
                <div><%= code.expiresAtFormatted %></div>
                <% if (code.expiresAtRelative) { %>
                  <div class="text-muted text-sm"><%= code.expiresAtRelative %></div>
                <% } %>
              <% } else { %>
                <span class="text-muted">Aucune expiration</span>
              <% } %>
            </td>
            <td>
              <% if (code.isRedeemed) { %>
                <span class="badge success">Utilis√©</span>
                <% if (code.redeemedAtFormatted) { %>
                  <div class="text-sm">le <%= code.redeemedAtFormatted %></div>
                <% } %>
                <% if (code.redeemedAtRelative) { %>
                  <div class="text-muted text-sm"><%= code.redeemedAtRelative %></div>
                <% } %>
              <% } else if (code.isExpired) { %>
                <span class="badge danger">Expir√©</span>
              <% } else { %>
                <span class="badge info">Disponible</span>
              <% } %>
            </td>
            <td>
              <% if (code.redeemerUsername) { %>
                <strong><%= code.redeemerUsername %></strong>
              <% } else { %>
                <span class="text-muted">‚Äî</span>
              <% } %>
            </td>
            <td>
              <% if (code.creatorUsername) { %>
                <strong><%= code.creatorUsername %></strong>
              <% } else { %>
                <span class="text-muted">Automatique</span>
              <% } %>
              <% if (code.createdAtFormatted) { %>
                <div class="text-muted text-sm">le <%= code.createdAtFormatted %></div>
              <% } %>
            </td>
            <td>
              <% if (!code.isRedeemed) { %>
                <form
                  method="post"
                  action="/admin/premium-codes/<%= code.id %>/delete"
                  onsubmit="return confirm('Supprimer d√©finitivement ce code premium&nbsp;?');"
                >
                  <%- include('../partials/csrf_field') %>
                  <button class="btn danger" data-icon="üóëÔ∏è" type="submit">Supprimer</button>
                </form>
              <% } else { %>
                <span class="text-muted">‚Äî</span>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
<% } %>

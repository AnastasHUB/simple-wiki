<% title = 'Surveillance IP'; %>
<%
  const reviewPager = reviewPagination || null;
  const suspiciousTotal = reviewPager ? reviewPager.totalItems : suspicious.length;
  const clearedPager = clearedPagination || null;
  const clearedTotal = clearedPager ? clearedPager.totalItems : cleared.length;
  const historyEntries = Array.isArray(history) ? history : [];
  const historyPager = historyPagination || null;
  const historyTotal = historyPager ? historyPager.totalItems : historyEntries.length;
  function formatReputationStatusLabel(status) {
    if (status === 'suspicious') return 'Suspecte';
    if (status === 'safe') return 'Valid√©e';
    if (status === 'clean') return 'Neutre';
    return 'Inconnue';
  }
  function getReputationStatusClass(status) {
    if (status === 'suspicious') return 'status-pill suspicious';
    if (status === 'safe') return 'status-pill safe';
    if (status === 'clean') return 'status-pill clean';
    return 'status-pill pending';
  }
%>
<h1>Surveillance des IP √† risque</h1>

<p class="text-muted leading-snug">
  Les adresses IP sont v√©rifi√©es automatiquement via le service <a href="https://ipapi.is" target="_blank" rel="noopener"><%= providerName %></a>
  pour rep√©rer les VPN, proxys, r√©seaux Tor ou h√©bergements abusifs. Les contr√¥les sont rejou√©s toutes les
  <strong><%= refreshIntervalHours %>h</strong> ou manuellement depuis cet onglet.
</p>

<section class="card mb-xl">
  <h2 class="mt-0">Analyser une adresse IP</h2>
  <form method="post" action="/admin/ip-reputation/manual-check" class="flex flex-wrap gap-sm items-end">
    <label class="stack-form flex-basis-260">
      <span class="text-sm text-muted">Adresse IP</span>
      <input
        type="text"
        name="ip"
        placeholder="Ex : 203.0.113.5"
        required
      />
    </label>
    <button type="submit" class="btn success" data-icon="üîç">Analyser</button>
  </form>
  <p class="help-text mt-sm">
    L'adresse sera ajout√©e au suivi et analys√©e imm√©diatement via le fournisseur externe.
  </p>
</section>

<% if (suspiciousTotal) { %>
  <div class="alert alert-error mb-md">
    ‚ö†Ô∏è <strong><%= suspiciousTotal %> IP</strong> n√©cessitent une action de mod√©ration. Vous pouvez les bannir ou les marquer comme s√ªres apr√®s v√©rification.
  </div>
<% } else { %>
  <div class="alert alert-success mb-md">
    ‚úÖ Aucune nouvelle adresse IP suspecte n'a √©t√© d√©tect√©e lors de la derni√®re analyse automatique.
  </div>
<% } %>

<section class="card card-highlight mb-xl">
  <h2 class="mt-0">R√©sum√©</h2>
  <div class="grid grid-auto">
    <div>
      <p class="stat-sub">IP en attente de revue</p>
      <p class="stat-number"><%= suspiciousTotal %></p>
    </div>
    <div>
      <p class="stat-sub">Fournisseur de d√©tection</p>
      <p class="stat-number"><%= providerName %></p>
    </div>
    <div>
      <p class="stat-sub">Fr√©quence automatique</p>
      <p class="stat-number"><%= refreshIntervalHours %>h</p>
    </div>
  </div>
</section>

<section class="card mb-xl">
  <h2 class="mt-0">IP √† examiner (<%= suspiciousTotal %>)</h2>
  <% if (!suspiciousTotal) { %>
    <p class="text-muted">Aucune adresse IP suspecte n'est en file d'attente.</p>
  <% } else { %>
    <ul class="admin-risk-list">
      <% suspicious.forEach((profile) => { %>
        <li class="admin-risk-item">
          <header class="admin-risk-header">
            <div>
              <code class="admin-risk-ip"><%= profile.ip %></code>
              <span class="status-pill suspicious">Suspecte</span>
              <span class="text-muted">
                Profil #<%= profile.shortHash %>
                <% if (profile.id) { %>
                  ¬∑ ID : <code><%= profile.id %></code>
                <% } %>
              </span>
              <% if (profile.bot?.isBot) { %>
                <span class="status-pill suspicious">Bot suspect√©</span>
              <% } %>
            </div>
            <div class="admin-risk-links">
              <a class="btn secondary" href="/profiles/ip/<%= profile.hash %>" target="_blank" rel="noopener">Profil public</a>
              <a class="btn secondary" href="/admin/ip-profiles?search=<%= profile.hash %>">Voir dans la liste</a>
            </div>
          </header>
          <p class="admin-risk-summary"><%= profile.summary || 'Signaux d\'activit√© suspects d√©tect√©s.' %></p>
          <% if (profile.bot?.reason) { %>
            <p class="text-muted text-sm">D√©tection bot : <%= profile.bot.reason %></p>
          <% } %>
          <% if (profile.bot?.userAgent) { %>
            <p class="text-muted text-sm"><small>Agent : <%= profile.bot.userAgent %></small></p>
          <% } %>
          <div class="admin-risk-flags">
            <% if (profile.flags.isVpn) { %><span class="tag tag-danger">VPN d√©tect√©</span><% } %>
            <% if (profile.flags.isProxy) { %><span class="tag tag-warning">Proxy</span><% } %>
            <% if (profile.flags.isTor) { %><span class="tag tag-warning">Noeud Tor</span><% } %>
            <% if (profile.flags.isDatacenter) { %><span class="tag tag-info">H√©bergement</span><% } %>
            <% if (profile.flags.isAbuser) { %><span class="tag tag-danger">Risque d'abus</span><% } %>
            <% if (profile.bot?.isBot) { %><span class="tag tag-danger">Bot</span><% } %>
          </div>
          <div class="admin-risk-meta text-muted">
            <% if (profile.checkedAt) { %>
              Derni√®re v√©rification : <%= new Date(profile.checkedAt).toLocaleString('fr-FR') %>
            <% } else { %>
              Derni√®re v√©rification : inconnue
            <% } %>
            <% if (profile.lastSeenAt) { %>
              ¬∑ Derni√®re activit√© : <%= new Date(profile.lastSeenAt).toLocaleString('fr-FR') %>
            <% } %>
          </div>
          <div class="admin-risk-actions">
            <form method="post" action="/admin/ip-reputation/<%= profile.hash %>/ban" onsubmit="return confirm('Bannir d√©finitivement cette adresse IP ?');">
              <button type="submit" class="btn danger" data-icon="üö´">Bannir</button>
            </form>
            <form method="post" action="/admin/ip-reputation/<%= profile.hash %>/mark-safe">
              <button type="submit" class="btn success" data-icon="‚úÖ">Marquer comme s√ªr</button>
            </form>
            <form method="post" action="/admin/ip-reputation/<%= profile.hash %>/recheck">
              <button type="submit" class="btn secondary" data-icon="üîÑ">Rev√©rifier</button>
            </form>
          </div>
        </li>
      <% }) %>
    </ul>
    <%- include('./paginationControls', { pagination: reviewPager }) %>
  <% } %>
</section>

<section class="card">
  <h2 class="mt-0">IP r√©cemment valid√©es</h2>
  <% if (!clearedTotal) { %>
    <p class="text-muted">Aucune validation manuelle r√©cente.</p>
  <% } else { %>
    <ul class="admin-cleared-list">
      <% cleared.forEach((profile) => { %>
        <li>
          <div class="admin-cleared-header">
            <code><%= profile.ip %></code>
            <span class="status-pill safe">S√ªre</span>
            <span class="text-muted">
              Profil #<%= profile.shortHash %>
              <% if (profile.id) { %>
                ¬∑ ID : <code><%= profile.id %></code>
              <% } %>
            </span>
            <% if (profile.bot?.isBot) { %>
              <span class="status-pill suspicious">Bot suspect√©</span>
            <% } %>
          </div>
          <% if (profile.summary) { %>
            <p class="text-muted"><%= profile.summary %></p>
          <% } %>
          <% if (profile.bot?.reason) { %>
            <p class="text-muted text-sm">D√©tection bot : <%= profile.bot.reason %></p>
          <% } %>
          <% if (profile.bot?.userAgent) { %>
            <p class="text-muted text-sm"><small>Agent : <%= profile.bot.userAgent %></small></p>
          <% } %>
          <div class="admin-cleared-actions">
            <form
              method="post"
              action="/admin/ip-reputation/<%= profile.hash %>/clear-safe"
              onsubmit="return confirm('Retirer cette IP des validations r√©centes ?');"
            >
              <button type="submit" class="btn danger" data-icon="üóëÔ∏è">Retirer</button>
            </form>
          </div>
          <p class="admin-cleared-meta text-muted">
            <% if (profile.checkedAt) { %>
              V√©rifi√© le <%= new Date(profile.checkedAt).toLocaleString('fr-FR') %>
            <% } else if (profile.lastSeenAt) { %>
              Derni√®re activit√© : <%= new Date(profile.lastSeenAt).toLocaleString('fr-FR') %>
            <% } %>
          </p>
        </li>
      <% }) %>
    </ul>
    <%- include('./paginationControls', { pagination: clearedPager }) %>
  <% } %>
</section>

<section class="card">
  <h2 class="mt-0">Historique des analyses</h2>
  <% if (!historyTotal) { %>
    <p class="text-muted">Aucune analyse d'adresse IP n'a encore √©t√© enregistr√©e.</p>
  <% } else { %>
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>Adresse IP</th>
            <th>Statut</th>
            <th>R√©sum√©</th>
            <th>Derni√®re v√©rification</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% historyEntries.forEach((entry) => { %>
            <tr>
              <td>
                <code><%= entry.ip %></code>
                <br />
                <small class="text-muted">
                  Profil #<%= entry.shortHash %>
                  <% if (entry.id) { %>
                    <br />ID : <code><%= entry.id %></code>
                  <% } %>
                </small>
              </td>
              <td>
                <span class="<%= getReputationStatusClass(entry.status) %>">
                  <%= formatReputationStatusLabel(entry.status) %>
                </span>
                <% if (entry.override) { %>
                  <br />
                  <small class="text-muted">For√ßage : <%= entry.override %></small>
                <% } %>
              </td>
              <td>
                <%= entry.summary || "Aucun signal particulier d√©tect√©." %>
                <% if (entry.bot?.isBot) { %>
                  <br />
                  <small class="text-muted">Bot d√©tect√© : <%= entry.bot.reason || 'Motifs automatiques' %></small>
                <% } %>
                <% if (entry.bot?.userAgent) { %>
                  <br />
                  <small class="text-muted"><%= entry.bot.userAgent %></small>
                <% } %>
              </td>
              <td>
                <% if (entry.checkedAt) { %>
                  <time datetime="<%= entry.checkedAt %>">
                    <%= new Date(entry.checkedAt).toLocaleString('fr-FR') %>
                  </time>
                <% } else { %>
                  <span class="text-muted">Jamais</span>
                <% } %>
              </td>
              <td>
                <a
                  class="btn secondary btn-compact"
                  href="/profiles/ip/<%= entry.hash %>"
                  target="_blank"
                  rel="noopener"
                >
                  Voir le profil
                </a>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <%- include('./paginationControls', { pagination: historyPager }) %>
  <% } %>
</section>

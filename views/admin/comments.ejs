<h1>Modération des commentaires</h1>

<form method="get" class="card mb-md">
  <div class="flex flex-wrap gap-sm items-end">
    <label class="stack-form">
      <span class="text-sm text-muted">Rechercher</span>
      <input
        type="text"
        name="search"
        value="<%= typeof searchTerm === 'string' ? searchTerm : '' %>"
        placeholder="ID, IP, auteur, page…"
        class="flex-basis-260"
      />
    </label>
    <input type="hidden" name="pendingPage" value="1" />
    <input type="hidden" name="recentPage" value="1" />
    <input type="hidden" name="pendingPerPage" value="<%= pendingPagination.perPage %>" />
    <input type="hidden" name="recentPerPage" value="<%= recentPagination.perPage %>" />
    <button class="btn" data-icon="🔍" type="submit">Rechercher</button>
    <% if (searchTerm) { %>
      <a class="btn secondary" href="/admin/comments">Réinitialiser</a>
    <% } %>
  </div>
</form>

<section class="card mb-xl">
  <h2 class="mt-0">En attente de validation (<%= pendingPagination.totalItems %>)</h2>
  <% if (!pending.length) { %>
    <p>Aucun commentaire en attente.</p>
  <% } else { %>
    <ul class="admin-comment-list">
      <% pending.forEach(c => { const commentIdentifier = c.snowflake_id ? c.snowflake_id : `legacy-${c.id}`; %>
        <li>
          <header>
            <div>
              <strong><%= c.author || 'Anonyme' %></strong>
              <span>· <%= new Date(c.created_at).toLocaleString('fr-FR') %></span>
            </div>
            <a class="tag" href="/wiki/<%= c.page_slug %>" target="_blank" rel="noopener">Voir la page</a>
          </header>
          <p><%= c.body %></p>
          <p class="meta">ID : <code><%= commentIdentifier %></code></p>
          <p class="meta">IP: <code><%= c.ip || 'n/a' %></code></p>
          <% if (c.updated_at) { %>
            <p class="meta">Dernière modification : <%= new Date(c.updated_at).toLocaleString('fr-FR') %></p>
          <% } %>
          <div class="actions">
            <form method="post" action="/admin/comments/<%= commentIdentifier %>/approve">
              <button class="btn success" data-icon="✅" type="submit">Approuver</button>
            </form>
            <form method="post" action="/admin/comments/<%= commentIdentifier %>/reject">
              <button class="btn" data-icon="🚫" type="submit">Rejeter</button>
            </form>
            <form method="post" action="/admin/comments/<%= commentIdentifier %>/delete" onsubmit="return confirm('Supprimer ce commentaire ?');">
              <button class="btn unlike" data-icon="🗑️" type="submit">Supprimer</button>
            </form>
          </div>
        </li>
      <% }) %>
    </ul>
    <%- include('./paginationControls', { pagination: pendingPagination }) %>
  <% } %>
</section>

<section class="card">
  <h2 class="mt-0">Historique récent</h2>
  <% if (!recent.length) { %>
    <p>Aucun commentaire modéré pour le moment.</p>
  <% } else { %>
    <ul class="admin-comment-list compact">
      <% recent.forEach(c => { const commentIdentifier = c.snowflake_id ? c.snowflake_id : `legacy-${c.id}`; %>
        <li>
          <header>
            <div>
              <strong><%= c.author || 'Anonyme' %></strong>
              <span>· <%= new Date(c.created_at).toLocaleString('fr-FR') %> · <span class="status <%= c.status %>"><%= c.status %></span></span>
            </div>
            <a class="tag" href="/wiki/<%= c.page_slug %>" target="_blank" rel="noopener">Voir la page</a>
          </header>
          <p><%= c.body %></p>
          <p class="meta">ID : <code><%= commentIdentifier %></code></p>
          <p class="meta">IP: <code><%= c.ip || 'n/a' %></code></p>
          <% if (c.updated_at) { %>
            <p class="meta">Dernière modification : <%= new Date(c.updated_at).toLocaleString('fr-FR') %></p>
          <% } %>
          <div class="actions">
            <form method="post" action="/admin/comments/<%= commentIdentifier %>/delete" onsubmit="return confirm('Supprimer ce commentaire ?');">
              <button class="btn unlike" data-icon="🗑️" type="submit">Supprimer</button>
            </form>
          </div>
        </li>
      <% }) %>
    </ul>
    <%- include('./paginationControls', { pagination: recentPagination }) %>
  <% } %>
</section>

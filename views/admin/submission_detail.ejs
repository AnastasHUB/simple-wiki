<% title = t('admin.submissionDetail.title'); %>
<h1><%= t('admin.submissionDetail.heading') %> <code><%= submission.snowflake_id %></code></h1>

<section class="card mb-xl">
  <h2><%= t('admin.submissionDetail.info.title') %></h2>
  <div class="grid grid-auto">
    <div>
      <strong><%= t('admin.submissionDetail.info.type') %></strong>
      <p><%= submission.type === 'edit' ? t('admin.submissions.types.edit') : t('admin.submissions.types.create') %></p>
    </div>
    <div>
      <strong><%= t('admin.submissionDetail.info.proposedTitle') %></strong>
      <p><strong><%= submission.title %></strong></p>
    </div>
    <div>
      <strong>IP</strong>
      <p><%= submission.ip || '—' %></p>
    </div>
    <div>
      <strong><%= t('admin.submissionDetail.info.proposedAuthor') %></strong>
      <% const submissionAuthorHandle = submission.author_name || submission.submitted_by; %>
      <% const submissionAuthorRole = submission.author_name ? submission.authorNameRole : submission.submittedByRole; %>
      <% const submissionAuthorBadges = Array.isArray(submissionAuthorRole?.badges) ? submissionAuthorRole.badges : []; %>
      <% if (submissionAuthorHandle) { %>
        <% const submissionAuthorColor = submissionAuthorRole && submissionAuthorRole.color ? submissionAuthorRole.color : null; %>
        <% const submissionAuthorClasses = ['user-handle', 'submission-author']; %>
        <% const submissionAuthorStyle = submissionAuthorColor && submissionAuthorColor.hasColor ? submissionAuthorColor.style : ''; %>
        <% if (submissionAuthorColor && submissionAuthorColor.hasColor) { submissionAuthorClasses.push('role-colored-text'); submissionAuthorClasses.push(submissionAuthorColor.className); } %>
        <p>
          <span class="user-handle-decorated">
            <strong class="<%= submissionAuthorClasses.join(' ') %>" style="<%= submissionAuthorStyle %>">
              <%= submissionAuthorHandle %>
            </strong>
            <%- include('../partials/userBadges', {
              badges: submissionAuthorBadges,
              listClass: ['user-handle-badges', 'user-handle-badges--inline'],
              itemClass: 'user-handle-badge-item',
              iconClass: 'user-handle-badge-icon',
              srOnlyClass: 'sr-only',
              ariaLabel: t('common.authorBadgesAria'),
            }) %>
          </span>
        </p>
      <% } else { %>
        <p>—</p>
      <% } %>
    </div>
    <div>
      <strong><%= t('admin.submissionDetail.info.submittedAt') %></strong>
      <p><%= fmt.dateTime(submission.created_at) %></p>
    </div>
    <div>
      <strong><%= t('admin.submissionDetail.info.status') %></strong>
      <p>
        <% if (submission.status === 'pending') { %>
          <span class="status status-pill pending"><%= t('admin.submissions.status.pending') %></span>
        <% } else if (submission.status === 'approved') { %>
          <span class="status status-pill approved"><%= t('admin.submissions.status.approved') %></span>
        <% } else { %>
          <span class="status status-pill rejected"><%= t('admin.submissions.status.rejected') %></span>
        <% } %>
      </p>
    </div>
    <% if (submission.reviewed_at) { %>
      <div>
        <strong><%= t('admin.submissionDetail.info.decision') %></strong>
        <p>
          <%= fmt.dateTime(submission.reviewed_at) %>
          <% if (submission.reviewer_username) { %>
          <% const reviewerColor = submission.reviewerRole && submission.reviewerRole.color ? submission.reviewerRole.color : null; %>
          <% const reviewerClasses = ['user-handle', 'submission-reviewer']; %>
          <% const reviewerStyle = reviewerColor && reviewerColor.hasColor ? reviewerColor.style : ''; %>
          <% if (reviewerColor && reviewerColor.hasColor) { reviewerClasses.push('role-colored-text'); reviewerClasses.push(reviewerColor.className); } %>
          <% const reviewerBadges = Array.isArray(submission?.reviewerRole?.badges) ? submission.reviewerRole.badges : []; %>
            — <%= t('admin.submissionDetail.info.by') %>
            <span class="user-handle-decorated">
              <strong class="<%= reviewerClasses.join(' ') %>" style="<%= reviewerStyle %>"><%= submission.reviewer_username %></strong>
              <%- include('../partials/userBadges', {
                badges: reviewerBadges,
                listClass: ['user-handle-badges', 'user-handle-badges--inline'],
                itemClass: 'user-handle-badge-item',
                iconClass: 'user-handle-badge-icon',
                srOnlyClass: 'sr-only',
                ariaLabel: t('admin.submissionDetail.aria.moderatorBadges'),
              }) %>
            </span>
          <% } %>
        </p>
      </div>
    <% } %>
    <% if (submission.review_note) { %>
      <div>
        <strong><%= t('admin.submissionDetail.info.note') %></strong>
        <p><%= submission.review_note %></p>
      </div>
    <% } %>
    <div>
      <strong><%= t('admin.submissionDetail.info.proposedTags') %></strong>
      <p>
        <% if (proposedTags.length) { %>
          <%= proposedTags.join(', ') %>
        <% } else { %>
          —
        <% } %>
      </p>
    </div>
    <% if (currentTags && currentTags.length) { %>
      <div>
        <strong><%= t('admin.submissionDetail.info.currentTags') %></strong>
        <p><%= currentTags.join(', ') %></p>
      </div>
    <% } %>
    <% if (submission.current_slug) { %>
      <div>
        <strong><%= t('admin.submissionDetail.info.currentPage') %></strong>
        <p><a href="/wiki/<%= submission.current_slug %>"><code><%= submission.current_slug %></code></a></p>
      </div>
    <% } %>
  </div>
</section>

<% if (submission.status === 'pending') { %>
  <section class="card mb-xl">
    <h2><%= t('admin.submissionDetail.decide.title') %></h2>
    <div class="grid grid-auto">
      <form method="post" action="/admin/submissions/<%= submission.snowflake_id %>/approve" class="flex flex-col gap-sm">
        <%- include('../partials/csrf_field') %>
        <label for="approve-note"><%= t('admin.submissionDetail.decide.noteOptional') %></label>
        <textarea id="approve-note" name="note" rows="3" placeholder="<%= t('admin.submissionDetail.decide.notePlaceholder') %>"></textarea>
        <button class="btn success" type="submit"><%= t('admin.submissionDetail.decide.approve') %></button>
      </form>
      <form method="post" action="/admin/submissions/<%= submission.snowflake_id %>/reject" class="flex flex-col gap-sm" onsubmit="return confirm(t('admin.submissionDetail.decide.rejectConfirm'))">
        <%- include('../partials/csrf_field') %>
        <label for="reject-note"><%= t('admin.submissionDetail.decide.reasonOptional') %></label>
        <textarea id="reject-note" name="note" rows="3" placeholder="<%= t('admin.submissionDetail.decide.reasonPlaceholder') %>"></textarea>
        <button class="btn danger" type="submit"><%= t('admin.submissionDetail.decide.reject') %></button>
      </form>
    </div>
  </section>
<% } %>

<section class="card mb-xl">
  <h2><%= t('admin.submissionDetail.content.proposedTitle') %></h2>
  <div class="prose"><div><%- proposedHtml %></div></div>
</section>

<% if (currentHtml) { %>
  <section class="card">
    <h2><%= t('admin.submissionDetail.content.currentTitle') %></h2>
    <div class="prose"><div><%- currentHtml %></div></div>
  </section>
<% } %>


<% title = 'Contributions'; %>
<h1>Contributions des visiteurs</h1>

<form method="get" class="card mb-md">
  <div class="flex flex-wrap gap-sm items-end">
    <label class="stack-form">
      <span class="text-sm text-muted">Rechercher</span>
      <input
        type="text"
        name="search"
        value="<%= typeof searchTerm === 'string' ? searchTerm : '' %>"
        placeholder="ID, IP, titre, page‚Ä¶"
        class="flex-basis-260"
      />
    </label>
    <input type="hidden" name="pendingPage" value="1" />
    <input type="hidden" name="recentPage" value="1" />
    <input type="hidden" name="pendingPerPage" value="<%= pendingPagination.perPage %>" />
    <input type="hidden" name="recentPerPage" value="<%= recentPagination.perPage %>" />
    <button class="btn" data-icon="üîç" type="submit">Rechercher</button>
    <% if (searchTerm) { %>
      <a class="btn secondary" href="/admin/submissions">R√©initialiser</a>
    <% } %>
  </div>
</form>

<section class="card mb-xl">
  <h2>En attente (<%= pendingPagination.totalItems %>)</h2>
  <% if (!pending.length) { %>
    <p>Aucune contribution en attente de validation.</p>
  <% } else { %>
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Type</th>
            <th>Titre</th>
            <th>Auteur propos√©</th>
            <th>Page li√©e</th>
            <th>Tags</th>
            <th>IP</th>
            <th>Cr√©√©</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% pending.forEach(item => { %>
            <tr>
              <td><code><%= item.snowflake_id %></code></td>
              <td><%= item.type === 'edit' ? 'Modification' : 'Cr√©ation' %></td>
              <td><strong><%= item.title %></strong></td>
              <% const pendingAuthorHandle = item.author_name || item.submitted_by; %>
              <% const pendingAuthorRole = item.author_name ? item.authorNameRole : item.submittedByRole; %>
              <% const pendingAuthorBadges = Array.isArray(pendingAuthorRole?.badges) ? pendingAuthorRole.badges : []; %>
              <td>
                <% if (pendingAuthorHandle) { %>
                  <% const pendingAuthorColor = pendingAuthorRole && pendingAuthorRole.color ? pendingAuthorRole.color : null; %>
                  <% const pendingAuthorClasses = ['user-handle', 'submission-author']; %>
                  <% const pendingAuthorStyle = pendingAuthorColor && pendingAuthorColor.hasColor ? pendingAuthorColor.style : ''; %>
                  <% if (pendingAuthorColor && pendingAuthorColor.hasColor) { pendingAuthorClasses.push('role-colored-text'); pendingAuthorClasses.push(pendingAuthorColor.className); } %>
                  <span class="user-handle-decorated">
                    <strong class="<%= pendingAuthorClasses.join(' ') %>" style="<%= pendingAuthorStyle %>">
                      <%= pendingAuthorHandle %>
                    </strong>
                    <%- include('../partials/userBadges', {
                      badges: pendingAuthorBadges,
                      listClass: ['user-handle-badges', 'user-handle-badges--inline'],
                      itemClass: 'user-handle-badge-item',
                      iconClass: 'user-handle-badge-icon',
                      srOnlyClass: 'sr-only',
                      ariaLabel: "Badges de l'auteur",
                    }) %>
                  </span>
                <% } else { %>
                  ‚Äì
                <% } %>
              </td>
              <td>
                <% if (item.current_slug) { %>
                  <a href="/wiki/<%= item.current_slug %>"><code><%= item.current_slug %></code></a>
                <% } else { %>
                  ‚Äì
                <% } %>
              </td>
              <td>
                <% if (item.tag_list && item.tag_list.length) { %>
                  <%= item.tag_list.join(', ') %>
                <% } else { %>
                  ‚Äì
                <% } %>
              </td>
              <td><%= item.ip || '‚Äì' %></td>
              <td><%= new Date(item.created_at).toLocaleString('fr-FR') %></td>
              <td>
                <a class="btn" data-icon="üîç" href="/admin/submissions/<%= item.snowflake_id %>">Voir</a>
                <form method="post" action="/admin/submissions/<%= item.snowflake_id %>/approve">
                  <%- include('../partials/csrf_field') %>
                  <button class="btn success" data-icon="‚úÖ" type="submit">Approuver</button>
                </form>
                <form method="post" action="/admin/submissions/<%= item.snowflake_id %>/reject" onsubmit="return confirm('Rejeter cette contribution ?');">
                  <%- include('../partials/csrf_field') %>
                  <button class="btn danger" data-icon="‚úñÔ∏è" type="submit">Rejeter</button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <%- include('./paginationControls', { pagination: pendingPagination }) %>
  <% } %>
</section>

<section class="card">
  <h2>Historique des d√©cisions (<%= recentPagination.totalItems %>)</h2>
  <% if (!recent.length) { %>
    <p>Aucune d√©cision enregistr√©e.</p>
  <% } else { %>
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Type</th>
            <th>Titre</th>
            <th>Auteur propos√©</th>
            <th>Statut</th>
            <th>Valid√© par</th>
            <th>Revue</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody>
          <% recent.forEach(item => { %>
            <tr>
              <td><code><%= item.snowflake_id %></code></td>
              <td><%= item.type === 'edit' ? 'Modification' : 'Cr√©ation' %></td>
              <td>
                <strong><%= item.title %></strong>
                <% if (item.result_slug_id) { %>
                  <div><a href="/wiki/<%= item.result_slug_id %>"><code><%= item.result_slug_id %></code></a></div>
                <% } %>
              </td>
              <% const recentAuthorHandle = item.author_name || item.submitted_by; %>
              <% const recentAuthorRole = item.author_name ? item.authorNameRole : item.submittedByRole; %>
              <% const recentAuthorBadges = Array.isArray(recentAuthorRole?.badges) ? recentAuthorRole.badges : []; %>
              <td>
                <% if (recentAuthorHandle) { %>
                  <% const recentAuthorColor = recentAuthorRole && recentAuthorRole.color ? recentAuthorRole.color : null; %>
                  <% const recentAuthorClasses = ['user-handle', 'submission-author']; %>
                  <% const recentAuthorStyle = recentAuthorColor && recentAuthorColor.hasColor ? recentAuthorColor.style : ''; %>
                  <% if (recentAuthorColor && recentAuthorColor.hasColor) { recentAuthorClasses.push('role-colored-text'); recentAuthorClasses.push(recentAuthorColor.className); } %>
                  <span class="user-handle-decorated">
                    <strong class="<%= recentAuthorClasses.join(' ') %>" style="<%= recentAuthorStyle %>">
                      <%= recentAuthorHandle %>
                    </strong>
                    <%- include('../partials/userBadges', {
                      badges: recentAuthorBadges,
                      listClass: ['user-handle-badges', 'user-handle-badges--inline'],
                      itemClass: 'user-handle-badge-item',
                      iconClass: 'user-handle-badge-icon',
                      srOnlyClass: 'sr-only',
                      ariaLabel: "Badges de l'auteur",
                    }) %>
                  </span>
                <% } else { %>
                  ‚Äì
                <% } %>
              </td>
              <td class="status <%= item.status %>"><%= item.status === 'approved' ? 'Approuv√©e' : 'Rejet√©e' %></td>
              <% const reviewerColor = item.reviewerRole && item.reviewerRole.color ? item.reviewerRole.color : null; %>
              <% const reviewerClasses = ['user-handle', 'submission-reviewer']; %>
              <% const reviewerStyle = reviewerColor && reviewerColor.hasColor ? reviewerColor.style : ''; %>
              <% if (reviewerColor && reviewerColor.hasColor) { reviewerClasses.push('role-colored-text'); reviewerClasses.push(reviewerColor.className); } %>
              <% const reviewerBadges = Array.isArray(item?.reviewerRole?.badges) ? item.reviewerRole.badges : []; %>
              <td>
                <% if (item.reviewer_username) { %>
                  <span class="user-handle-decorated">
                    <strong class="<%= reviewerClasses.join(' ') %>" style="<%= reviewerStyle %>">
                      <%= item.reviewer_username %>
                    </strong>
                    <%- include('../partials/userBadges', {
                      badges: reviewerBadges,
                      listClass: ['user-handle-badges', 'user-handle-badges--inline'],
                      itemClass: 'user-handle-badge-item',
                      iconClass: 'user-handle-badge-icon',
                      srOnlyClass: 'sr-only',
                      ariaLabel: 'Badges du mod√©rateur',
                    }) %>
                  </span>
                <% } else { %>
                  ‚Äì
                <% } %>
              </td>
              <td>
                <% if (item.reviewed_at) { %>
                  <%= new Date(item.reviewed_at).toLocaleString('fr-FR') %>
                <% } else { %>
                  ‚Äì
                <% } %>
              </td>
              <td><%= item.review_note ? item.review_note : '‚Äì' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <%- include('./paginationControls', { pagination: recentPagination }) %>
  <% } %>
</section>


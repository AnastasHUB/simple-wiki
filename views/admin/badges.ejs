<% title = 'Badges'; %>
<h1>Badges utilisateurs</h1>
<p class="text-muted">
  Cr√©ez des badges personnalis√©s pour mettre en avant vos membres les plus actifs. Chaque badge peut afficher un emoji ou une image et √™tre attribu√© √† plusieurs utilisateurs.
</p>

<% const success = Array.isArray(successBadges) ? successBadges : []; %>
<% const customBadges = Array.isArray(manualBadges) ? manualBadges : Array.isArray(badges) ? badges : []; %>
<% const criteria = Array.isArray(achievementCriteria) ? achievementCriteria : []; %>
<% const assignedCriterionSet = new Set(Array.isArray(assignedCriterionKeys) ? assignedCriterionKeys : []); %>

<section class="card mt-md">
  <h2 class="mt-0">Badges de succ√®s</h2>
  <p class="text-sm text-muted">
    Ces badges sont attribu√©s automatiquement lorsqu'un membre remplit l'un des <strong><%= criteria.length %></strong> crit√®res de r√©ussite disponibles. Personnalisez leur nom, leur description ainsi que l'emoji ou l'image affich√©e.
  </p>

  <% if (canCreateBadges) { %>
    <form method="post" action="/admin/badges/success" class="badge-form mt-sm">
      <%- include('../partials/csrf_field') %>
      <div class="grid grid-cols-responsive gap-sm">
        <label class="stack-form">
          <span class="text-sm text-muted">Crit√®re de r√©ussite</span>
          <select name="criterionKey" required>
            <option value="">S√©lectionnez un crit√®re</option>
            <% criteria.forEach(function (criterion) { %>
              <% const disabled = assignedCriterionSet.has(criterion.key); %>
              <option value="<%= criterion.key %>" <%= disabled ? 'disabled' : '' %>>
                <%= criterion.name %>
              </option>
            <% }); %>
          </select>
        </label>
        <label class="stack-form">
          <span class="text-sm text-muted">Nom</span>
          <input type="text" name="name" maxlength="80" placeholder="Badge de r√©ussite" />
        </label>
        <label class="stack-form">
          <span class="text-sm text-muted">Emoji</span>
          <input type="text" name="emoji" maxlength="16" placeholder="üèÜ" />
        </label>
        <label class="stack-form">
          <span class="text-sm text-muted">Image (URL)</span>
          <input type="url" name="imageUrl" maxlength="500" placeholder="https://exemple.com/badges/succes.png" />
        </label>
      </div>
      <%- include('../partials/uploadHelper') %>
      <label class="stack-form mt-sm">
        <span class="text-sm text-muted">Description</span>
        <textarea name="description" rows="2" maxlength="240" placeholder="Expliquez quand ce badge est attribu√©."></textarea>
      </label>
      <p class="text-sm text-muted mt-sm">
        Fournissez au moins un emoji ou une image. Lorsque l'un de vos membres atteint le crit√®re choisi, le badge est attribu√© automatiquement.
      </p>
      <button class="btn success mt-sm" data-icon="‚≠ê" type="submit">Cr√©er un badge de succ√®s</button>
    </form>
  <% } %>

  <% if (!success.length) { %>
    <p class="text-muted mt-md">Aucun badge de succ√®s n'a encore √©t√© d√©fini.</p>
  <% } else { %>
    <div class="badge-grid mt-md">
      <% success.forEach(function (badge) { %>
        <article class="card badge-card" id="success-badge-<%= badge.snowflakeId %>">
          <header class="badge-card__header">
            <div class="badge-card__icon" aria-hidden="true">
              <% if (badge.imageUrl) { %>
                <img src="<%= badge.imageUrl %>" alt="" loading="lazy" />
              <% } else if (badge.emoji) { %>
                <%= badge.emoji %>
              <% } %>
            </div>
            <div class="badge-card__summary">
              <h2 class="badge-card__title"><%= badge.name %></h2>
              <% if (badge.description) { %>
                <p class="badge-card__description"><%= badge.description %></p>
              <% } else { %>
                <p class="badge-card__description text-muted">Aucune description fournie.</p>
              <% } %>
              <div class="badge-card__meta">
                <span class="badge">
                  <%= badge.assignmentCount %> d√©tenteur<%= badge.assignmentCount > 1 ? 's' : '' %>
                </span>
                <span class="badge badge-automatic" title="Attribu√© automatiquement">Automatique</span>
              </div>
              <% if (badge.criterion) { %>
                <p class="text-sm text-muted mt-xs">
                  Crit√®re&nbsp;: <strong><%= badge.criterion.name %></strong>
                </p>
              <% } %>
            </div>
          </header>

          <% if (canEditBadges) { %>
            <section class="badge-card__section">
              <h3 class="badge-card__section-title">Modifier ce badge de succ√®s</h3>
              <form method="post" action="/admin/badges/success/<%= badge.snowflakeId %>/update" class="badge-card__form">
                <%- include('../partials/csrf_field') %>
                <div class="grid grid-cols-responsive gap-sm">
                  <label class="stack-form">
                    <span class="text-sm text-muted">Crit√®re de r√©ussite</span>
                    <select name="criterionKey" required>
                      <% criteria.forEach(function (criterion) { %>
                        <% const disabled = assignedCriterionSet.has(criterion.key) && criterion.key !== badge.automaticKey; %>
                        <option value="<%= criterion.key %>" <%= criterion.key === badge.automaticKey ? 'selected' : '' %> <%= disabled ? 'disabled' : '' %>>
                          <%= criterion.name %>
                        </option>
                      <% }); %>
                    </select>
                  </label>
                  <label class="stack-form">
                    <span class="text-sm text-muted">Nom</span>
                    <input type="text" name="name" maxlength="80" value="<%= badge.name %>" required />
                  </label>
                  <label class="stack-form">
                    <span class="text-sm text-muted">Emoji</span>
                    <input type="text" name="emoji" maxlength="16" value="<%= badge.emoji %>" />
                  </label>
                  <label class="stack-form">
                    <span class="text-sm text-muted">Image (URL)</span>
                    <input type="url" name="imageUrl" maxlength="500" value="<%= badge.imageUrl || '' %>" />
                  </label>
                </div>
                <%- include('../partials/uploadHelper') %>
                <label class="stack-form mt-sm">
                  <span class="text-sm text-muted">Description</span>
                  <textarea name="description" rows="2" maxlength="240"><%= badge.description %></textarea>
                </label>
                <div class="badge-card__actions">
                  <button class="btn secondary" data-icon="üíæ" type="submit">Mettre √† jour</button>
                </div>
              </form>
              <% if (canDeleteBadges) { %>
                <form
                  method="post"
                  action="/admin/badges/success/<%= badge.snowflakeId %>/delete"
                  onsubmit="return confirm('Supprimer ce badge de succ√®s ?');"
                  class="badge-card__form badge-card__delete"
                >
                  <%- include('../partials/csrf_field') %>
                  <button class="btn danger" data-icon="üóëÔ∏è" type="submit">Supprimer</button>
                </form>
              <% } %>
            </section>
          <% } %>

          <section class="badge-card__section">
            <h3 class="badge-card__section-title">D√©tenteurs</h3>
            <% if (badge.assignees && badge.assignees.length) { %>
              <ul class="badge-card__assignees">
                <% badge.assignees.forEach(function (assignment) { %>
                  <li class="badge-card__assignee">
                    <% const assigneeRole = assignment.userRole || null; %>
                    <% const assigneeColor = assigneeRole && assigneeRole.color ? assigneeRole.color : null; %>
                    <% const assigneeClasses = ['user-handle']; %>
                    <% const assigneeStyle = assigneeColor && assigneeColor.hasColor ? assigneeColor.style : ''; %>
                    <% if (assigneeColor && assigneeColor.hasColor) { assigneeClasses.push('role-colored-text'); assigneeClasses.push(assigneeColor.className); } %>
                    <% const assigneeBadges = Array.isArray(assigneeRole?.badges) ? assigneeRole.badges : []; %>
                    <div>
                      <span class="user-handle-decorated">
                        <strong class="<%= assigneeClasses.join(' ') %>" style="<%= assigneeStyle %>"><%= assignment.username %></strong>
                        <%- include('../partials/userBadges', {
                          badges: assigneeBadges,
                          listClass: ['user-handle-badges', 'user-handle-badges--inline'],
                          itemClass: 'user-handle-badge-item',
                          iconClass: 'user-handle-badge-icon',
                          srOnlyClass: 'sr-only',
                          ariaLabel: "Badges de l'utilisateur",
                        }) %>
                      </span>
                      <% if (assignment.displayName && assignment.displayName.trim()) { %>
                        <span class="text-muted">(<%= assignment.displayName %>)</span>
                      <% } %>
                      <% if (assignment.assignedAt) { %>
                        <span class="text-muted">¬∑ <%= new Date(assignment.assignedAt).toLocaleDateString('fr-FR') %></span>
                      <% } %>
                    </div>
                  </li>
                <% }); %>
              </ul>
            <% } else { %>
              <p class="text-muted">Aucun utilisateur ne poss√®de encore ce badge.</p>
            <% } %>
            <p class="text-muted mt-xs">Les d√©tenteurs sont mis √† jour automatiquement en fonction du crit√®re.</p>
          </section>
        </article>
      <% }); %>
    </div>
  <% } %>
</section>

<% if (canCreateBadges) { %>
  <form method="post" class="card mt-md badge-form">
    <%- include('../partials/csrf_field') %>
    <h2 class="mt-0">Nouveau badge</h2>
    <div class="grid grid-cols-responsive gap-sm">
      <label class="stack-form">
        <span class="text-sm text-muted">Nom</span>
        <input type="text" name="name" maxlength="80" placeholder="Badge d'honneur" required />
      </label>
      <label class="stack-form">
        <span class="text-sm text-muted">Emoji</span>
        <input type="text" name="emoji" maxlength="16" placeholder="üèÖ" />
      </label>
      <label class="stack-form">
        <span class="text-sm text-muted">Image (URL)</span>
        <input type="url" name="imageUrl" maxlength="500" placeholder="https://exemple.com/badges/honneur.png" />
      </label>
    </div>
    <%- include('../partials/uploadHelper') %>
    <label class="stack-form mt-sm">
      <span class="text-sm text-muted">Description</span>
      <textarea name="description" rows="2" maxlength="240" placeholder="Expliquez la signification du badge."></textarea>
    </label>
    <p class="text-sm text-muted mt-sm">
      Fournissez au moins un emoji ou une image. Si les deux sont renseign√©s, l'image sera affich√©e dans l'interface.
    </p>
    <button class="btn success mt-sm" data-icon="‚ûï" type="submit">Cr√©er le badge</button>
  </form>
<% } %>

<% if (!Array.isArray(customBadges) || !customBadges.length) { %>
  <p class="card mt-md">Aucun badge n'a encore √©t√© d√©fini.</p>
<% } else { %>
  <div class="badge-grid mt-md">
    <% customBadges.forEach(function (badge) { %>
      <article class="card badge-card" id="badge-<%= badge.snowflakeId %>">
        <header class="badge-card__header">
          <div class="badge-card__icon" aria-hidden="true">
            <% if (badge.imageUrl) { %>
              <img src="<%= badge.imageUrl %>" alt="" loading="lazy" />
            <% } else if (badge.emoji) { %>
              <%= badge.emoji %>
            <% } %>
          </div>
          <div class="badge-card__summary">
            <h2 class="badge-card__title"><%= badge.name %></h2>
            <% if (badge.description) { %>
              <p class="badge-card__description"><%= badge.description %></p>
            <% } else { %>
              <p class="badge-card__description text-muted">Aucune description fournie.</p>
            <% } %>
            <div class="badge-card__meta">
              <span class="badge">
                <%= badge.assignmentCount %> d√©tenteur<%= badge.assignmentCount > 1 ? 's' : '' %>
              </span>
              <% if (badge.isAutomatic) { %>
                <span class="badge badge-automatic" title="Attribu√© automatiquement">Automatique</span>
              <% } %>
            </div>
          </div>
        </header>

        <% if (canEditBadges && !badge.isAutomatic) { %>
          <section class="badge-card__section">
            <h3 class="badge-card__section-title">Modifier ce badge</h3>
            <form method="post" action="/admin/badges/<%= badge.snowflakeId %>/update" class="badge-card__form">
              <%- include('../partials/csrf_field') %>
              <div class="grid grid-cols-responsive gap-sm">
                <label class="stack-form">
                  <span class="text-sm text-muted">Nom</span>
                  <input type="text" name="name" maxlength="80" value="<%= badge.name %>" required />
                </label>
                <label class="stack-form">
                  <span class="text-sm text-muted">Emoji</span>
                  <input type="text" name="emoji" maxlength="16" value="<%= badge.emoji %>" />
                </label>
                <label class="stack-form">
                  <span class="text-sm text-muted">Image (URL)</span>
                  <input type="url" name="imageUrl" maxlength="500" value="<%= badge.imageUrl || '' %>" />
                </label>
              </div>
              <%- include('../partials/uploadHelper') %>
              <label class="stack-form mt-sm">
                <span class="text-sm text-muted">Description</span>
                <textarea name="description" rows="2" maxlength="240"><%= badge.description %></textarea>
              </label>
              <div class="badge-card__actions">
                <button class="btn secondary" data-icon="üíæ" type="submit">Mettre √† jour</button>
              </div>
            </form>
            <% if (canDeleteBadges) { %>
              <form
                method="post"
                action="/admin/badges/<%= badge.snowflakeId %>/delete"
                onsubmit="return confirm('Supprimer ce badge ?');"
                class="badge-card__form badge-card__delete"
              >
                <%- include('../partials/csrf_field') %>
                <button class="btn danger" data-icon="üóëÔ∏è" type="submit">Supprimer</button>
              </form>
            <% } %>
          </section>
        <% } else if (canDeleteBadges && !badge.isAutomatic) { %>
          <form method="post" action="/admin/badges/<%= badge.snowflakeId %>/delete" onsubmit="return confirm('Supprimer ce badge ?');" class="badge-card__section badge-card__form">
            <%- include('../partials/csrf_field') %>
            <button class="btn danger" data-icon="üóëÔ∏è" type="submit">Supprimer ce badge</button>
          </form>
        <% } else if (badge.isAutomatic) { %>
          <p class="badge-card__section text-muted">Ce badge est g√©r√© automatiquement et ne peut pas √™tre modifi√©.</p>
        <% } %>

        <% if (canAssignBadges && !badge.isAutomatic) { %>
          <section class="badge-card__section">
            <h3 class="badge-card__section-title">Attribuer le badge</h3>
            <form method="post" action="/admin/badges/<%= badge.snowflakeId %>/assign" class="badge-card__form badge-card__assign">
              <%- include('../partials/csrf_field') %>
              <label class="stack-form">
                <span class="text-sm text-muted">Nom d'utilisateur</span>
                <input type="text" name="username" maxlength="32" placeholder="utilisateur" required />
              </label>
              <button class="btn success" data-icon="üèÖ" type="submit">Attribuer</button>
            </form>
          </section>
        <% } %>

        <section class="badge-card__section">
          <h3 class="badge-card__section-title">D√©tenteurs</h3>
          <% if (badge.assignees && badge.assignees.length) { %>
            <ul class="badge-card__assignees">
              <% badge.assignees.forEach(function (assignment) { %>
                <% const assigneeRole = assignment.userRole || null; %>
                <% const assigneeColor = assigneeRole && assigneeRole.color ? assigneeRole.color : null; %>
                <% const assigneeClasses = ['user-handle']; %>
                <% const assigneeStyle = assigneeColor && assigneeColor.hasColor ? assigneeColor.style : ''; %>
                <% if (assigneeColor && assigneeColor.hasColor) { assigneeClasses.push('role-colored-text'); assigneeClasses.push(assigneeColor.className); } %>
                <% const assigneeBadges = Array.isArray(assigneeRole?.badges) ? assigneeRole.badges : []; %>
                <li class="badge-card__assignee">
                  <div>
                    <span class="user-handle-decorated">
                      <strong class="<%= assigneeClasses.join(' ') %>" style="<%= assigneeStyle %>"><%= assignment.username %></strong>
                      <%- include('../partials/userBadges', {
                        badges: assigneeBadges,
                        listClass: ['user-handle-badges', 'user-handle-badges--inline'],
                        itemClass: 'user-handle-badge-item',
                        iconClass: 'user-handle-badge-icon',
                        srOnlyClass: 'sr-only',
                        ariaLabel: "Badges de l'utilisateur",
                      }) %>
                    </span>
                    <% if (assignment.displayName && assignment.displayName.trim()) { %>
                      <span class="text-muted">(<%= assignment.displayName %>)</span>
                    <% } %>
                    <% if (assignment.assignedAt) { %>
                      <span class="text-muted">¬∑ <%= new Date(assignment.assignedAt).toLocaleDateString('fr-FR') %></span>
                    <% } %>
                  </div>
                  <% if (canRevokeBadges && !badge.isAutomatic) { %>
                    <form method="post" action="/admin/badges/<%= badge.snowflakeId %>/revoke" class="badge-card__revoke" onsubmit="return confirm('Retirer ce badge ?');">
                      <%- include('../partials/csrf_field') %>
                      <input type="hidden" name="username" value="<%= assignment.username %>" />
                      <button class="btn danger" data-icon="‚úñ" type="submit">Retirer</button>
                    </form>
                  <% } %>
                </li>
              <% }); %>
            </ul>
          <% } else { %>
            <p class="text-muted">Aucun utilisateur ne poss√®de encore ce badge.</p>
          <% } %>
          <% if (badge.isAutomatic) { %>
            <p class="text-muted mt-xs">Les nouveaux d√©tenteurs seront ajout√©s automatiquement selon les crit√®res du badge.</p>
          <% } %>
        </section>
      </article>
    <% }); %>
  </div>
<% } %>

<% title = page.title; %>
<div class="page-header card">
  <div class="heading">
    <h1 class="page-title"><%= page.title %></h1>
    <div class="meta">
      <span>Créé: <%= page.created_at %></span>
      <% if (page.updated_at) { %><span>• Modifié: <%= page.updated_at %></span><% } %>
      <span>• Likes: <strong><%= page.likes %></strong></span>
      <span>• Commentaires: <strong><%= comments.length %></strong></span>
      <span>• Vues: <strong><%= page.views %></strong></span>
    </div>
  </div>
  <div class="actions">
    <form action="/wiki/<%= page.slug_id %>/like" method="post">
      <% if (page.userLiked) { %>
        <button class="btn unlike" data-icon="💔">Retirer le like (<%= page.likes %>)</button>
      <% } else { %>
        <button class="btn like" data-icon="💖">Like (<%= page.likes %>)</button>
      <% } %>
    </form>
    <button class="btn copy" data-icon="🔗" onclick="navigator.clipboard.writeText(location.origin + '/wiki/<%= page.slug_id %>')">Copier le lien</button>
    <% const currentUser = typeof user !== 'undefined' && user ? user : null; %>
    <% if (currentUser && currentUser.is_admin) { %>
      <a class="btn" data-icon="✏️" href="/edit/<%= page.slug_id %>">Éditer</a>
      <a class="btn" data-icon="📜" href="/wiki/<%= page.slug_id %>/history">Historique</a>
      <form action="/delete/<%= page.slug_id %>" method="post" onsubmit="return confirm('Supprimer ?')">
        <input type="hidden" name="_method" value="DELETE" />
        <button class="btn danger" data-icon="🗑️">Supprimer</button>
      </form>
    <% } %>
  </div>
</div>

<div class="card prose">
  <div><%- html %></div>
</div>

<% if (tags && tags.length) { %>
  <div class="card">
    <strong>Tags</strong>
    <div class="tags-row" style="margin-top:8px">
      <% tags.forEach(t => { %>
        <a class="tag" href="/tags/<%= t %>"><%= t %></a>
      <% }) %>
    </div>
  </div>
<% } %>

<% const commentValues = (commentFeedback && commentFeedback.values) || {}; %>
<section class="card comments" id="comments">
  <h2 style="margin-top:0">Commentaires</h2>
  <% if (comments && comments.length) { %>
    <ul class="comment-list">
      <% comments.forEach(c => { %>
        <li class="comment">
          <div class="comment-meta">
            <strong><%= c.author || 'Anonyme' %></strong>
            <span>· <%= new Date(c.created_at).toLocaleString('fr-FR') %></span>
          </div>
          <div class="comment-body"><%= c.body %></div>
          <% if (ownCommentTokens && ownCommentTokens[c.snowflake_id]) { %>
            <div class="comment-actions">
              <a class="btn secondary" data-icon="✏️" href="/wiki/<%= page.slug_id %>/comments/<%= c.snowflake_id %>/edit">Modifier</a>
              <form method="post" action="/wiki/<%= page.slug_id %>/comments/<%= c.snowflake_id %>/delete" onsubmit="return confirm('Supprimer ce commentaire ?');">
                <button class="btn danger" data-icon="🗑️" type="submit">Supprimer</button>
              </form>
            </div>
          <% } %>
        </li>
      <% }) %>
    </ul>
  <% } else { %>
    <p class="comment-empty">Aucun commentaire pour le moment.</p>
  <% } %>

  <form class="comment-form" method="post" action="/wiki/<%= page.slug_id %>/comments">
    <div class="field">
      <label for="comment-author">Nom ou pseudo (facultatif)</label>
      <input id="comment-author" type="text" name="author" maxlength="80" value="<%= commentValues.author || '' %>">
    </div>
    <div class="field">
      <label for="comment-body">Votre message <span style="color:#f87171;">*</span></label>
      <textarea id="comment-body" name="body" rows="5" maxlength="2000" required><%= commentValues.body || '' %></textarea>
    </div>
    <div class="field">
      <label for="comment-captcha">Question anti-spam : 3 + 4 = ? <span style="color:#f87171;">*</span></label>
      <input id="comment-captcha" type="text" name="captcha" inputmode="numeric" pattern="[0-9]*" required>
    </div>
    <div class="field honeypot">
      <label for="comment-website">Ne pas remplir</label>
      <input id="comment-website" type="text" name="website" tabindex="-1" autocomplete="off">
    </div>
    <button class="btn success" data-icon="📨" type="submit">Envoyer mon commentaire</button>
  </form>
</section>

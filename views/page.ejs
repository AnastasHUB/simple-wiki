<% title = page.title; %>
<div class="page-header card">
  <div class="heading">
    <h1 class="page-title"><%= page.title %></h1>
    <div class="meta">
      <span>Cr√©√©: <%= page.created_at %></span>
      <% if (page.updated_at) { %><span>‚Ä¢ Modifi√©: <%= page.updated_at %></span><% } %>
      <span>‚Ä¢ Likes: <strong data-like-count-for="<%= page.slug_id %>"><%= page.likes %></strong></span>
      <span>‚Ä¢ Commentaires: <strong><%= commentPagination.totalItems %></strong></span>
      <span>‚Ä¢ Vues: <strong><%= page.views %></strong></span>
    </div>
  </div>
  <div class="actions">
    <form action="/wiki/<%= page.slug_id %>/like" method="post" data-like-form-for="<%= page.slug_id %>">
      <button
        class="btn <%= page.userLiked ? 'unlike' : 'like' %>"
        data-icon="<%= page.userLiked ? 'üíî' : 'üíñ' %>"
        data-label-liked="Retirer le like"
        data-label-unliked="Like"
        type="submit"
      >
        <%= page.userLiked ? 'Retirer le like' : 'Like' %> (<%= page.likes %>)
      </button>
    </form>
    <button class="btn copy" data-icon="üîó" onclick="navigator.clipboard.writeText(location.origin + '/wiki/<%= page.slug_id %>')">Copier le lien</button>
    <% const permissionFlags = permissions && typeof permissions === 'object' ? permissions : {}; %>
    <% const currentUser = typeof user !== 'undefined' && user ? user : null; %>
    <% const isAdmin = !!permissionFlags.is_admin; %>
    <% const canPublishDirectly = !!(permissionFlags.is_admin || permissionFlags.is_contributor); %>
    <% const canSubmitEdits = !!permissionFlags.can_submit_pages; %>
    <% if (isAdmin) { %>
      <a class="btn" data-icon="‚úèÔ∏è" href="/edit/<%= page.slug_id %>">√âditer</a>
      <a class="btn" data-icon="üìú" href="/wiki/<%= page.slug_id %>/history">Historique</a>
      <form action="/delete/<%= page.slug_id %>" method="post" onsubmit="return confirm('Supprimer ?')">
        <input type="hidden" name="_method" value="DELETE" />
        <button class="btn danger" data-icon="üóëÔ∏è">Supprimer</button>
      </form>
    <% } else if (canPublishDirectly) { %>
      <a class="btn" data-icon="‚úèÔ∏è" href="/edit/<%= page.slug_id %>">√âditer</a>
    <% } else if (canSubmitEdits) { %>
      <a class="btn" data-icon="‚úèÔ∏è" href="/edit/<%= page.slug_id %>">Sugg√©rer une modification</a>
    <% } %>
  </div>
</div>

<div class="card prose">
  <div><%- html %></div>
</div>

<% if (tags && tags.length) { %>
  <div class="card">
    <strong>Tags</strong>
    <div class="tags-row mt-xs">
      <% tags.forEach(t => { %>
        <a class="tag" href="/tags/<%= t %>"><%= t %></a>
      <% }) %>
    </div>
  </div>
<% } %>

  <% const commentUser = typeof user !== 'undefined' && user ? user : null; %>
  <% const commentPermissionFlags = permissions && typeof permissions === 'object' ? permissions : {}; %>
  <% const canComment = !!commentPermissionFlags.can_comment; %>
  <% const adminPreferredName = commentUser && commentPermissionFlags.is_admin
    ? (commentUser.display_name || commentUser.username)
    : null; %>
  <% const commentValues = (commentFeedback && commentFeedback.values) || {}; %>
  <% const commentAuthorValue = adminPreferredName || commentValues.author || ''; %>
  <% const commentRole = commentUser && commentUser.role_color ? commentUser.role_color : null; %>
  <% const commentRoleClasses = ['user-handle']; %>
  <% const commentRoleStyle = commentRole && commentRole.hasColor ? commentRole.style : ''; %>
  <% if (commentRole && commentRole.hasColor) { commentRoleClasses.push('role-colored-text'); commentRoleClasses.push(commentRole.className); } %>
<section class="card comments" id="comments">
  <h2 class="mt-0">Commentaires</h2>
  <% if (comments && comments.length) { %>
    <ul class="comment-list">
      <% comments.forEach(c => { %>
        <li class="comment">
          <div class="comment-meta">
            <% const authorClasses = ['comment-author']; %>
            <% if (c.isAdminAuthor) { authorClasses.push('comment-author--admin'); } %>
            <strong class="<%= authorClasses.join(' ') %>">
              <%= c.author || 'Anonyme' %>
              <% if (c.isAdminAuthor) { %>
                <span class="comment-author-badge" title="Administrateur">‚≠ê</span>
              <% } %>
            </strong>
            <span>¬∑ <%= new Date(c.created_at).toLocaleString('fr-FR') %></span>
            <% if (c.ipProfile) { %>
              <span>
                ¬∑
                <a class="comment-ip-profile" href="/profiles/ip/<%= c.ipProfile.hash %>">
                  Profil IP #<%= c.ipProfile.shortHash %>
                </a>
              </span>
            <% } %>
          </div>
          <div class="comment-body"><%= c.body %></div>
          <% if (ownCommentTokens && ownCommentTokens[c.snowflake_id]) { %>
            <div class="comment-actions">
              <a class="btn secondary" data-icon="‚úèÔ∏è" href="/wiki/<%= page.slug_id %>/comments/<%= c.snowflake_id %>/edit">Modifier</a>
              <form method="post" action="/wiki/<%= page.slug_id %>/comments/<%= c.snowflake_id %>/delete" onsubmit="return confirm('Supprimer ce commentaire ?');">
                <button class="btn danger" data-icon="üóëÔ∏è" type="submit">Supprimer</button>
              </form>
            </div>
          <% } %>
        </li>
      <% }) %>
    </ul>
  <% } else { %>
    <p class="comment-empty">Aucun commentaire pour le moment.</p>
  <% } %>

  <% if (commentPagination && commentPagination.totalItems > 0) { %>
    <div class="table-footer comment-pagination">
      <div class="per-page-control">
        <label for="comments-per-page" class="nowrap">Commentaires par page</label>
        <select
          id="comments-per-page"
          onchange="if (this.value) window.location.href = this.value;"
        >
          <% commentPagination.perPageOptionLinks.forEach(option => { %>
            <option value="<%= option.url %>#comments" <%= option.selected ? 'selected' : '' %>><%= option.value %></option>
          <% }) %>
        </select>
      </div>
      <span>Page <%= commentPagination.page %> sur <%= commentPagination.totalPages %></span>
      <div class="pager">
        <% if (commentPagination.hasPrevious) { %>
          <a class="btn" data-icon="‚¨ÖÔ∏è" href="<%= commentPagination.previousUrl %>#comments">Pr√©c√©dent</a>
        <% } else { %>
          <span class="btn" data-icon="‚¨ÖÔ∏è" aria-disabled="true">Pr√©c√©dent</span>
        <% } %>
        <% if (commentPagination.hasNext) { %>
          <a class="btn" data-icon="‚û°Ô∏è" href="<%= commentPagination.nextUrl %>#comments">Suivant</a>
        <% } else { %>
          <span class="btn" data-icon="‚û°Ô∏è" aria-disabled="true">Suivant</span>
        <% } %>
      </div>
    </div>
  <% } %>

  <% if (!canComment) { %>
    <p class="text-muted">Les commentaires sont d√©sactiv√©s pour votre r√¥le.</p>
  <% } else { %>
  <form class="comment-form" method="post" action="/wiki/<%= page.slug_id %>/comments">
    <% if (adminPreferredName) { %>
      <div class="field">
        <p class="text-muted">
          Vous commentez en tant que <strong class="<%= commentRoleClasses.join(' ') %>" style="<%= commentRoleStyle %>"><%= commentAuthorValue %></strong>.
        </p>
        <input type="hidden" name="author" value="<%= commentAuthorValue %>">
      </div>
    <% } else { %>
      <div class="field">
        <label for="comment-author">Nom ou pseudo (facultatif)</label>
        <input
          id="comment-author"
          type="text"
          name="author"
          maxlength="80"
          value="<%= commentAuthorValue %>"
        >
      </div>
    <% } %>
    <div class="field">
      <label for="comment-body">Votre message <span class="text-required">*</span></label>
      <textarea id="comment-body" name="body" rows="5" maxlength="2000" required><%= commentValues.body || '' %></textarea>
    </div>
    <div class="field">
      <label for="comment-captcha">Question anti-spam : 3 + 4 = ? <span class="text-required">*</span></label>
      <input id="comment-captcha" type="text" name="captcha" inputmode="numeric" pattern="[0-9]*" required>
    </div>
    <div class="field honeypot">
      <label for="comment-website">Ne pas remplir</label>
      <input id="comment-website" type="text" name="website" tabindex="-1" autocomplete="off">
    </div>
    <button class="btn success" data-icon="üì®" type="submit">Envoyer mon commentaire</button>
  </form>
  <% } %>
</section>

<% title = 'Tag ¬∑ ' + tag; %>
<h1>Tag: <%= tag %></h1>

<% if (tagVisibility && tagVisibility.enabled) { %>
  <form class="card mb-md" method="post" action="/tags/<%= encodeURIComponent(tag) %>/visibility">
    <%- include('partials/csrf_field') %>
    <header class="card-header">
      <h2 class="card-title">Visibilit√© du tag</h2>
    </header>
    <div class="card-body">
      <p class="mb-sm">
        S√©lectionnez les r√¥les autoris√©s √† consulter ce tag. Laissez vide pour le rendre accessible √† tout le monde.
      </p>
      <label class="mb-xs" for="tag-visible-roles">R√¥les autoris√©s</label>
      <select id="tag-visible-roles" name="visible_roles" multiple size="6">
        <% (tagVisibility.options || []).forEach(function(option) { %>
          <option value="<%= option.value %>" <%= option.selected ? 'selected' : '' %>>
            <%= option.label %>
          </option>
        <% }); %>
      </select>
      <% if (tagVisibility.hasSelection) { %>
        <p class="editor-hint mt-xs">
          Actuellement limit√© √†&nbsp;: <strong><%= tagVisibility.selectedLabels.join(', ') %></strong>
        </p>
      <% } else { %>
        <p class="editor-hint mt-xs">Accessible √† tous les r√¥les.</p>
      <% } %>
    </div>
    <footer class="card-footer">
      <button class="btn primary" data-icon="üíæ" type="submit">Mettre √† jour la visibilit√©</button>
    </footer>
  </form>
<% } %>

<div class="search-meta">
  <p><strong><%= total %></strong> article<%= total > 1 ? 's' : '' %> trouv√©<%= total > 1 ? 's' : '' %> pour ce tag.</p>
  <% const perPageFieldId = `${pagination.pageParam}-per-page`; %>
  <form class="page-size" method="get">
    <input type="hidden" name="<%= pagination.pageParam %>" value="1">
    <% if (pagination.preservedQuery && pagination.preservedQuery.length) { %>
      <% pagination.preservedQuery.forEach(pair => { %>
        <input type="hidden" name="<%= pair.name %>" value="<%= pair.value %>">
      <% }) %>
    <% } %>
    <label for="<%= perPageFieldId %>">Articles par page</label>
    <select id="<%= perPageFieldId %>" name="<%= pagination.perPageParam %>" onchange="this.form.submit()">
      <% pagination.perPageOptions.forEach(option => { %>
        <option value="<%= option %>" <%= option === pagination.perPage ? 'selected' : '' %>><%= option %></option>
      <% }) %>
    </select>
  </form>
</div>

<div class="article-grid">
  <% if (!pages.length) { %><div class="card">Aucun article.</div><% } %>
  <% pages.forEach(p => { const tags = (p.tagsCsv||'').split(',').filter(Boolean); %>
    <div class="card">
      <h3><strong><%= p.title %></strong></h3>
      <% if (p.excerpt) { %>
        <div class="excerpt">
          <div class="excerpt-body"><%- p.excerpt %></div>
        </div>
      <% } %>
      <% if (tags.length) { %>
        <div class="tags-row">
          <% tags.forEach(t => { %><a class="tag" href="/tags/<%= t %>"><%= t %></a><% }) %>
        </div>
      <% } %>
      <div class="page-stats" aria-label="Statistiques de l‚Äôarticle">
        <span title="Likes">üíñ <strong data-like-count-for="<%= p.slug_id %>"><%= p.likes %></strong></span>
        <span title="Commentaires">üí¨ <strong><%= p.comment_count %></strong></span>
        <span title="Vues">üëÅÔ∏è <strong><%= p.views %></strong></span>
      </div>
      <div class="actions">
        <a class="btn success" data-icon="üìñ" href="/wiki/<%= p.slug_id %>">Ouvrir l‚Äôarticle</a>
        <form action="/wiki/<%= p.slug_id %>/like" method="post" data-like-form-for="<%= p.slug_id %>">
          <%- include('partials/csrf_field') %>
          <button
            class="btn <%= p.userLiked ? 'unlike' : 'like' %>"
            data-icon="<%= p.userLiked ? 'üíî' : 'üíñ' %>"
            data-label-liked="Retirer"
            data-label-unliked="Like"
            type="submit"
          >
            <%= p.userLiked ? 'Retirer' : 'Like' %> (<%= p.likes %>)
          </button>
        </form>
        <button class="btn copy" data-icon="üîó" onclick="navigator.clipboard.writeText(location.origin + '/wiki/<%= p.slug_id %>')">Copier le lien</button>
      </div>
    </div>
  <% }) %>
</div>

<div class="actions pagination">
  <span class="pagination-status">
    Page <strong><%= pagination.page %></strong> / <%= pagination.totalPages %>
  </span>
  <div class="pager">
    <% if (pagination.hasPrevious) { %>
      <a class="btn" data-icon="‚¨ÖÔ∏è" href="<%= pagination.previousUrl %>">Pr√©c√©dent</a>
    <% } else { %>
      <span class="btn" data-icon="‚¨ÖÔ∏è" aria-disabled="true">Pr√©c√©dent</span>
    <% } %>
    <% if (pagination.hasNext) { %>
      <a class="btn" data-icon="‚û°Ô∏è" href="<%= pagination.nextUrl %>">Suivant</a>
    <% } else { %>
      <span class="btn" data-icon="‚û°Ô∏è" aria-disabled="true">Suivant</span>
    <% } %>
  </div>
</div>

<% const pageTitle = `Profil IP #${profile.shortHash}`; %>
<% title = pageTitle; %>
<% const preferences = profile.preferences || {}; %>
<% const publicName = preferences.displayName || null; %>
<% const defaultCommentName = preferences.commentAuthor || ''; %>
<% const commentSortPref = preferences.commentSort === 'oldest' ? 'oldest' : 'newest'; %>
<section class="card ip-profile-card">
  <header class="ip-profile-header">
    <div class="ip-profile-title-block">
      <div>
        <span class="ip-profile-id">Profil IP</span>
        <h1 class="mt-0">#<%= profile.shortHash %></h1>
      </div>
      <% if (publicName) { %>
        <p class="ip-profile-display-name">Nom public&nbsp;: <strong><%= publicName %></strong></p>
      <% } %>
    </div>
    <p class="text-muted">
      Ce profil regroupe les activit√©s publiques associ√©es √† une adresse IP. L'adresse IP r√©elle est hach√©e afin de prot√©ger l'anonymat des contributeurs non connect√©s.
    </p>
    <% if (isOwner) { %>
      <p class="ip-profile-owner-note">
        Vous consultez votre propre profil IP. Seules les contributions publiques (commentaires approuv√©s, likes, vues et propositions) sont visibles ici.
      </p>
    <% } %>
  </header>

  <% const rep = profile.reputation || {}; %>
  <% const repStatus = rep.status || 'unknown'; %>
  <% const repLabel = repStatus === 'suspicious' ? 'IP suspecte' : repStatus === 'safe' ? 'IP valid√©e' : repStatus === 'clean' ? 'IP neutre' : 'Statut inconnu'; %>
  <% let repClasses = 'notice ip-profile-reputation'; %>
  <% if (repStatus === 'suspicious') { repClasses += ' error'; } else if (repStatus === 'safe' || repStatus === 'clean') { repClasses += ' success'; } %>
  <% const pillClass = repStatus === 'suspicious' ? 'status-pill suspicious' : repStatus === 'safe' ? 'status-pill safe' : repStatus === 'clean' ? 'status-pill clean' : 'status-pill pending'; %>
  <div class="<%= repClasses %>">
    <div class="ip-profile-reputation-header">
      <span class="<%= pillClass %>"><%= repLabel %></span>
      <% if (rep.lastCheckedAt) { %>
        <span class="ip-profile-reputation-meta">Derni√®re v√©rification : <%= new Date(rep.lastCheckedAt).toLocaleString('fr-FR') %></span>
      <% } %>
    </div>
    <p class="ip-profile-reputation-text">
      <%= rep.summary || "Aucun signal particulier n'a √©t√© relev√© pour cette adresse IP." %>
    </p>
  </div>

  <% if (isOwner) { %>
    <section class="ip-profile-section ip-profile-preferences">
      <div class="ip-profile-section-heading">
        <h2>Personnaliser mon profil</h2>
        <p class="text-muted">
          Choisissez le nom affich√© publiquement, le pseudo propos√© dans les formulaires de commentaire et l'ordre par d√©faut des discussions.
        </p>
      </div>
      <form class="ip-profile-preferences-form" method="post" action="/profiles/ip/<%= profile.hash %>/preferences">
        <div class="stack-form">
          <label for="pref-display-name">Nom public</label>
          <input id="pref-display-name" type="text" name="displayName" maxlength="80" value="<%= publicName || '' %>" placeholder="Ex. Chroniqueur nocturne">
          <p class="help-text">Ce nom appara√Æt en t√™te de votre profil public.</p>
        </div>
        <div class="stack-form">
          <label for="pref-comment-name">Nom propos√© pour mes commentaires</label>
          <input id="pref-comment-name" type="text" name="commentName" maxlength="80" value="<%= defaultCommentName %>" placeholder="Ex. Auteur invit√©">
          <p class="help-text">Il sera pr√©-rempli dans le formulaire de commentaire lorsque vous r√©digez un message.</p>
        </div>
        <div class="stack-form">
          <label for="pref-comment-sort">Ordre d'affichage des commentaires</label>
          <select id="pref-comment-sort" name="commentSort">
            <option value="newest" <%= commentSortPref === 'newest' ? 'selected' : '' %>>Plus r√©cent au plus ancien</option>
            <option value="oldest" <%= commentSortPref === 'oldest' ? 'selected' : '' %>>Plus ancien au plus r√©cent</option>
          </select>
        </div>
        <button class="btn" data-icon="üíæ" type="submit">Enregistrer mes pr√©f√©rences</button>
      </form>
    </section>
  <% } %>

 <% const actionSanctions = {}; %>
 <% (profile.bans || []).forEach((ban) => { %>
   <% if (ban.scope === 'action' && ban.value) { %>
     <% actionSanctions[ban.value] = ban; %>
   <% } %>
 <% }); %>

  <dl class="ip-profile-details">
    <div>
      <dt>Profil cr√©√©</dt>
      <dd><%= profile.createdAt ? new Date(profile.createdAt).toLocaleString('fr-FR') : 'Inconnu' %></dd>
    </div>
    <div>
      <dt>Derni√®re activit√©</dt>
      <dd><%= profile.lastSeenAt ? new Date(profile.lastSeenAt).toLocaleString('fr-FR') : 'Inconnue' %></dd>
    </div>
  </dl>

  <ul class="stat-grid ip-profile-stats">
    <li class="ip-profile-stat">
      <span class="ip-profile-stat-icon" aria-hidden="true">üëÅÔ∏è</span>
      <span class="label">
        Vues enregistr√©es
        <% if (actionSanctions.view) { %>
          <span class="status-pill rejected ip-profile-sanction" title="Cette action est actuellement bloqu√©e.">Sanction</span>
        <% } %>
      </span>
      <strong><%= profile.stats.views.total %></strong>
      <span class="stat-sub">Pages distinctes : <strong><%= profile.stats.views.uniquePages %></strong></span>
      <% if (profile.stats.views.lastAt) { %>
        <span class="stat-sub">Derni√®re vue : <%= new Date(profile.stats.views.lastAt).toLocaleString('fr-FR') %></span>
      <% } %>
      <% if (actionSanctions.view?.reason) { %>
        <span class="stat-sub sanction-reason">Motif : <%= actionSanctions.view.reason %></span>
      <% } %>
    </li>
    <li class="ip-profile-stat">
      <span class="ip-profile-stat-icon" aria-hidden="true">‚ù§Ô∏è</span>
      <span class="label">
        Likes
        <% if (actionSanctions.like) { %>
          <span class="status-pill rejected ip-profile-sanction" title="Cette action est actuellement bloqu√©e.">Sanction</span>
        <% } %>
      </span>
      <strong><%= profile.stats.likes.total %></strong>
      <span class="stat-sub">Pages distinctes : <strong><%= profile.stats.likes.uniquePages %></strong></span>
      <% if (profile.stats.likes.lastAt) { %>
        <span class="stat-sub">Dernier like : <%= new Date(profile.stats.likes.lastAt).toLocaleString('fr-FR') %></span>
      <% } %>
      <% if (actionSanctions.like?.reason) { %>
        <span class="stat-sub sanction-reason">Motif : <%= actionSanctions.like.reason %></span>
      <% } %>
    </li>
    <li class="ip-profile-stat">
      <span class="ip-profile-stat-icon" aria-hidden="true">üí¨</span>
      <span class="label">
        Commentaires approuv√©s
        <% if (actionSanctions.comment) { %>
          <span class="status-pill rejected ip-profile-sanction" title="Cette action est actuellement bloqu√©e.">Sanction</span>
        <% } %>
      </span>
      <strong><%= profile.stats.comments.total %></strong>
      <% if (profile.stats.comments.lastAt) { %>
        <span class="stat-sub">Dernier commentaire : <%= new Date(profile.stats.comments.lastAt).toLocaleString('fr-FR') %></span>
      <% } else { %>
        <span class="stat-sub">Aucun commentaire approuv√© pour le moment.</span>
      <% } %>
      <% if (actionSanctions.comment?.reason) { %>
        <span class="stat-sub sanction-reason">Motif : <%= actionSanctions.comment.reason %></span>
      <% } %>
    </li>
    <li class="ip-profile-stat">
      <span class="ip-profile-stat-icon" aria-hidden="true">üìù</span>
      <span class="label">
        Propositions
        <% if (actionSanctions.contribute) { %>
          <span class="status-pill rejected ip-profile-sanction" title="Cette action est actuellement bloqu√©e.">Sanction</span>
        <% } %>
      </span>
      <strong><%= profile.stats.submissions.total %></strong>
      <% const submissionStatuses = profile.stats.submissions.byStatus || {}; %>
      <% if (Object.keys(submissionStatuses).length) { %>
        <span class="stat-sub">
          <% Object.entries(submissionStatuses).forEach(([status, total], index, entries) => { %>
            <%= status %> : <strong><%= total %></strong><%= index < entries.length - 1 ? ' ¬∑ ' : '' %>
          <% }) %>
        </span>
      <% } else { %>
        <span class="stat-sub">Aucune proposition enregistr√©e.</span>
      <% } %>
      <% if (profile.stats.submissions.lastAt) { %>
        <span class="stat-sub">Derni√®re proposition : <%= new Date(profile.stats.submissions.lastAt).toLocaleString('fr-FR') %></span>
      <% } %>
      <% if (actionSanctions.contribute?.reason) { %>
        <span class="stat-sub sanction-reason">Motif : <%= actionSanctions.contribute.reason %></span>
      <% } %>
    </li>
  </ul>

  <section class="ip-profile-section">
    <h2>Commentaires r√©cents</h2>
    <% if (profile.recent.comments.length) { %>
      <ul class="ip-profile-activity">
        <% profile.recent.comments.forEach((item) => { %>
          <li>
            <div class="ip-profile-activity-meta">
              <a href="/wiki/<%= item.slug %>#comments"><%= item.pageTitle %></a>
              <time datetime="<%= item.createdAt %>"><%= new Date(item.createdAt).toLocaleString('fr-FR') %></time>
            </div>
            <% if (item.excerpt) { %>
              <p class="ip-profile-activity-text"><%= item.excerpt %></p>
            <% } %>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p class="text-muted">Aucun commentaire approuv√© n'est encore visible.</p>
    <% } %>
  </section>

  <section class="ip-profile-section">
    <h2>Likes r√©cents</h2>
    <% if (profile.recent.likes.length) { %>
      <ul class="ip-profile-activity">
        <% profile.recent.likes.forEach((item) => { %>
          <li>
            <div class="ip-profile-activity-meta">
              <a href="/wiki/<%= item.slug %>"><%= item.pageTitle %></a>
              <time datetime="<%= item.createdAt %>"><%= new Date(item.createdAt).toLocaleString('fr-FR') %></time>
            </div>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p class="text-muted">Aucun like enregistr√© pour l'instant.</p>
    <% } %>
  </section>

  <section class="ip-profile-section">
    <h2>Pages consult√©es r√©cemment</h2>
    <% if (profile.recent.views.length) { %>
      <ul class="ip-profile-activity">
        <% profile.recent.views.forEach((item) => { %>
          <li>
            <div class="ip-profile-activity-meta">
              <a href="/wiki/<%= item.slug %>"><%= item.pageTitle %></a>
              <time datetime="<%= item.createdAt %>"><%= new Date(item.createdAt).toLocaleString('fr-FR') %></time>
            </div>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p class="text-muted">Aucune vue enregistr√©e avec cette IP.</p>
    <% } %>
  </section>

  <section class="ip-profile-section">
    <h2>Propositions r√©centes</h2>
    <% if (profile.recent.submissions.length) { %>
      <ul class="ip-profile-activity">
        <% profile.recent.submissions.forEach((item) => { %>
          <li>
            <div class="ip-profile-activity-meta">
              <% if (item.slug) { %>
                <a href="/wiki/<%= item.slug %>"><%= item.pageTitle %></a>
              <% } else { %>
                <span><%= item.pageTitle || 'Proposition' %></span>
              <% } %>
              <time datetime="<%= item.createdAt %>"><%= new Date(item.createdAt).toLocaleString('fr-FR') %></time>
            </div>
            <p class="ip-profile-activity-text text-muted">
              Type : <strong><%= item.type %></strong> ¬∑ Statut : <strong><%= item.status %></strong>
            </p>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p class="text-muted">Aucune proposition n'a encore √©t√© envoy√©e avec cette IP.</p>
    <% } %>
  </section>
</section>

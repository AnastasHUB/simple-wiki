<% const displayTitle = `Profil IP #${profile.shortHash}`; %>
<% title = displayTitle; %>
<% const rep = profile.reputation || {}; %>
<% const repStatus = rep.status || 'unknown'; %>
<% const repLabel = repStatus === 'suspicious' ? 'IP suspecte' : repStatus === 'safe' ? 'IP valid√©e' : repStatus === 'clean' ? 'IP neutre' : 'Statut inconnu'; %>
<% let repClasses = 'ip-profile-reputation card-subtle notice'; %>
<% if (repStatus === 'suspicious') { repClasses += ' error'; } else if (repStatus === 'safe' || repStatus === 'clean') { repClasses += ' success'; } %>
<% const pillClass = repStatus === 'suspicious' ? 'status-pill suspicious' : repStatus === 'safe' ? 'status-pill safe' : repStatus === 'clean' ? 'status-pill clean' : 'status-pill pending'; %>
<% const activityClassName = 'ip-profile-activity'; %>
<% const claimContextData = typeof claimContext !== 'undefined' && claimContext ? claimContext : null; %>
<% const claimErrors = claimContextData && Array.isArray(claimContextData.errors) ? claimContextData.errors : []; %>
<% const claimValues = claimContextData && claimContextData.values && typeof claimContextData.values === 'object' ? claimContextData.values : {}; %>
<% const claimCaptchaConfig = claimContextData && claimContextData.captcha ? claimContextData.captcha : null; %>
<% const claimMode = claimContextData && typeof claimContextData.mode === 'string' ? claimContextData.mode : 'register'; %>
<% const claimDisabled = Boolean(claimContextData && claimContextData.disabled); %>
<% const showClaimForm = claimMode === 'register' && Boolean(claimContextData && claimContextData.showForm && isOwner && !profile.isClaimed); %>
<% const showLinkForm = claimMode === 'link' && Boolean(claimContextData && claimContextData.showLink && isOwner && !profile.isClaimed); %>
<% const linkUser = claimContextData && claimContextData.linkUser ? claimContextData.linkUser : null; %>
<% const linkUserLabel = linkUser ? (linkUser.displayName || linkUser.username || '') : ''; %>
<% const canShowClaimCta = Boolean(isOwner && !profile.isClaimed && !showClaimForm && !showLinkForm); %>
<% const claimedAtDate = profile.claim && profile.claim.claimedAt ? new Date(profile.claim.claimedAt) : null; %>

<section class="card ip-profile-card">
  <header class="ip-profile-header">
    <div>
      <span class="ip-profile-chip">Profil IP public</span>
      <h1 class="mt-0"><%= displayTitle %></h1>
      <p class="text-muted">
        Ce profil regroupe les activit√©s publiques associ√©es √† une adresse IP. L'adresse IP r√©elle est hach√©e afin de prot√©ger l'anonymat des contributeurs non connect√©s.
      </p>
    </div>
    <% if (isOwner) { %>
      <div class="ip-profile-owner-box">
        <p class="ip-profile-owner-note">
          Vous consultez votre propre profil IP. Seules les contributions publiques (commentaires approuv√©s, likes, vues et propositions) sont visibles ici.
        </p>
        <% if (profile.isClaimed) { %>
          <p class="ip-profile-owner-note success">
            Ce profil IP a √©t√© converti en compte utilisateur<% if (claimedAtDate) { %> le <%= claimedAtDate.toLocaleString('fr-FR') %><% } %>.
          </p>
        <% } else if (canShowClaimCta) { %>
          <div class="ip-profile-claim-actions">
            <p class="ip-profile-owner-note">
              Convertissez ce profil en compte utilisateur pour conserver vos contributions et vos permissions.
            </p>
            <a class="btn success" href="/profiles/ip/<%= profile.hash %>/claim" data-icon="‚ú®">Convertir en compte</a>
          </div>
        <% } %>
      </div>
    <% } else if (profile.isClaimed) { %>
      <div class="ip-profile-owner-box success">
        <p class="ip-profile-owner-note">
          Ce profil IP a √©t√© converti en compte utilisateur<% if (claimedAtDate) { %> le <%= claimedAtDate.toLocaleString('fr-FR') %><% } %>.
        </p>
      </div>
    <% } %>
  </header>

  <div class="ip-profile-summary-grid">
    <div class="<%= repClasses %>">
      <div class="ip-profile-reputation-header">
        <span class="<%= pillClass %>"><%= repLabel %></span>
        <% if (rep.lastCheckedAt) { %>
          <span class="ip-profile-reputation-meta">Derni√®re v√©rification : <%= new Date(rep.lastCheckedAt).toLocaleString('fr-FR') %></span>
        <% } %>
      </div>
      <p class="ip-profile-reputation-text">
        <%= rep.summary || "Aucun signal particulier n'a √©t√© relev√© pour cette adresse IP." %>
      </p>
    </div>
    <div class="ip-profile-meta-card card-subtle">
      <dl class="ip-profile-details">
        <div>
          <dt>Profil cr√©√©</dt>
          <dd><%= profile.createdAt ? new Date(profile.createdAt).toLocaleString('fr-FR') : 'Inconnu' %></dd>
        </div>
        <div>
          <dt>Derni√®re activit√©</dt>
          <dd><%= profile.lastSeenAt ? new Date(profile.lastSeenAt).toLocaleString('fr-FR') : 'Inconnue' %></dd>
        </div>
        <div>
          <dt>D√©tection automatique</dt>
          <dd>
            <% if (profile.bot?.isBot) { %>
              <span class="status-pill suspicious">Bot suspect√©</span>
              <% if (profile.bot?.reason) { %>
                <br /><small class="text-muted"><%= profile.bot.reason %></small>
              <% } %>
            <% } else { %>
              <span class="status-pill clean">Activit√© humaine</span>
            <% } %>
          </dd>
        </div>
        <% if (profile.bot?.userAgent) { %>
          <div>
            <dt>Dernier agent utilisateur</dt>
            <dd><small><%= profile.bot.userAgent %></small></dd>
          </div>
        <% } %>
        <div>
          <dt>Identifiant</dt>
          <dd>
            <code>#<%= profile.shortHash %></code>
            <% if (profile.id) { %>
              <br />
              <small>ID : <code><%= profile.id %></code></small>
            <% } %>
          </dd>
        </div>
      </dl>
    </div>
  </div>

  <% if (showLinkForm) { %>
    <section class="ip-profile-claim card-subtle">
      <h2>Associer ce profil √† votre compte</h2>
      <p>
        Vous √™tes connect√© en tant que
        <strong><%= linkUserLabel || 'votre compte' %></strong>. Associez ce profil IP
        pour regrouper vos activit√©s publiques sous le m√™me compte utilisateur.
      </p>
      <% if (claimErrors.length) { %>
        <div class="card error">
          <h3>Association impossible</h3>
          <ul>
            <% claimErrors.forEach(function (message) { %>
              <li><%= message %></li>
            <% }); %>
          </ul>
        </div>
      <% } %>
      <% if (claimDisabled) { %>
        <p class="text-muted">
          L'association de profils IP est temporairement indisponible. Merci de r√©essayer plus tard.
        </p>
      <% } else { %>
        <form
          method="post"
          action="/profiles/ip/<%= profile.hash %>/claim"
          class="stacked-form"
          id="ipLinkForm"
        >
          <%- include('partials/csrf_field') %>
          <input type="hidden" name="mode" value="link" />
          <p>
            L'adresse IP actuelle sera marqu√©e comme appartenant √† votre compte.
            Vous conserverez les contributions pass√©es associ√©es √† cette IP.
          </p>
          <div class="actions">
            <button class="btn success" type="submit" data-icon="üîó" id="ipLinkSubmit">
              Associer le profil
            </button>
          </div>
        </form>
      <% } %>
    </section>
  <% } %>

  <% if (showClaimForm) { %>
    <section class="ip-profile-claim card-subtle">
      <h2>Convertir ce profil en compte utilisateur</h2>
      <p>
        Cr√©ez un compte personnel pour conserver vos permissions, suivre vos contributions et acc√©der aux fonctionnalit√©s r√©serv√©es aux utilisateurs connect√©s.
      </p>
      <% if (claimErrors.length) { %>
        <div class="card error">
          <h3>Impossible de cr√©er le compte</h3>
          <ul>
            <% claimErrors.forEach(function (message) { %>
              <li><%= message %></li>
            <% }); %>
          </ul>
        </div>
      <% } %>
      <% if (claimDisabled) { %>
        <p class="text-muted">
          La conversion est temporairement indisponible. Merci de r√©essayer plus tard ou de contacter un administrateur.
        </p>
      <% } else { %>
        <form
          method="post"
          action="/profiles/ip/<%= profile.hash %>/claim"
          class="stacked-form"
          id="ipClaimForm"
        >
          <%- include('partials/csrf_field') %>
          <label for="ip-claim-username">Nom d'utilisateur</label>
          <input
            id="ip-claim-username"
            type="text"
            name="username"
            required
            minlength="3"
            maxlength="32"
            pattern="[A-Za-z0-9_.-]+"
            autocomplete="username"
            value="<%= claimValues.username ? claimValues.username : '' %>"
          />
          <p class="form-help">Autoris√©&nbsp;: lettres, chiffres, points, tirets et underscores.</p>

          <label for="ip-claim-password">Mot de passe</label>
          <input
            id="ip-claim-password"
            type="password"
            name="password"
            required
            minlength="8"
            autocomplete="new-password"
          />
          <p class="form-help">Utilisez un mot de passe robuste d'au moins 8 caract√®res.</p>

          <% if (claimCaptchaConfig) { %>
            <fieldset class="captcha-selector">
              <legend>V√©rification anti-robot</legend>
              <p>Compl√©tez le reCAPTCHA pour confirmer la cr√©ation du compte.</p>
              <div
                id="ip-claim-captcha"
                class="captcha-container"
                aria-live="polite"
                data-sitekey="<%= claimCaptchaConfig.siteKey %>"
                data-script="<%= claimCaptchaConfig.scriptUrl %>"
                data-global="<%= claimCaptchaConfig.global %>"
              ></div>
            </fieldset>
            <input type="hidden" name="captchaToken" id="ip-claim-captcha-token" required />
          <% } %>

          <div class="actions">
            <button class="btn success" type="submit" data-icon="‚ú®" id="ipClaimSubmit">
              Convertir le profil
            </button>
          </div>
        </form>
        <% if (claimCaptchaConfig) { %>
          <script>
            (function () {
              const container = document.getElementById("ip-claim-captcha");
              const tokenInput = document.getElementById("ip-claim-captcha-token");
              if (!container || !tokenInput) {
                return;
              }
              const siteKey = container.dataset.sitekey;
              const scriptUrl = container.dataset.script;
              const globalName = container.dataset.global;
              if (!siteKey || !scriptUrl || !globalName) {
                return;
              }

              function ensureScript(url, global) {
                if (window[global]) {
                  return Promise.resolve(window[global]);
                }
                if (window.__simpleWikiCaptchaLoader) {
                  return window.__simpleWikiCaptchaLoader;
                }
                window.__simpleWikiCaptchaLoader = new Promise((resolve, reject) => {
                  const script = document.createElement("script");
                  script.src = url;
                  script.async = true;
                  script.defer = true;
                  script.onload = () => {
                    const checkReady = () => {
                      if (window[global]) {
                        resolve(window[global]);
                      } else {
                        window.setTimeout(checkReady, 30);
                      }
                    };
                    checkReady();
                  };
                  script.onerror = () =>
                    reject(new Error("Impossible de charger le script du captcha."));
                  document.head.appendChild(script);
                });
                return window.__simpleWikiCaptchaLoader;
              }

              function renderCaptcha(library) {
                container.innerHTML = "";
                const placeholder = document.createElement("div");
                placeholder.className = "captcha-frame";
                container.appendChild(placeholder);

                function handleToken(token) {
                  tokenInput.value = token || "";
                }

                function handleError() {
                  tokenInput.value = "";
                }

                if (!library || typeof library.render !== "function") {
                  throw new Error("Captcha non support√©.");
                }

                library.render(placeholder, {
                  sitekey: siteKey,
                  callback: handleToken,
                  "expired-callback": handleError,
                  "error-callback": handleError,
                });
              }

              ensureScript(scriptUrl, globalName)
                .then((library) => {
                  renderCaptcha(library);
                })
                .catch((error) => {
                  console.error(error);
                  container.innerHTML =
                    '<p class="form-help error">Impossible de charger le captcha. Veuillez rafra√Æchir la page.</p>';
                });
            })();
          </script>
        <% } %>
      <% } %>
    </section>
  <% } else if (claimErrors.length && isOwner) { %>
    <div class="card error">
      <h2>Impossible de convertir le profil</h2>
      <ul>
        <% claimErrors.forEach(function (message) { %>
          <li><%= message %></li>
        <% }); %>
      </ul>
    </div>
  <% } %>

  <% const actionSanctions = {}; %>
  <% (profile.bans || []).forEach((ban) => { %>
    <% if (ban.scope === 'action' && ban.value) { %>
      <% actionSanctions[ban.value] = ban; %>
    <% } %>
  <% }); %>

  <ul class="stat-grid ip-profile-stats">
    <li class="ip-profile-stat">
      <span class="stat-icon" aria-hidden="true">üëÄ</span>
      <span class="label">
        Vues enregistr√©es
        <% if (actionSanctions.view) { %>
          <span class="status-pill rejected ip-profile-sanction" title="Cette action est actuellement bloqu√©e.">Sanction</span>
        <% } %>
      </span>
      <strong class="stat-value"><%= profile.stats.views.total %></strong>
      <span class="stat-sub">Pages distinctes : <strong><%= profile.stats.views.uniquePages %></strong></span>
      <% if (profile.stats.views.lastAt) { %>
        <span class="stat-sub">Derni√®re vue : <%= new Date(profile.stats.views.lastAt).toLocaleString('fr-FR') %></span>
      <% } %>
      <% if (actionSanctions.view?.reason) { %>
        <span class="stat-sub sanction-reason">Motif : <%= actionSanctions.view.reason %></span>
      <% } %>
    </li>
    <li class="ip-profile-stat">
      <span class="stat-icon" aria-hidden="true">üíñ</span>
      <span class="label">
        Likes
        <% if (actionSanctions.like) { %>
          <span class="status-pill rejected ip-profile-sanction" title="Cette action est actuellement bloqu√©e.">Sanction</span>
        <% } %>
      </span>
      <strong class="stat-value"><%= profile.stats.likes.total %></strong>
      <span class="stat-sub">Pages distinctes : <strong><%= profile.stats.likes.uniquePages %></strong></span>
      <% if (profile.stats.likes.lastAt) { %>
        <span class="stat-sub">Dernier like : <%= new Date(profile.stats.likes.lastAt).toLocaleString('fr-FR') %></span>
      <% } %>
      <% if (actionSanctions.like?.reason) { %>
        <span class="stat-sub sanction-reason">Motif : <%= actionSanctions.like.reason %></span>
      <% } %>
    </li>
    <li class="ip-profile-stat">
      <span class="stat-icon" aria-hidden="true">üí¨</span>
      <span class="label">
        Commentaires approuv√©s
        <% if (actionSanctions.comment) { %>
          <span class="status-pill rejected ip-profile-sanction" title="Cette action est actuellement bloqu√©e.">Sanction</span>
        <% } %>
      </span>
      <strong class="stat-value"><%= profile.stats.comments.total %></strong>
      <% if (profile.stats.comments.lastAt) { %>
        <span class="stat-sub">Dernier commentaire : <%= new Date(profile.stats.comments.lastAt).toLocaleString('fr-FR') %></span>
      <% } else { %>
        <span class="stat-sub">Aucun commentaire approuv√© pour le moment.</span>
      <% } %>
      <% if (actionSanctions.comment?.reason) { %>
        <span class="stat-sub sanction-reason">Motif : <%= actionSanctions.comment.reason %></span>
      <% } %>
    </li>
    <li class="ip-profile-stat">
      <span class="stat-icon" aria-hidden="true">üõ†Ô∏è</span>
      <span class="label">
        Propositions
        <% if (actionSanctions.contribute) { %>
          <span class="status-pill rejected ip-profile-sanction" title="Cette action est actuellement bloqu√©e.">Sanction</span>
        <% } %>
      </span>
      <strong class="stat-value"><%= profile.stats.submissions.total %></strong>
      <% const submissionStatuses = profile.stats.submissions.byStatus || {}; %>
      <% if (Object.keys(submissionStatuses).length) { %>
        <span class="stat-sub">
          <% Object.entries(submissionStatuses).forEach(([status, total], index, entries) => { %>
            <%= status %> : <strong><%= total %></strong><%= index < entries.length - 1 ? ' ¬∑ ' : '' %>
          <% }) %>
        </span>
      <% } else { %>
        <span class="stat-sub">Aucune proposition enregistr√©e.</span>
      <% } %>
      <% if (profile.stats.submissions.lastAt) { %>
        <span class="stat-sub">Derni√®re proposition : <%= new Date(profile.stats.submissions.lastAt).toLocaleString('fr-FR') %></span>
      <% } %>
      <% if (actionSanctions.contribute?.reason) { %>
        <span class="stat-sub sanction-reason">Motif : <%= actionSanctions.contribute.reason %></span>
      <% } %>
    </li>
  </ul>

  <% if (profile.bans && profile.bans.length) { %>
    <section class="ip-profile-section card-subtle ip-profile-bans">
      <h2>Sanctions actives</h2>
      <ul class="ip-profile-ban-list">
        <% profile.bans.forEach((ban) => { %>
          <li>
            <div class="ip-profile-ban-header">
              <span class="status-pill rejected"><%= ban.scope === 'global' ? 'Globale' : ban.scope %></span>
              <% if (ban.value) { %>
                <code><%= ban.value %></code>
              <% } %>
            </div>
            <p class="text-sm text-muted">Depuis le <%= new Date(ban.createdAt).toLocaleString('fr-FR') %></p>
            <% if (ban.reason) { %>
              <p class="text-muted"><%= ban.reason %></p>
            <% } %>
          </li>
        <% }) %>
      </ul>
    </section>
  <% } %>

  <div class="ip-profile-activity-grid">
    <section class="ip-profile-section card-subtle">
      <h2>Commentaires r√©cents</h2>
      <% if (profile.recent.comments.length) { %>
        <ul class="<%= activityClassName %>">
          <% profile.recent.comments.forEach((item) => { %>
            <li>
              <div class="ip-profile-activity-meta">
                <a href="/wiki/<%= item.slug %>#comments"><%= item.pageTitle %></a>
                <time datetime="<%= item.createdAt %>"><%= new Date(item.createdAt).toLocaleString('fr-FR') %></time>
              </div>
              <% if (item.excerpt) { %>
                <p class="ip-profile-activity-text"><%= item.excerpt %></p>
              <% } %>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="text-muted">Aucun commentaire approuv√© n'est encore visible.</p>
      <% } %>
    </section>
    <section class="ip-profile-section card-subtle">
      <h2>Likes r√©cents</h2>
      <% if (profile.recent.likes.length) { %>
        <ul class="<%= activityClassName %>">
          <% profile.recent.likes.forEach((item) => { %>
            <li>
              <div class="ip-profile-activity-meta">
                <a href="/wiki/<%= item.slug %>"><%= item.pageTitle %></a>
                <time datetime="<%= item.createdAt %>"><%= new Date(item.createdAt).toLocaleString('fr-FR') %></time>
              </div>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="text-muted">Aucun like enregistr√© pour l'instant.</p>
      <% } %>
    </section>
  </div>

  <div class="ip-profile-activity-grid">
    <section class="ip-profile-section card-subtle">
      <h2>Pages consult√©es r√©cemment</h2>
      <% if (profile.recent.views.length) { %>
        <ul class="<%= activityClassName %>">
          <% profile.recent.views.forEach((item) => { %>
            <li>
              <div class="ip-profile-activity-meta">
                <a href="/wiki/<%= item.slug %>"><%= item.pageTitle %></a>
                <time datetime="<%= item.createdAt %>"><%= new Date(item.createdAt).toLocaleString('fr-FR') %></time>
              </div>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="text-muted">Aucune vue enregistr√©e avec cette IP.</p>
      <% } %>
    </section>
    <section class="ip-profile-section card-subtle">
      <h2>Propositions r√©centes</h2>
      <% if (profile.recent.submissions.length) { %>
        <ul class="<%= activityClassName %>">
          <% profile.recent.submissions.forEach((item) => { %>
            <li>
              <div class="ip-profile-activity-meta">
                <% if (item.slug) { %>
                  <a href="/wiki/<%= item.slug %>"><%= item.pageTitle %></a>
                <% } else { %>
                  <span><%= item.pageTitle || 'Proposition' %></span>
                <% } %>
                <time datetime="<%= item.createdAt %>"><%= new Date(item.createdAt).toLocaleString('fr-FR') %></time>
              </div>
              <p class="ip-profile-activity-text text-muted">
                Type : <strong><%= item.type %></strong> ¬∑ Statut : <strong><%= item.status %></strong>
              </p>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="text-muted">Aucune proposition n'a encore √©t√© envoy√©e avec cette IP.</p>
      <% } %>
    </section>
  </div>
</section>

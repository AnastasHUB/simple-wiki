<% const displayTitle = t('ipProfile.title', { n: profile.shortHash }); %>
<% title = displayTitle; %>
<% const rep = profile.reputation || {}; %>
<% const repStatus = rep.status || 'unknown'; %>
<% const repLabel = repStatus === 'suspicious' ? t('ipProfile.rep.suspicious') : repStatus === 'safe' ? t('ipProfile.rep.safe') : repStatus === 'clean' ? t('ipProfile.rep.clean') : t('ipProfile.rep.unknown'); %>
<% let repClasses = 'ip-profile-reputation card-subtle notice'; %>
<% if (repStatus === 'suspicious') { repClasses += ' error'; } else if (repStatus === 'safe' || repStatus === 'clean') { repClasses += ' success'; } %>
<% const pillClass = repStatus === 'suspicious' ? 'status-pill suspicious' : repStatus === 'safe' ? 'status-pill safe' : repStatus === 'clean' ? 'status-pill clean' : 'status-pill pending'; %>
<% const activityClassName = 'ip-profile-activity'; %>
<% const claimContextData = typeof claimContext !== 'undefined' && claimContext ? claimContext : null; %>
<% const claimErrors = claimContextData && Array.isArray(claimContextData.errors) ? claimContextData.errors : []; %>
<% const claimValues = claimContextData && claimContextData.values && typeof claimContextData.values === 'object' ? claimContextData.values : {}; %>
<% const claimCaptchaConfig = claimContextData && claimContextData.captcha ? claimContextData.captcha : null; %>
<% const claimMode = claimContextData && typeof claimContextData.mode === 'string' ? claimContextData.mode : 'register'; %>
<% const claimDisabled = Boolean(claimContextData && claimContextData.disabled); %>
<% const showClaimForm = claimMode === 'register' && Boolean(claimContextData && claimContextData.showForm && isOwner && !profile.isClaimed); %>
<% const showLinkForm = claimMode === 'link' && Boolean(claimContextData && claimContextData.showLink && isOwner && !profile.isClaimed); %>
<% const linkUser = claimContextData && claimContextData.linkUser ? claimContextData.linkUser : null; %>
<% const linkUserLabel = linkUser ? (linkUser.displayName || linkUser.username || '') : ''; %>
<% const canShowClaimCta = Boolean(isOwner && !profile.isClaimed && !showClaimForm && !showLinkForm); %>
<% const claimedAtDate = profile.claim && profile.claim.claimedAt ? new Date(profile.claim.claimedAt) : null; %>

<section class="card ip-profile-card">
  <header class="ip-profile-header">
    <div>
      <span class="ip-profile-chip"><%= t('ipProfile.publicChip') %></span>
      <h1 class="mt-0"><%= displayTitle %></h1>
      <p class="text-muted"><%= t('ipProfile.intro') %></p>
    </div>
    <% if (isOwner) { %>
      <div class="ip-profile-owner-box">
        <p class="ip-profile-owner-note">
          Vous consultez votre propre profil IP. Seules les contributions publiques (commentaires approuv√©s, likes, vues et propositions) sont visibles ici.
        </p>
        <% if (profile.isClaimed) { %>
          <p class="ip-profile-owner-note success">
            <%= t('ipProfile.convertedBase') %>
            <% if (claimedAtDate) { %> <%= t('ipProfile.onDate', { date: claimedAtDate.toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') }) %><% } %>
          </p>
        <% } else if (canShowClaimCta) { %>
          <div class="ip-profile-claim-actions">
            <p class="ip-profile-owner-note"><%= t('ipProfile.cta.convertExplain') %></p>
            <a class="btn success" href="/profiles/ip/<%= profile.hash %>/claim" data-icon="‚ú®"><%= t('ipProfile.cta.convert') %></a>
          </div>
        <% } %>
      </div>
    <% } else if (profile.isClaimed) { %>
      <div class="ip-profile-owner-box success">
        <p class="ip-profile-owner-note"><%= t('ipProfile.convertedBase') %> <% if (claimedAtDate) { %><%= t('ipProfile.onDate', { date: claimedAtDate.toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') }) %><% } %></p>
      </div>
    <% } %>
  </header>

  <div class="ip-profile-summary-grid">
    <div class="<%= repClasses %>">
      <div class="ip-profile-reputation-header">
        <span class="<%= pillClass %>"><%= repLabel %></span>
        <% if (rep.lastCheckedAt) { %>
          <span class="ip-profile-reputation-meta"><%= t('ipProfile.rep.lastCheck') %> <%= new Date(rep.lastCheckedAt).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') %></span>
        <% } %>
      </div>
      <p class="ip-profile-reputation-text">
        <%= rep.summary || t('ipProfile.rep.noSignal') %>
      </p>
    </div>
    <div class="ip-profile-meta-card card-subtle">
      <dl class="ip-profile-details">
        <div>
          <dt><%= t('ipProfile.meta.created') %></dt>
          <dd><%= profile.createdAt ? new Date(profile.createdAt).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') : t('ipProfile.meta.unknown') %></dd>
        </div>
        <div>
          <dt><%= t('ipProfile.meta.lastActivity') %></dt>
          <dd><%= profile.lastSeenAt ? new Date(profile.lastSeenAt).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') : t('ipProfile.meta.unknown') %></dd>
        </div>
        <div>
          <dt><%= t('ipProfile.meta.autodetect') %></dt>
          <dd>
            <% if (profile.bot?.isBot) { %>
              <span class="status-pill suspicious"><%= t('ipProfile.bot.suspected') %></span>
              <% if (profile.bot?.reason) { %>
                <br /><small class="text-muted"><%= profile.bot.reason %></small>
              <% } %>
            <% } else { %>
              <span class="status-pill clean"><%= t('ipProfile.bot.human') %></span>
            <% } %>
          </dd>
        </div>
        <% if (profile.bot?.userAgent) { %>
          <div>
            <dt><%= t('ipProfile.meta.userAgent') %></dt>
            <dd><small><%= profile.bot.userAgent %></small></dd>
          </div>
        <% } %>
        <div>
          <dt><%= t('ipProfile.meta.identifier') %></dt>
          <dd>
            <code>#<%= profile.shortHash %></code>
            <% if (profile.id) { %>
              <br />
              <small><%= t('ipProfile.meta.idLabel') %> <code><%= profile.id %></code></small>
            <% } %>
          </dd>
        </div>
      </dl>
    </div>
  </div>

  <% if (showLinkForm) { %>
    <section class="ip-profile-claim card-subtle">
      <h2><%= t('ipProfile.link.title') %></h2>
      <p>
        <%- t('ipProfile.link.intro', { user: (linkUserLabel || t('ipProfile.link.yourAccount')) }) %>
      </p>
      <% if (claimErrors.length) { %>
        <div class="card error">
          <h3><%= t('ipProfile.link.errorTitle') %></h3>
          <ul>
            <% claimErrors.forEach(function (message) { %>
              <li><%= message %></li>
            <% }); %>
          </ul>
        </div>
      <% } %>
      <% if (claimDisabled) { %>
        <p class="text-muted"><%= t('ipProfile.link.unavailable') %></p>
      <% } else { %>
        <form
          method="post"
          action="/profiles/ip/<%= profile.hash %>/claim"
          class="stacked-form"
          id="ipLinkForm"
        >
          <%- include('partials/csrf_field') %>
          <input type="hidden" name="mode" value="link" />
          <p>
            <%= t('ipProfile.link.explain') %>
          </p>
          <div class="actions">
            <button class="btn success" type="submit" data-icon="üîó" id="ipLinkSubmit">
              <%= t('ipProfile.link.submit') %>
            </button>
          </div>
        </form>
      <% } %>
    </section>
  <% } %>

  <% if (showClaimForm) { %>
    <section class="ip-profile-claim card-subtle">
      <h2><%= t('ipProfile.claim.title') %></h2>
      <p>
        <%= t('ipProfile.claim.intro') %>
      </p>
      <% if (claimErrors.length) { %>
        <div class="card error">
          <h3><%= t('ipProfile.claim.errorTitle') %></h3>
          <ul>
            <% claimErrors.forEach(function (message) { %>
              <li><%= message %></li>
            <% }); %>
          </ul>
        </div>
      <% } %>
      <% if (claimDisabled) { %>
        <p class="text-muted"><%= t('ipProfile.claim.unavailable') %></p>
      <% } else { %>
        <form
          method="post"
          action="/profiles/ip/<%= profile.hash %>/claim"
          class="stacked-form"
          id="ipClaimForm"
        >
          <%- include('partials/csrf_field') %>
          <label for="ip-claim-username"><%= t('ipProfile.claim.fields.username') %></label>
          <input
            id="ip-claim-username"
            type="text"
            name="username"
            required
            minlength="3"
            maxlength="32"
            pattern="[A-Za-z0-9_.-]+"
            autocomplete="username"
            value="<%= claimValues.username ? claimValues.username : '' %>"
          />
          <p class="form-help"><%= t('ipProfile.claim.fields.usernameHelp') %></p>

          <label for="ip-claim-password"><%= t('ipProfile.claim.fields.password') %></label>
          <input
            id="ip-claim-password"
            type="password"
            name="password"
            required
            minlength="8"
            autocomplete="new-password"
          />
          <p class="form-help"><%= t('ipProfile.claim.fields.passwordHelp') %></p>

          <% if (claimCaptchaConfig) { %>
            <fieldset class="captcha-selector">
              <legend><%= t('ipProfile.claim.captcha.legend') %></legend>
              <p class="form-help"><%= t('ipProfile.claim.captcha.help') %></p>
              <p class="captcha-question">
                <strong><%= claimCaptchaConfig.question %> = ?</strong>
              </p>
              <label for="ip-claim-captcha-answer"><%= t('ipProfile.claim.captcha.answer') %> <span class="text-required">*</span></label>
              <input
                id="ip-claim-captcha-answer"
                type="text"
                name="captcha"
                inputmode="numeric"
                pattern="[0-9]*"
                required
                autocomplete="off"
              />
              <input
                type="hidden"
                name="captchaToken"
                id="ip-claim-captcha-token"
                value="<%= claimCaptchaConfig.token %>"
                required
              />
            </fieldset>
          <% } %>

          <div class="actions">
            <button class="btn success" type="submit" data-icon="‚ú®" id="ipClaimSubmit">
              <%= t('ipProfile.claim.submit') %>
            </button>
          </div>
        </form>
        <% if (claimCaptchaConfig) { %>
          <script>
            (function () {
              const form = document.querySelector("form[action$='/claim']");
              if (!form) {
                return;
              }
              form.addEventListener("submit", () => {
                const tokenInput = document.getElementById("ip-claim-captcha-token");
                if (tokenInput) {
                  tokenInput.value = tokenInput.value?.trim();
                }
              });
            })();
          </script>
        <% } %>
      <% } %>
    </section>
  <% } else if (claimErrors.length && isOwner) { %>
    <div class="card error">
      <h2>Impossible de convertir le profil</h2>
      <ul>
        <% claimErrors.forEach(function (message) { %>
          <li><%= message %></li>
        <% }); %>
      </ul>
    </div>
  <% } %>

  <% const actionSanctions = {}; %>
  <% (profile.bans || []).forEach((ban) => { %>
    <% if (ban.scope === 'action' && ban.value) { %>
      <% actionSanctions[ban.value] = ban; %>
    <% } %>
  <% }); %>

  <ul class="stat-grid ip-profile-stats">
    <li class="ip-profile-stat">
      <span class="stat-icon" aria-hidden="true">üëÄ</span>
      <span class="label">
        Vues enregistr√©es
        <% if (actionSanctions.view) { %>
          <span class="status-pill rejected ip-profile-sanction" title="Cette action est actuellement bloqu√©e.">Sanction</span>
        <% } %>
      </span>
      <strong class="stat-value"><%= profile.stats.views.total %></strong>
      <span class="stat-sub">Pages distinctes : <strong><%= profile.stats.views.uniquePages %></strong></span>
      <% if (profile.stats.views.lastAt) { %>
        <span class="stat-sub">Derni√®re vue : <%= new Date(profile.stats.views.lastAt).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') %></span>
      <% } %>
      <% if (actionSanctions.view?.reason) { %>
        <span class="stat-sub sanction-reason">Motif : <%= actionSanctions.view.reason %></span>
      <% } %>
    </li>
    <li class="ip-profile-stat">
      <span class="stat-icon" aria-hidden="true">üíñ</span>
      <span class="label">
        Likes
        <% if (actionSanctions.like) { %>
          <span class="status-pill rejected ip-profile-sanction" title="Cette action est actuellement bloqu√©e.">Sanction</span>
        <% } %>
      </span>
      <strong class="stat-value"><%= profile.stats.likes.total %></strong>
      <span class="stat-sub">Pages distinctes : <strong><%= profile.stats.likes.uniquePages %></strong></span>
      <% if (profile.stats.likes.lastAt) { %>
        <span class="stat-sub">Dernier like : <%= new Date(profile.stats.likes.lastAt).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') %></span>
      <% } %>
      <% if (actionSanctions.like?.reason) { %>
        <span class="stat-sub sanction-reason">Motif : <%= actionSanctions.like.reason %></span>
      <% } %>
    </li>
    <li class="ip-profile-stat">
      <span class="stat-icon" aria-hidden="true">üí¨</span>
      <span class="label">
        Commentaires approuv√©s
        <% if (actionSanctions.comment) { %>
          <span class="status-pill rejected ip-profile-sanction" title="Cette action est actuellement bloqu√©e.">Sanction</span>
        <% } %>
      </span>
      <strong class="stat-value"><%= profile.stats.comments.total %></strong>
      <% if (profile.stats.comments.lastAt) { %>
        <span class="stat-sub">Dernier commentaire : <%= new Date(profile.stats.comments.lastAt).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') %></span>
      <% } else { %>
        <span class="stat-sub">Aucun commentaire approuv√© pour le moment.</span>
      <% } %>
      <% if (actionSanctions.comment?.reason) { %>
        <span class="stat-sub sanction-reason">Motif : <%= actionSanctions.comment.reason %></span>
      <% } %>
    </li>
    <li class="ip-profile-stat">
      <span class="stat-icon" aria-hidden="true">üõ†Ô∏è</span>
      <span class="label">
        Propositions
        <% if (actionSanctions.contribute) { %>
          <span class="status-pill rejected ip-profile-sanction" title="Cette action est actuellement bloqu√©e.">Sanction</span>
        <% } %>
      </span>
      <strong class="stat-value"><%= profile.stats.submissions.total %></strong>
      <% const submissionStatuses = profile.stats.submissions.byStatus || {}; %>
      <% if (Object.keys(submissionStatuses).length) { %>
        <span class="stat-sub">
          <% Object.entries(submissionStatuses).forEach(([status, total], index, entries) => { %>
            <%= status %> : <strong><%= total %></strong><%= index < entries.length - 1 ? ' ¬∑ ' : '' %>
          <% }) %>
        </span>
      <% } else { %>
        <span class="stat-sub">Aucune proposition enregistr√©e.</span>
      <% } %>
      <% if (profile.stats.submissions.lastAt) { %>
        <span class="stat-sub">Derni√®re proposition : <%= new Date(profile.stats.submissions.lastAt).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') %></span>
      <% } %>
      <% if (actionSanctions.contribute?.reason) { %>
        <span class="stat-sub sanction-reason">Motif : <%= actionSanctions.contribute.reason %></span>
      <% } %>
    </li>
  </ul>

  <% if (profile.bans && profile.bans.length) { %>
    <section class="ip-profile-section card-subtle ip-profile-bans">
      <h2><%= t('ipProfile.sanctions.title') %></h2>
      <ul class="ip-profile-ban-list">
        <% profile.bans.forEach((ban) => { %>
          <li>
            <div class="ip-profile-ban-header">
              <span class="status-pill rejected"><%= ban.scope === 'global' ? t('ipProfile.sanctions.global') : ban.scope %></span>
              <% if (ban.value) { %>
                <code><%= ban.value %></code>
              <% } %>
            </div>
            <p class="text-sm text-muted"><%= t('ipProfile.sanctions.since') %> <%= new Date(ban.createdAt).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') %></p>
            <% if (ban.reason) { %>
              <p class="text-muted"><%= ban.reason %></p>
            <% } %>
          </li>
        <% }) %>
      </ul>
    </section>
  <% } %>

  <div class="ip-profile-activity-grid">
    <section class="ip-profile-section card-subtle">
      <h2><%= t('ipProfile.recent.comments') %></h2>
      <% if (profile.recent.comments.length) { %>
        <ul class="<%= activityClassName %>">
          <% profile.recent.comments.forEach((item) => { %>
            <li>
              <div class="ip-profile-activity-meta">
                <a href="/wiki/<%= item.slug %>#comments"><%= item.pageTitle %></a>
                <time datetime="<%= item.createdAt %>"><%= new Date(item.createdAt).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') %></time>
              </div>
              <% if (item.excerpt) { %>
                <p class="ip-profile-activity-text"><%= item.excerpt %></p>
              <% } %>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="text-muted"><%= t('ipProfile.recent.noComments') %></p>
      <% } %>
    </section>
    <section class="ip-profile-section card-subtle">
      <h2><%= t('ipProfile.recent.likes') %></h2>
      <% if (profile.recent.likes.length) { %>
        <ul class="<%= activityClassName %>">
          <% profile.recent.likes.forEach((item) => { %>
            <li>
              <div class="ip-profile-activity-meta">
                <a href="/wiki/<%= item.slug %>"><%= item.pageTitle %></a>
                <time datetime="<%= item.createdAt %>"><%= new Date(item.createdAt).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') %></time>
              </div>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="text-muted"><%= t('ipProfile.recent.noLikes') %></p>
      <% } %>
    </section>
  </div>

  <div class="ip-profile-activity-grid">
    <section class="ip-profile-section card-subtle">
      <h2><%= t('ipProfile.recent.views') %></h2>
      <% if (profile.recent.views.length) { %>
        <ul class="<%= activityClassName %>">
          <% profile.recent.views.forEach((item) => { %>
            <li>
              <div class="ip-profile-activity-meta">
                <a href="/wiki/<%= item.slug %>"><%= item.pageTitle %></a>
                <time datetime="<%= item.createdAt %>"><%= new Date(item.createdAt).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') %></time>
              </div>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="text-muted"><%= t('ipProfile.recent.noViews') %></p>
      <% } %>
    </section>
    <section class="ip-profile-section card-subtle">
      <h2><%= t('ipProfile.recent.submissions') %></h2>
      <% if (profile.recent.submissions.length) { %>
        <ul class="<%= activityClassName %>">
          <% profile.recent.submissions.forEach((item) => { %>
            <li>
              <div class="ip-profile-activity-meta">
                <% if (item.slug) { %>
                  <a href="/wiki/<%= item.slug %>"><%= item.pageTitle %></a>
                <% } else { %>
                  <span><%= item.pageTitle || t('ipProfile.recent.submissionLabel') %></span>
                <% } %>
                <time datetime="<%= item.createdAt %>"><%= new Date(item.createdAt).toLocaleString(lang === 'en' ? 'en-US' : 'fr-FR') %></time>
              </div>
              <p class="ip-profile-activity-text text-muted">
                <%= t('ipProfile.recent.type') %> <strong><%= item.type %></strong> ¬∑ <%= t('ipProfile.recent.status') %> <strong><%= item.status %></strong>
              </p>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="text-muted"><%= t('ipProfile.recent.noSubmissions') %></p>
      <% } %>
    </section>
  </div>
</section>

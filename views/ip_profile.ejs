<% const preferences = profile.preferences || {}; %>
<% const customLabel = preferences.publicLabel && preferences.publicLabel.trim() ? preferences.publicLabel.trim() : null; %>
<% const displayTitle = customLabel || `Profil IP #${profile.shortHash}`; %>
<% title = displayTitle; %>
<% const rep = profile.reputation || {}; %>
<% const repStatus = rep.status || 'unknown'; %>
<% const repLabel = repStatus === 'suspicious' ? 'IP suspecte' : repStatus === 'safe' ? 'IP valid√©e' : repStatus === 'clean' ? 'IP neutre' : 'Statut inconnu'; %>
<% let repClasses = 'ip-profile-reputation card-subtle notice'; %>
<% if (repStatus === 'suspicious') { repClasses += ' error'; } else if (repStatus === 'safe' || repStatus === 'clean') { repClasses += ' success'; } %>
<% const pillClass = repStatus === 'suspicious' ? 'status-pill suspicious' : repStatus === 'safe' ? 'status-pill safe' : repStatus === 'clean' ? 'status-pill clean' : 'status-pill pending'; %>
<% const pageSizeOptions = Array.isArray(preferenceOptions?.commentPageSizes) && preferenceOptions.commentPageSizes.length ? preferenceOptions.commentPageSizes : [5, 10, 20, 50]; %>
<% const activityListClass = ['ip-profile-activity']; %>
<% if (preferences.compactComments) { activityListClass.push('compact'); } %>
<% const activityClassName = activityListClass.join(' '); %>
<% const defaultAuthorLabel = preferences.defaultAuthor ? preferences.defaultAuthor : 'Non d√©fini'; %>
<% const commentPageSizeLabel = preferences.commentPageSize || 10; %>

<section class="card ip-profile-card">
  <header class="ip-profile-header">
    <div>
      <span class="ip-profile-chip">Profil IP public</span>
      <h1 class="mt-0"><%= displayTitle %></h1>
      <p class="text-muted">
        Ce profil regroupe les activit√©s publiques associ√©es √† une adresse IP. L'adresse IP r√©elle est hach√©e afin de prot√©ger l'anonymat des contributeurs non connect√©s.
      </p>
    </div>
    <% if (isOwner) { %>
      <div class="ip-profile-owner-box">
        <p class="ip-profile-owner-note">
          Vous consultez votre propre profil IP. Seules les contributions publiques (commentaires approuv√©s, likes, vues et propositions) sont visibles ici.
        </p>
        <a class="btn secondary btn-compact" href="#preferences" data-icon="‚öôÔ∏è">Modifier mes pr√©f√©rences</a>
      </div>
    <% } %>
  </header>

  <div class="ip-profile-summary-grid">
    <div class="<%= repClasses %>">
      <div class="ip-profile-reputation-header">
        <span class="<%= pillClass %>"><%= repLabel %></span>
        <% if (rep.lastCheckedAt) { %>
          <span class="ip-profile-reputation-meta">Derni√®re v√©rification : <%= new Date(rep.lastCheckedAt).toLocaleString('fr-FR') %></span>
        <% } %>
      </div>
      <p class="ip-profile-reputation-text">
        <%= rep.summary || "Aucun signal particulier n'a √©t√© relev√© pour cette adresse IP." %>
      </p>
    </div>
    <div class="ip-profile-meta-card card-subtle">
      <dl class="ip-profile-details">
        <div>
          <dt>Profil cr√©√©</dt>
          <dd><%= profile.createdAt ? new Date(profile.createdAt).toLocaleString('fr-FR') : 'Inconnu' %></dd>
        </div>
        <div>
          <dt>Derni√®re activit√©</dt>
          <dd><%= profile.lastSeenAt ? new Date(profile.lastSeenAt).toLocaleString('fr-FR') : 'Inconnue' %></dd>
        </div>
        <div>
          <dt>Identifiant</dt>
          <dd><code>#<%= profile.shortHash %></code></dd>
        </div>
      </dl>
      <% if (isOwner) { %>
        <div class="ip-profile-preference-mini">
          <h3>Pr√©f√©rences rapides</h3>
          <ul>
            <li><span>Nom public</span><strong><%= customLabel || `Profil IP #${profile.shortHash}` %></strong></li>
            <li><span>Nom par d√©faut</span><strong><%= defaultAuthorLabel %></strong></li>
            <li><span>Commentaires/page</span><strong><%= commentPageSizeLabel %></strong></li>
          </ul>
          <% if (preferences.updatedAt) { %>
            <p class="text-sm text-muted">Mis √† jour le <%= new Date(preferences.updatedAt).toLocaleString('fr-FR') %></p>
          <% } %>
        </div>
      <% } %>
    </div>
  </div>

  <% const actionSanctions = {}; %>
  <% (profile.bans || []).forEach((ban) => { %>
    <% if (ban.scope === 'action' && ban.value) { %>
      <% actionSanctions[ban.value] = ban; %>
    <% } %>
  <% }); %>

  <ul class="stat-grid ip-profile-stats">
    <li class="ip-profile-stat">
      <span class="stat-icon" aria-hidden="true">üëÄ</span>
      <span class="label">
        Vues enregistr√©es
        <% if (actionSanctions.view) { %>
          <span class="status-pill rejected ip-profile-sanction" title="Cette action est actuellement bloqu√©e.">Sanction</span>
        <% } %>
      </span>
      <strong class="stat-value"><%= profile.stats.views.total %></strong>
      <span class="stat-sub">Pages distinctes : <strong><%= profile.stats.views.uniquePages %></strong></span>
      <% if (profile.stats.views.lastAt) { %>
        <span class="stat-sub">Derni√®re vue : <%= new Date(profile.stats.views.lastAt).toLocaleString('fr-FR') %></span>
      <% } %>
      <% if (actionSanctions.view?.reason) { %>
        <span class="stat-sub sanction-reason">Motif : <%= actionSanctions.view.reason %></span>
      <% } %>
    </li>
    <li class="ip-profile-stat">
      <span class="stat-icon" aria-hidden="true">üíñ</span>
      <span class="label">
        Likes
        <% if (actionSanctions.like) { %>
          <span class="status-pill rejected ip-profile-sanction" title="Cette action est actuellement bloqu√©e.">Sanction</span>
        <% } %>
      </span>
      <strong class="stat-value"><%= profile.stats.likes.total %></strong>
      <span class="stat-sub">Pages distinctes : <strong><%= profile.stats.likes.uniquePages %></strong></span>
      <% if (profile.stats.likes.lastAt) { %>
        <span class="stat-sub">Dernier like : <%= new Date(profile.stats.likes.lastAt).toLocaleString('fr-FR') %></span>
      <% } %>
      <% if (actionSanctions.like?.reason) { %>
        <span class="stat-sub sanction-reason">Motif : <%= actionSanctions.like.reason %></span>
      <% } %>
    </li>
    <li class="ip-profile-stat">
      <span class="stat-icon" aria-hidden="true">üí¨</span>
      <span class="label">
        Commentaires approuv√©s
        <% if (actionSanctions.comment) { %>
          <span class="status-pill rejected ip-profile-sanction" title="Cette action est actuellement bloqu√©e.">Sanction</span>
        <% } %>
      </span>
      <strong class="stat-value"><%= profile.stats.comments.total %></strong>
      <% if (profile.stats.comments.lastAt) { %>
        <span class="stat-sub">Dernier commentaire : <%= new Date(profile.stats.comments.lastAt).toLocaleString('fr-FR') %></span>
      <% } else { %>
        <span class="stat-sub">Aucun commentaire approuv√© pour le moment.</span>
      <% } %>
      <% if (actionSanctions.comment?.reason) { %>
        <span class="stat-sub sanction-reason">Motif : <%= actionSanctions.comment.reason %></span>
      <% } %>
    </li>
    <li class="ip-profile-stat">
      <span class="stat-icon" aria-hidden="true">üõ†Ô∏è</span>
      <span class="label">
        Propositions
        <% if (actionSanctions.contribute) { %>
          <span class="status-pill rejected ip-profile-sanction" title="Cette action est actuellement bloqu√©e.">Sanction</span>
        <% } %>
      </span>
      <strong class="stat-value"><%= profile.stats.submissions.total %></strong>
      <% const submissionStatuses = profile.stats.submissions.byStatus || {}; %>
      <% if (Object.keys(submissionStatuses).length) { %>
        <span class="stat-sub">
          <% Object.entries(submissionStatuses).forEach(([status, total], index, entries) => { %>
            <%= status %> : <strong><%= total %></strong><%= index < entries.length - 1 ? ' ¬∑ ' : '' %>
          <% }) %>
        </span>
      <% } else { %>
        <span class="stat-sub">Aucune proposition enregistr√©e.</span>
      <% } %>
      <% if (profile.stats.submissions.lastAt) { %>
        <span class="stat-sub">Derni√®re proposition : <%= new Date(profile.stats.submissions.lastAt).toLocaleString('fr-FR') %></span>
      <% } %>
      <% if (actionSanctions.contribute?.reason) { %>
        <span class="stat-sub sanction-reason">Motif : <%= actionSanctions.contribute.reason %></span>
      <% } %>
    </li>
  </ul>

  <% if (profile.bans && profile.bans.length) { %>
    <section class="ip-profile-section card-subtle ip-profile-bans">
      <h2>Sanctions actives</h2>
      <ul class="ip-profile-ban-list">
        <% profile.bans.forEach((ban) => { %>
          <li>
            <div class="ip-profile-ban-header">
              <span class="status-pill rejected"><%= ban.scope === 'global' ? 'Globale' : ban.scope %></span>
              <% if (ban.value) { %>
                <code><%= ban.value %></code>
              <% } %>
            </div>
            <p class="text-sm text-muted">Depuis le <%= new Date(ban.createdAt).toLocaleString('fr-FR') %></p>
            <% if (ban.reason) { %>
              <p class="text-muted"><%= ban.reason %></p>
            <% } %>
          </li>
        <% }) %>
      </ul>
    </section>
  <% } %>

  <% if (isOwner) { %>
    <section id="preferences" class="ip-profile-section card-subtle ip-profile-preferences">
      <h2>Mes pr√©f√©rences</h2>
      <p class="text-muted">
        Personnalisez l'apparence de votre profil et les param√®tres par d√©faut utilis√©s lors de vos contributions.
      </p>
      <form method="post" action="/profiles/ip/<%= profile.hash %>/preferences" class="ip-preferences-form">
        <label class="stack-form">
          <span class="text-sm text-muted">Nom public du profil</span>
          <input
            type="text"
            name="publicLabel"
            maxlength="60"
            value="<%= customLabel || '' %>"
            placeholder="Profil IP personnalis√©"
          />
          <span class="form-help">Laissez vide pour afficher ¬´ Profil IP #<%= profile.shortHash %> ¬ª.</span>
        </label>
        <label class="stack-form">
          <span class="text-sm text-muted">Nom par d√©faut pour vos commentaires</span>
          <input
            type="text"
            name="defaultAuthor"
            maxlength="80"
            value="<%= preferences.defaultAuthor || '' %>"
            placeholder="Anonyme"
          />
        </label>
        <label class="stack-form">
          <span class="text-sm text-muted">Commentaires affich√©s par page</span>
          <select name="commentPageSize">
            <option value="" <%= preferences.commentPageSize ? '' : 'selected' %>>Automatique (10)</option>
            <% pageSizeOptions.forEach((size) => { %>
              <option value="<%= size %>" <%= preferences.commentPageSize === size ? 'selected' : '' %>><%= size %></option>
            <% }) %>
          </select>
        </label>
        <label class="checkbox ip-preferences-checkbox">
          <input type="checkbox" name="compactComments" <%= preferences.compactComments ? 'checked' : '' %> />
          <span>Afficher les historiques en mode compact</span>
        </label>
        <button class="btn success" data-icon="üíæ" type="submit">Enregistrer</button>
      </form>
    </section>
  <% } %>

  <div class="ip-profile-activity-grid">
    <section class="ip-profile-section card-subtle">
      <h2>Commentaires r√©cents</h2>
      <% if (profile.recent.comments.length) { %>
        <ul class="<%= activityClassName %>">
          <% profile.recent.comments.forEach((item) => { %>
            <li>
              <div class="ip-profile-activity-meta">
                <a href="/wiki/<%= item.slug %>#comments"><%= item.pageTitle %></a>
                <time datetime="<%= item.createdAt %>"><%= new Date(item.createdAt).toLocaleString('fr-FR') %></time>
              </div>
              <% if (item.excerpt) { %>
                <p class="ip-profile-activity-text"><%= item.excerpt %></p>
              <% } %>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="text-muted">Aucun commentaire approuv√© n'est encore visible.</p>
      <% } %>
    </section>
    <section class="ip-profile-section card-subtle">
      <h2>Likes r√©cents</h2>
      <% if (profile.recent.likes.length) { %>
        <ul class="<%= activityClassName %>">
          <% profile.recent.likes.forEach((item) => { %>
            <li>
              <div class="ip-profile-activity-meta">
                <a href="/wiki/<%= item.slug %>"><%= item.pageTitle %></a>
                <time datetime="<%= item.createdAt %>"><%= new Date(item.createdAt).toLocaleString('fr-FR') %></time>
              </div>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="text-muted">Aucun like enregistr√© pour l'instant.</p>
      <% } %>
    </section>
  </div>

  <div class="ip-profile-activity-grid">
    <section class="ip-profile-section card-subtle">
      <h2>Pages consult√©es r√©cemment</h2>
      <% if (profile.recent.views.length) { %>
        <ul class="<%= activityClassName %>">
          <% profile.recent.views.forEach((item) => { %>
            <li>
              <div class="ip-profile-activity-meta">
                <a href="/wiki/<%= item.slug %>"><%= item.pageTitle %></a>
                <time datetime="<%= item.createdAt %>"><%= new Date(item.createdAt).toLocaleString('fr-FR') %></time>
              </div>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="text-muted">Aucune vue enregistr√©e avec cette IP.</p>
      <% } %>
    </section>
    <section class="ip-profile-section card-subtle">
      <h2>Propositions r√©centes</h2>
      <% if (profile.recent.submissions.length) { %>
        <ul class="<%= activityClassName %>">
          <% profile.recent.submissions.forEach((item) => { %>
            <li>
              <div class="ip-profile-activity-meta">
                <% if (item.slug) { %>
                  <a href="/wiki/<%= item.slug %>"><%= item.pageTitle %></a>
                <% } else { %>
                  <span><%= item.pageTitle || 'Proposition' %></span>
                <% } %>
                <time datetime="<%= item.createdAt %>"><%= new Date(item.createdAt).toLocaleString('fr-FR') %></time>
              </div>
              <p class="ip-profile-activity-text text-muted">
                Type : <strong><%= item.type %></strong> ¬∑ Statut : <strong><%= item.status %></strong>
              </p>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="text-muted">Aucune proposition n'a encore √©t√© envoy√©e avec cette IP.</p>
      <% } %>
    </section>
  </div>
</section>

<%
  title = (profile.displayName || profile.username) + ' ¬∑ Profil';
  const bannerStyle = profile.bannerUrl
    ? `background-image: url('${encodeURI(profile.bannerUrl).replace(/'/g, '%27').replace(/\(/g, '%28').replace(/\)/g, '%29')}')`
    : '';
  const avatarInitialSource = (profile.displayName || profile.username || '?').trim();
  const avatarInitial = avatarInitialSource
    ? avatarInitialSource.charAt(0).toUpperCase()
    : '?';
%>
<section class="profile-public">
  <div
    class="profile-public__banner"
    style="<%= bannerStyle %>"
  ></div>
  <div class="profile-public__content card">
    <div class="profile-public__header">
      <div class="profile-public__avatar">
        <% if (profile.avatarUrl) { %>
          <img src="<%= profile.avatarUrl %>" alt="Avatar de <%= profile.displayName || profile.username %>" loading="lazy" />
        <% } else { %>
          <span aria-hidden="true"><%= avatarInitial %></span>
        <% } %>
        <span class="sr-only">Avatar de <%= profile.displayName || profile.username %></span>
      </div>
      <div class="profile-public__identity">
        <% const heroName = profile.displayName || profile.username; %>
        <% const roleColor = profile.roleColor && profile.roleColor.hasColor ? profile.roleColor : null; %>
        <% const nameClasses = ['user-handle']; %>
        <% const nameStyle = roleColor ? roleColor.style : ''; %>
        <% if (roleColor) { nameClasses.push('role-colored-text'); if (roleColor.className) { nameClasses.push(roleColor.className); } } %>
        <h1 class="profile-public__name <%= nameClasses.join(' ') %>" style="<%= nameStyle %>"><%= heroName %></h1>
        <% const usernameClasses = ['user-handle']; %>
        <% const usernameStyle = roleColor ? roleColor.style : ''; %>
        <% if (roleColor) { usernameClasses.push('role-colored-text'); if (roleColor.className) { usernameClasses.push(roleColor.className); } } %>
        <% const profileBadges = profile.showBadges && Array.isArray(profile.badges) ? profile.badges : []; %>
        <p class="profile-public__username">
          <span class="user-handle-decorated">
            <span class="<%= usernameClasses.join(' ') %>" style="<%= usernameStyle %>">@<%= profile.username %></span>
            <%- include('partials/userBadges', {
              badges: profileBadges,
              listClass: ['user-handle-badges', 'user-handle-badges--inline'],
              itemClass: 'user-handle-badge-item',
              iconClass: 'user-handle-badge-icon',
              srOnlyClass: 'sr-only',
              ariaLabel: 'Badges du profil',
            }) %>
          </span>
        </p>
        <% if (profile.roleName) { %>
          <p class="profile-public__role">R√¥le&nbsp;: <strong><%= profile.roleName %></strong></p>
        <% } %>
        <% if (profile.showBadges && Array.isArray(profile.badges) && profile.badges.length) { %>
          <ul class="profile-public__badges" aria-label="Badges">
            <% profile.badges.forEach(function (badge) { %>
              <li class="profile-public__badge" title="<%= badge.name %>">
                <span class="profile-public__badge-icon">
                  <% if (badge.imageUrl) { %>
                    <img src="<%= badge.imageUrl %>" alt="" loading="lazy" />
                  <% } else { %>
                    <%= badge.emoji || 'üèÖ' %>
                  <% } %>
                </span>
                <span class="profile-public__badge-label"><%= badge.name %></span>
              </li>
            <% }) %>
          </ul>
        <% } %>
      </div>
    </div>

    <% if (profile.isBanned) { %>
      <div class="alert alert-error mt-sm">
        <p><strong>Ce compte est suspendu.</strong></p>
        <% if (profile.banReason) { %>
          <p>Motif&nbsp;: <%= profile.banReason %></p>
        <% } %>
        <% if (profile.bannedAt) { %>
          <p>Depuis le <%= new Date(profile.bannedAt).toLocaleString('fr-FR') %>.</p>
        <% } %>
      </div>
    <% } %>

    <% if (profile.showBio) { %>
      <% if (profile.bio) { %>
        <p class="profile-public__bio"><%= profile.bio %></p>
      <% } else { %>
        <p class="profile-public__bio profile-public__bio--empty text-muted">
          Aucun texte de pr√©sentation pour le moment.
        </p>
      <% } %>
    <% } else { %>
      <p class="profile-public__bio profile-public__bio--empty text-muted">
        Cet utilisateur pr√©f√®re garder sa biographie priv√©e.
      </p>
    <% } %>

    <% if (profile.showStats) { %>
      <div class="profile-public__stats">
        <div>
          <span class="profile-public__stat-value"><%= profile.totalPages %></span>
          <span class="profile-public__stat-label">Pages publi√©es</span>
        </div>
      </div>
    <% } %>

    <% if (profile.showRecentPages) { %>
      <div class="profile-public__recent">
        <h2>Publications r√©centes</h2>
        <% if (profile.recentPages && profile.recentPages.length) { %>
          <ul>
            <% profile.recentPages.forEach(function(page) { %>
              <li>
                <a href="/wiki/<%= page.slug_id %>"><%= page.title %></a>
                <span class="profile-public__recent-date">
                  <%= page.created_at ? new Date(page.created_at).toLocaleDateString('fr-FR') : '' %>
                </span>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <p class="text-muted">Aucune page publi√©e √† afficher.</p>
        <% } %>
      </div>
    <% } %>

    <% if (profile.showIpProfiles) { %>
      <div class="profile-public__recent">
        <h2>Profils IP associ√©s</h2>
        <% if (Array.isArray(profile.ipProfiles) && profile.ipProfiles.length) { %>
          <ul>
            <% profile.ipProfiles.forEach(function(ipProfile) { %>
              <li>
                <a href="/profiles/ip/<%= encodeURIComponent(ipProfile.hash) %>">
                  Profil #<%= ipProfile.shortHash || '?' %>
                </a>
                <% if (ipProfile.claimedAt) { %>
                  <span class="profile-public__recent-date">
                    Associ√© le <%= new Date(ipProfile.claimedAt).toLocaleDateString('fr-FR') %>
                  </span>
                <% } %>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <p class="text-muted">Aucun profil IP public n'est li√© √† ce compte.</p>
        <% } %>
      </div>
    <% } %>
  </div>
</section>

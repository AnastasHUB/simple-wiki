<% title = t('search.title'); %>
<h1><%= t('search.resultsFor', { q }) %></h1>

<div class="search-filters">
  <form class="filters-form" method="get" data-search-filters>
    <input type="hidden" name="q" value="<%= q %>">
    <% const selectedTagSet = new Set((filters.selectedTagKeys || []).map(t => t.toLowerCase())); %>
    <div class="filters-grid">
      <div class="filter-field">
        <label for="filter-author"><%= t('search.filters.author') %></label>
        <input id="filter-author" name="author" type="text" value="<%= filters.author || '' %>" maxlength="120" data-filter-field>
      </div>

      <div class="filter-field">
        <label for="filter-tags"><%= t('search.filters.tags') %></label>
        <select id="filter-tags" name="tag" multiple size="5" data-filter-tags data-filter-field>
          <% if (!availableTags.length) { %>
            <option disabled>(<%= t('search.filters.noTags') %>)</option>
          <% } %>
          <% availableTags.forEach(tagName => { %>
            <% const isSelected = selectedTagSet.has(tagName.toLowerCase()); %>
            <option value="<%= tagName %>" <%= isSelected ? 'selected' : '' %>><%= tagName %></option>
          <% }) %>
        </select>
        <% if (filters.displayTags && filters.displayTags.length) { %>
          <ul class="active-tag-filters" data-active-tags>
            <% filters.displayTags.forEach(tag => { %>
              <li>
                <span class="tag-chip"><%= tag.label %></span>
                <button type="button" class="btn ghost" data-remove-tag="<%= tag.value %>" aria-label="<%= t('search.filters.removeTag', { label: tag.label }) %>">✕</button>
              </li>
            <% }) %>
          </ul>
        <% } %>
      </div>

      <div class="filter-field">
        <label for="filter-start"><%= t('search.filters.start') %></label>
        <input id="filter-start" name="start" type="date" value="<%= filters.startDate || '' %>" data-filter-field>
      </div>

      <div class="filter-field">
        <label for="filter-end"><%= t('search.filters.end') %></label>
        <input id="filter-end" name="end" type="date" value="<%= filters.endDate || '' %>" data-filter-field>
      </div>

      <div class="filter-field">
        <label for="filter-sort"><%= t('search.filters.sort') %></label>
        <select id="filter-sort" name="sort" data-auto-submit data-filter-field>
          <% sortOptions.forEach(option => { %>
            <option value="<%= option.value %>" <%= option.value === filters.sortKey ? 'selected' : '' %>><%= option.label %></option>
          <% }) %>
        </select>
      </div>
    </div>

    <div class="filter-actions">
      <button type="submit" class="btn primary" data-icon="🔎"><%= t('search.filters.apply') %></button>
      <button type="button" class="btn" data-clear-filters data-reset-url="<%= filters.resetUrl %>"><%= t('search.filters.reset') %></button>
    </div>
  </form>
  <% if (filters.hasActiveFilters) { %>
    <p class="active-filter-hint"><%= t('search.filters.activeHint') %></p>
  <% } %>
</div>

<div class="search-meta">
  <p><%= t('search.meta.results', { count: total, suffix: total > 1 ? 's' : '' }) %></p>
  <% const perPageFieldId = `${pagination.pageParam}-per-page`; %>
  <form class="page-size" method="get">
    <input type="hidden" name="<%= pagination.pageParam %>" value="1">
    <% if (pagination.preservedQuery && pagination.preservedQuery.length) { %>
      <% pagination.preservedQuery.forEach(pair => { %>
        <input type="hidden" name="<%= pair.name %>" value="<%= pair.value %>">
      <% }) %>
    <% } %>
    <label for="<%= perPageFieldId %>"><%= t('search.meta.perPage') %></label>
    <select id="<%= perPageFieldId %>" name="<%= pagination.perPageParam %>" onchange="this.form.submit()">
      <% pagination.perPageOptions.forEach(option => { %>
        <option value="<%= option %>" <%= option === pagination.perPage ? 'selected' : '' %>><%= option %></option>
      <% }) %>
    </select>
  </form>
</div>

<% if (mode !== 'fts') { %>
  <p><em><%= t('search.mode.basic') %> <% if (!ftsAvailable) { %><%= t('search.mode.ftsUnavailable') %><% } else { %><%= t('search.mode.ftsSkipped') %><% } %>.</em></p>
<% } %>

<div class="article-grid">
  <% if (!rows.length) { %>
    <div class="card"><%= t('search.noResults') %></div>
  <% } %>

  <% rows.forEach(p => {
       const tags = (p.tagsCsv || '').split(',').filter(Boolean);
       const showScore = mode === 'fts' && Number.isFinite(p.score);
  %>
    <div class="card">
      <h3><strong><%= p.title %></strong></h3>
      <% if (p.snippet) { %>
        <div class="excerpt">
          <div class="excerpt-body"><%- p.snippet %></div>
        </div>
      <% } else if (p.excerpt) { %>
        <div class="excerpt">
          <div class="excerpt-body"><%- p.excerpt %></div>
        </div>
      <% } %>

      <% if (showScore) { %>
        <div class="meta"><%= t('search.meta.bm25') %> <%= p.score.toFixed(2) %></div>
      <% } %>

      <% if (tags.length) { %>
        <div class="tags-row">
          <% tags.forEach(t => { %>
            <a class="tag" href="/tags/<%= t %>"><%= t %></a>
          <% }) %>
        </div>
      <% } %>

      <div class="actions">
        <a class="btn success" data-icon="📖" href="/wiki/<%= p.slug_id %>"><%= t('common.openArticle') %></a>
        <button class="btn copy" data-icon="🔗"
          onclick="navigator.clipboard.writeText(location.origin + '/wiki/<%= p.slug_id %>')">
          <%= t('common.copyLink') %>
        </button>
      </div>
    </div>
  <% }) %>
</div>

<div class="actions pagination">
  <span class="pagination-status">
    <%- t('common.pageXofY', { page: pagination.page, total: pagination.totalPages }) %>
  </span>
  <div class="pager">
    <% if (pagination.hasPrevious) { %>
      <a class="btn" data-icon="⬅️" href="<%= pagination.previousUrl %>"><%= t('common.prev') %></a>
    <% } else { %>
      <span class="btn" data-icon="⬅️" aria-disabled="true"><%= t('common.prev') %></span>
    <% } %>
    <% if (pagination.hasNext) { %>
      <a class="btn" data-icon="➡️" href="<%= pagination.nextUrl %>"><%= t('common.next') %></a>
    <% } else { %>
      <span class="btn" data-icon="➡️" aria-disabled="true"><%= t('common.next') %></span>
    <% } %>
  </div>
</div>

<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Simple Wiki ¬∑ Documentation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        line-height: 1.6;
      }
      body {
        margin: 0 auto;
        padding: 3rem 1.5rem 4rem;
        max-width: 960px;
        background: radial-gradient(circle at top, #f5f9ff, #ffffff 45%);
      }
      header {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 2.5rem;
        text-align: center;
      }
      h1 {
        font-size: clamp(2rem, 5vw, 3rem);
        margin: 0;
      }
      h2 {
        margin-top: 2.5rem;
        border-bottom: 2px solid #4676d7;
        padding-bottom: 0.4rem;
      }
      code {
        background: rgba(71, 118, 215, 0.12);
        border-radius: 4px;
        padding: 0.15rem 0.35rem;
        font-size: 0.95em;
      }
      pre {
        background: rgba(40, 44, 52, 0.9);
        color: #f8f8f2;
        border-radius: 6px;
        padding: 1rem;
        overflow-x: auto;
      }
      .grid {
        display: grid;
        gap: 1.5rem;
      }
      @media (min-width: 900px) {
        .grid.two {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      .card {
        background: rgba(255, 255, 255, 0.85);
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 12px 34px rgba(40, 74, 120, 0.12);
        backdrop-filter: blur(6px);
      }
      footer {
        margin-top: 3rem;
        font-size: 0.875rem;
        text-align: center;
        color: #4b5563;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Simple Wiki ¬∑ Documentation d√©veloppeur</h1>
      <p>
        Ce document pr√©sente l‚Äôarchitecture de l‚Äôapplication, la structure de la
        base de donn√©es et les points d‚Äôextension principaux pour adapter Simple
        Wiki √† vos besoins.
      </p>
    </header>

    <section>
      <h2>Architecture applicative</h2>
      <div class="grid two">
        <article class="card">
          <h3>Serveur Express</h3>
          <p>
            <code>app.js</code> initialise Express, les middlewares (sessions,
            logs, <code>method-override</code>) et monte les routes
            fonctionnelles. Le moteur de templates utilis√© est EJS avec des
            layouts partag√©s.
          </p>
        </article>
        <article class="card">
          <h3>Syst√®me de sessions</h3>
          <p>
            La configuration des sessions provient de
            <code>utils/config.js</code>. Les valeurs sensibles sont charg√©es via
            des variables d‚Äôenvironnement ou un fichier de secrets pour √©viter
            toute fuite dans le d√©p√¥t Git.
          </p>
        </article>
        <article class="card">
          <h3>Gestion des param√®tres</h3>
          <p>
            Le module <code>utils/settingsService.js</code> centralise la lecture
            et la mise √† jour des param√®tres du wiki. Il offre un cache m√©moire
            √† dur√©e limit√©e pour limiter la charge sur SQLite et expose des
            helpers adapt√©s aux formulaires d‚Äôadministration.
          </p>
        </article>
        <article class="card">
          <h3>Int√©grations externes</h3>
          <p>
            <code>utils/webhook.js</code> exp√©die des notifications Discord
            (canaux ¬´ admin ¬ª et ¬´ feed ¬ª) et journalise chaque √©v√©nement dans la
            table <code>event_logs</code>. Les descriptions longues sont
            tronqu√©es pour respecter les limites de l‚ÄôAPI.
          </p>
        </article>
      </div>
    </section>

    <section>
      <h2>Sch√©ma de la base de donn√©es</h2>
      <p>
        Toutes les donn√©es sont stock√©es dans SQLite. Le script
        <code>db.js</code> cr√©e les tables √† la vol√©e et active les contraintes
        d‚Äôint√©grit√©. Voici les entit√©s principales :
      </p>
      <ul>
        <li><strong>users</strong> : comptes administrateurs et contributeurs.</li>
        <li>
          <strong>pages</strong> : contenu principal du wiki avec
          <code>slug_id</code> unique et historique dans
          <code>page_revisions</code>.
        </li>
        <li>
          <strong>comments</strong> : commentaires publics, mod√©r√©s via un statut
          <code>pending</code>/<code>approved</code>/<code>rejected</code>.
        </li>
        <li>
          <strong>settings</strong> : param√®tres globaux (nom, logo, webhooks,
          pied de page) g√©r√©s par l‚Äôinterface admin.
        </li>
        <li>
          <strong>uploads</strong> : fichiers d√©pos√©s via l‚Äôinterface
          d‚Äôadministration et servis en statique.
        </li>
      </ul>
    </section>

    <section>
      <h2>Flux principaux</h2>
      <div class="grid">
        <article class="card">
          <h3>Cycle de vie d‚Äôune page</h3>
          <ol>
            <li>Cr√©ation via <code>POST /new</code> (admin requis).</li>
            <li>Insertion du contenu et des tags en base.</li>
            <li>Enregistrement d‚Äôune r√©vision et indexation FTS.</li>
            <li>Notification envoy√©e via webhook ¬´ feed ¬ª.</li>
            <li>Consultation publique sur <code>/wiki/:slug</code> avec suivi des vues.</li>
          </ol>
        </article>
        <article class="card">
          <h3>Commentaires publics</h3>
          <ol>
            <li>Saisie avec validation (captcha basique et honeypot).</li>
            <li>Enregistrement avec un token d‚Äô√©dition transmis en session.</li>
            <li>Mod√©ration depuis <code>/admin/comments</code>.</li>
            <li>Mises √† jour journalis√©es et envoy√©es au webhook ¬´ admin ¬ª.</li>
          </ol>
        </article>
      </div>
    </section>

    <section>
      <h2>Points d‚Äôextension</h2>
      <ul>
        <li>
          Ajoutez de nouveaux champs au mod√®le <code>settings</code> en utilisant
          <code>ensureColumn</code> dans <code>db.js</code> puis exposez-les via
          <code>settingsService</code> pour b√©n√©ficier du cache.
        </li>
        <li>
          Pour int√©grer une authentification externe, remplacez les m√©thodes dans
          <code>routes/auth.js</code> en conservant la structure des sessions.
        </li>
        <li>
          Les webhooks peuvent √™tre √©tendus en ajoutant un nouveau canal et en le
          branchant dans <code>utils/webhook.js</code>.
        </li>
      </ul>
    </section>

    <section>
      <h2>Bonnes pratiques</h2>
      <ul>
        <li>Activez HTTPS pour s√©curiser les cookies de session.</li>
        <li>
          Utilisez <code>SESSION_SECRETS</code> pour pr√©parer une rotation des
          secrets sans interruption de service.
        </li>
        <li>
          Ex√©cutez r√©guli√®rement <code>npm run views:aggregate</code> afin de
          garder la table des vues compacte.
        </li>
        <li>
          Surveillez la table <code>event_logs</code> pour alimenter un SIEM ou un
          dashboard interne.
        </li>
      </ul>
    </section>

    <footer>
      &copy; <span id="year"></span> Simple Wiki ¬∑ Fait avec üíô pour la communaut√©.
    </footer>
    <script>
      document.getElementById("year").textContent = new Date().getFullYear();
    </script>
  </body>
</html>
